<script>
  let jenjangBaseCache = '';
  let jenjangPilihanCache = '';
  const LAST_PAGE_KEY = 'lastVisitedPageId';
  let siswaTelahDiImport = false;
  let nilaiTelahDiUpload = false;
  let globalSiswaList = [];
  let isSiswaOrderDirty = false;
  let isMapelTipeDirty = false;
  let globalGridData = {
    siswaList: [],
    mapelList: [],
    nilaiData: {}
  };
  let globalRaporGridData = {
    siswaList: [],
    mapelList: [],
    nilaiData: {}
  };

  let currentProsesToast = null;

  function showToast(message, type = 'proses', duration = 4000) {
    const container = document.getElementById('global-toast-container');
    if (!container) return;

    if (type === 'proses') {
      hideToast();
    }
    
    let iconHtml = '';
    if (type === 'proses') {
      iconHtml = '<div class="spinner-toast"></div>';
      duration = 0; 
    } else if (type === 'sukses') {
      iconHtml = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'gagal') {
      iconHtml = '<i class="fas fa-exclamation-circle"></i>';
      duration = 5000;
    }

    const toast = document.createElement('div');
    toast.className = `global-toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-icon">${iconHtml}</div>
      <div class="toast-message">${message}</div>
    `;
    
    toast.isDismissing = false; 

    container.appendChild(toast);
    
    requestAnimationFrame(() => {
      toast.classList.add('show');
    });

    if (type === 'proses') {
      currentProsesToast = toast;
    }

    let autoHideTimerId = null;

    const removeToast = () => {
      if (toast.isDismissing) return;
      toast.isDismissing = true;

      if (autoHideTimerId) {
        clearTimeout(autoHideTimerId);
        autoHideTimerId = null;
      }
      
      if (type === 'proses' && toast === currentProsesToast) {
          currentProsesToast = null;
      }
      
      toast.classList.add('hide');
      toast.addEventListener('animationend', () => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      });
    };
    
    if (duration > 0) {
      autoHideTimerId = setTimeout(removeToast, duration);
    }
    
    let touchStartX = 0;
    let touchCurrentX = 0;
    let isSwiping = false;
    const swipeThreshold = 50; 

    toast.addEventListener('touchstart', (e) => {
      if (toast.isDismissing) return; 
      if (autoHideTimerId) {
          clearTimeout(autoHideTimerId);
          autoHideTimerId = null;
      }
      touchStartX = e.touches[0].clientX;
      touchCurrentX = touchStartX;
      isSwiping = true;
      toast.style.transition = 'none'; 
    }, { passive: true });

    toast.addEventListener('touchmove', (e) => {
      if (!isSwiping || toast.isDismissing) return; 
      touchCurrentX = e.touches[0].clientX;
      const diffX = touchCurrentX - touchStartX;
      toast.style.transform = `translateX(${diffX}px)`;
    }, { passive: true });

    toast.addEventListener('touchend', (e) => {
      if (!isSwiping) return;
      isSwiping = false;

      if (toast.isDismissing) return; 
      
      const diffX = touchCurrentX - touchStartX;
      
      if (Math.abs(diffX) > swipeThreshold) {
        toast.isDismissing = true; 
        
        toast.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
        toast.style.transform = `translateX(${diffX > 0 ? '100%' : '-100%'})`;
        toast.style.opacity = '0';
        
        setTimeout(() => {
          if (type === 'proses' && toast === currentProsesToast) {
              currentProsesToast = null;
          }
          if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
          }
        }, 300); 

      } else {
        toast.style.transition = 'transform 0.3s cubic-bezier(0.21, 1.02, 0.73, 1)';
        toast.style.transform = 'translateX(0)';
        
        if (duration > 0) {
          autoHideTimerId = setTimeout(removeToast, duration);
        }
      }
    });
  }

  function hideToast() {
    if (currentProsesToast) {
      if (currentProsesToast.isDismissing) {
          return; 
      }
      
      currentProsesToast.isDismissing = true; 
      currentProsesToast.classList.add('hide');
      
      currentProsesToast.addEventListener('animationend', () => {
        if (currentProsesToast && currentProsesToast.parentNode) {
          currentProsesToast.parentNode.removeChild(currentProsesToast);
        }
        currentProsesToast = null;
      });
    }
  }

  function setLoading(isLoading, message = 'Memuat data...', blockUI = true) {
    document.getElementById('loader').style.display = 'none';
    
    const uiBlocker = document.getElementById('global-ui-blocker');

    if (isLoading) {
      showToast(message, 'proses');
      
      if (uiBlocker && blockUI) {
        uiBlocker.style.display = 'block';
      }
    } else {
      hideToast();
      if (uiBlocker) {
        uiBlocker.style.display = 'none';
      }
    }
  }

  function toProperCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
  }

  function formatNamaSiswa(namaLengkap) {
    if (!namaLengkap) return '';
    const parts = namaLengkap.split(' ');
    if (parts.length >= 3) {
      const barisSatu = parts.slice(0, 2).join(' ');
      const barisDua = parts.slice(2).join(' ');
      return `<span style="white-space: nowrap;">${barisSatu}</span><br>${barisDua}`;
    }
    return namaLengkap;
  }

  function showMessage(elementId, message, isError) {
    if (typeof isError === 'undefined' || isError === null) {
      isError = true;
    }

    if (isError) {
      showToast(message, 'gagal');
    } else {
      showToast(message, 'sukses');
    }
  }

  function hideMessage(elementId) {
  }

  function tampilHalaman(idHalaman) {
    const allPages = [
      'auth-container', 'halaman-utama', 'halaman-mapel',
      'halaman-data-sekolah', 'halaman-bobot', 'halaman-kelas', 'halaman-siswa',
      'halaman-input-ujian', 'halaman-input-nilai-detail',
      'halaman-rekap-nilai', 'halaman-semester',
      'halaman-input-rapor', 'halaman-input-rapor-detail', 'halaman-rekap-rapor'
    ];
    const authSubPages = ['halaman-login', 'halaman-registrasi'];

    allPages.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    hideMessage('login-error');
    hideMessage('reg-message');
    hideMessage('data-sekolah-message');
    hideMessage('bobot-message');
    hideMessage('kelas-message');
    hideMessage('siswa-message');
    hideMessage('input-nilai-message');
    hideMessage('mapel-message');
    hideMessage('template-message');
    hideMessage('template-nilai-message');
    hideMessage('rekap-nilai-message');
    hideMessage('semester-message');
    hideMessage('input-rapor-message');
    hideMessage('rekap-rapor-message');

    const targetElement = document.getElementById(idHalaman);
    if (targetElement) {
        if (authSubPages.includes(idHalaman)) {
            document.getElementById('auth-container').style.display = 'block';
            authSubPages.forEach(subId => {
                const subEl = document.getElementById(subId);
                if (subEl) subEl.style.display = 'none';
            });
            targetElement.style.display = 'block';
            localStorage.removeItem(LAST_PAGE_KEY);
        } else {
            targetElement.style.display = 'block';
            localStorage.setItem(LAST_PAGE_KEY, idHalaman);
        }
    } else {
        console.warn("Halaman tidak ditemukan:", idHalaman, ". Menampilkan dashboard.");
        document.getElementById('halaman-utama').style.display = 'block';
        localStorage.setItem(LAST_PAGE_KEY, 'halaman-utama');
    }
  }

  function setFormDisabled(formId, isDisabled) {
    const form = document.getElementById(formId);
    if (!form) return;

    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (input.id !== 'data-nama-sekolah') {
        input.disabled = isDisabled;
      }
    });

    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = isDisabled;
    }
  }

  function showConfirmationModal(title, message, onConfirmCallback, okButtonType = 'danger') {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-body').innerHTML = message;

    const okButton = document.getElementById('btn-confirm-ok');

    if (okButtonType === 'danger') {
      okButton.style.backgroundColor = 'var(--danger-color)';
    } else {
      okButton.style.backgroundColor = 'var(--primary-color)';
    }

    modal.onConfirm = onConfirmCallback;

    modal.classList.add('show');
  }

  function hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.classList.remove('show');
    modal.onConfirm = null;
  }

  function showInfoModal(title, message, isError, onOkCallback) {
    showToast(message, isError ? 'gagal' : 'sukses');

    if (!isError && typeof onOkCallback === 'function') {
      setTimeout(onOkCallback, 500); 
    }
  }

  function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    modal.classList.remove('show');

    if (typeof modal.onOk === 'function') {
      modal.onOk();
    }
    modal.onOk = null;
  }

  let dynamicTooltipTimer = null;

  function hideDynamicTooltip() {
    if (dynamicTooltipTimer) {
      clearTimeout(dynamicTooltipTimer);
      dynamicTooltipTimer = null;
    }
    const existingTooltip = document.getElementById('dynamic-tooltip'); 
    if (existingTooltip) {
      existingTooltip.classList.remove('show');
      setTimeout(() => {
         const currentTooltip = document.getElementById('dynamic-tooltip');
         if(currentTooltip) {
           currentTooltip.remove();
         }
      }, 200);
    }
  }

  function showDynamicTooltip(targetElement, textToShow) {
    hideDynamicTooltip();

    const tooltip = document.createElement('div');
    tooltip.id = 'dynamic-tooltip';
    tooltip.className = 'dynamic-tooltip';
    tooltip.innerText = textToShow;

    tooltip.addEventListener('click', (e) => {
      e.stopPropagation(); 
      hideDynamicTooltip();
    });

    document.body.appendChild(tooltip);

    const rect = targetElement.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;

    let top = rect.top + scrollY - tooltipRect.height - 8;
    let left = rect.left + scrollX + (rect.width / 2) - (tooltipRect.width / 2);

    if (left < scrollX + 8) left = scrollX + 8;
    if (left + tooltipRect.width > scrollX + window.innerWidth - 8) {
      left = scrollX + window.innerWidth - tooltipRect.width - 8;
    }
    
    if (top < scrollY + 8) {
      top = rect.bottom + scrollY + 8;
      tooltip.classList.add('bottom');
    } else {
      tooltip.classList.add('top');
    }

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;

    requestAnimationFrame(() => {
      tooltip.classList.add('show');
    });

    dynamicTooltipTimer = setTimeout(() => {
      hideDynamicTooltip();
    }, 3000); 
  }

  function bukaHalamanTersimpan(pageId) {
    switch (pageId) {
        case 'halaman-utama':
            tampilHalaman('halaman-utama');
            break;
        case 'halaman-mapel':
            bukaHalamanMapel();
            break;
        case 'halaman-data-sekolah':
            bukaHalamanDataSekolah();
            break;
        case 'halaman-bobot':
            bukaHalamanBobot();
            break;
        case 'halaman-kelas':
            bukaHalamanKelas();
            break;
        case 'halaman-siswa':
            bukaHalamanSiswa();
            break;
        case 'halaman-input-ujian':
            bukaHalamanInputUjian();
            break;
        case 'halaman-input-nilai-detail':
            bukaHalamanInputUjian(); 
            break;
        case 'halaman-rekap-nilai':
            bukaHalamanInputUjian();
            break;
        case 'halaman-semester':
            bukaHalamanSemester();
            break;
        case 'halaman-input-rapor':
            bukaHalamanInputRapor();
            break;
        case 'halaman-input-rapor-detail':
            bukaHalamanInputRapor();
            break;
        case 'halaman-rekap-rapor':
            bukaHalamanInputRapor();
            break;
        default:
            console.warn("ID halaman tersimpan tidak valid:", pageId, ". Menampilkan dashboard.");
            tampilHalaman('halaman-utama');
    }
  }

  function setMapelTipeDirty(isDirty) {
    isMapelTipeDirty = isDirty;
    const btnSimpan = document.getElementById('btn-simpan-tipe-ujian');
    if (btnSimpan) {
      btnSimpan.disabled = !isDirty;
    }
  }

  document.addEventListener('DOMContentLoaded', (event) => {

    document.getElementById('btn-login').addEventListener('click', () => {
      setLoading(true, 'Login...', false);
      hideMessage('login-error');
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      google.script.run
        .withSuccessHandler(hasilLogin)
        .withFailureHandler(onGagal)
        .prosesLogin(email, pass);
    });

    document.getElementById('btn-registrasi').addEventListener('click', () => {
      setLoading(true, 'Mendaftar...');
      hideMessage('reg-message');

      const namaSekolah = document.getElementById('reg-nama-sekolah').value.toUpperCase();
      const jenjang = document.getElementById('reg-jenjang').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      if (!namaSekolah || !jenjang || !email || !password) {
        setLoading(false);
        showMessage('reg-message', "Semua field wajib diisi.", true);
        return;
      }

      google.script.run
        .withSuccessHandler(hasilRegistrasi)
        .withFailureHandler(onGagal)
        .prosesRegistrasi(namaSekolah, jenjang, email, password);
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
      setLoading(true, 'Logout...');
      google.script.run
        .withSuccessHandler(onLogout)
        .withFailureHandler(onGagal)
        .prosesLogout();
    });

    document.getElementById('link-ke-registrasi').addEventListener('click', (e) => {
      e.preventDefault();
      tampilHalaman('halaman-registrasi');
    });

    document.getElementById('link-ke-login').addEventListener('click', (e) => {
      e.preventDefault();
      tampilHalaman('halaman-login');
    });
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      document.getElementById('btn-login').click();
    });

    document.getElementById('reg-form').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    document.getElementById('toggle-login-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggle-reg-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('btn-buka-data-sekolah').addEventListener('click', () => {
      bukaHalamanDataSekolah();
    });
    document.getElementById('btn-kembali-ke-dashboard-2').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('btn-buka-bobot').addEventListener('click', () => {
      bukaHalamanBobot();
    });
    document.getElementById('btn-kembali-ke-dashboard-3').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('btn-buka-kelas').addEventListener('click', () => {
      bukaHalamanKelas();
    });
    document.getElementById('btn-kembali-ke-dashboard-4').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('btn-buka-siswa').addEventListener('click', () => {
      bukaHalamanSiswa();
    });
    document.getElementById('btn-kembali-ke-dashboard-5').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('btn-buka-input-ujian').addEventListener('click', () => {
      bukaHalamanInputUjian();
    });
    document.getElementById('btn-kembali-ke-dashboard-6').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });
    document.getElementById('btn-kembali-ke-input-ujian').addEventListener('click', () => {
      bukaHalamanInputUjian();
    });
    document.getElementById('btn-kembali-ke-input-ujian-2').addEventListener('click', () => {
      bukaHalamanInputUjian();
    });
    document.getElementById('btn-buka-upload-nilai').addEventListener('click', bukaModalUploadNilai);

    document.getElementById('btn-buka-input-um').addEventListener('click', () => {
      bukaHalamanInputNilaiDetail('UM'); 
    });
    document.getElementById('btn-buka-input-praktek').addEventListener('click', () => {
      bukaHalamanInputNilaiDetail('Praktek'); 
    });
    document.getElementById('btn-buka-rekap-nilai').addEventListener('click', () => {
      bukaHalamanRekapNilai();
    });
    document.getElementById('btn-buka-semester').addEventListener('click', () => {
      bukaHalamanSemester();
    });
    document.getElementById('btn-kembali-ke-dashboard-7').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });
    document.getElementById('form-semester').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanSemester();
    });
    document.getElementById('btn-simpan-input-nilai').addEventListener('click', simpanInputNilai);
    
    document.getElementById('btn-bersihkan-input-nilai').addEventListener('click', konfirmasiBersihkanNilai);

    document.getElementById('halaman-input-nilai-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        
        let input = e.target;
        let value = input.value;
        
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const siswaId = e.target.dataset.siswaId;
        const table = e.target.closest('.input-nilai-table');
        
        const mapelCount = table.querySelectorAll('th.col-mapel').length;
        
        updateRowTotals(siswaId, mapelCount);
      }
    });

    document.getElementById('halaman-rekap-nilai').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-input-nilai-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-nilai-filter-kelas').addEventListener('change', renderNilaiGridTable);
    document.getElementById('rekap-nilai-filter-kelas').addEventListener('change', renderRekapNilaiTable);

    document.getElementById('btn-buka-mapel').addEventListener('click', () => {
      bukaHalamanMapel();
    });
     document.getElementById('btn-kembali-ke-dashboard').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('form-data-sekolah').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanDataSekolah();
    });
    document.getElementById('data-jenjang-pilihan').addEventListener('change', updateTampilanNSM);

    document.getElementById('form-bobot').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanBobot();
    });
    document.getElementById('bobot-rapor').addEventListener('input', () => { sinkronkanBobot('rapor'); });
    document.getElementById('bobot-ujian').addEventListener('input', () => { sinkronkanBobot('ujian'); });

    document.getElementById('form-kelas').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanKelas();
    });
    document.getElementById('kelas-list-container').addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('btn-add-kelas')) {
        const list = getCurrentKelasList();
        list.push('');
        renderKelasList(list);
        document.querySelector('#kelas-list-container .kelas-input-row:last-child input').focus();
      }
      else if (target.classList.contains('btn-remove-kelas')) {
        const rowToRemove = target.parentElement;
        const list = getCurrentKelasList();
        const allRows = Array.from(document.querySelectorAll('#kelas-list-container .kelas-input-row'));
        const indexToRemove = allRows.indexOf(rowToRemove);
        if (indexToRemove > -1) { list.splice(indexToRemove, 1); }
        renderKelasList(list);
      }
    });

     document.getElementById('btn-import-siswa').addEventListener('click', bukaModalImportSiswa);
     document.getElementById('btn-tambah-siswa-baru').addEventListener('click', () => { showModalSiswa('add', {}); });
     document.getElementById('btn-hapus-semua-siswa').addEventListener('click', hapusSemuaSiswa);
     document.getElementById('btn-simpan-siswa').addEventListener('click', simpanSiswa);
     document.getElementById('btn-tutup-modal-siswa').addEventListener('click', tutupModalSiswa);
     document.getElementById('btn-batal-modal-siswa').addEventListener('click', tutupModalSiswa);
     document.getElementById('siswa-table-container').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-siswa')) {
          const dataset = target.dataset;
          const siswaData = { id: dataset.id, nama: dataset.nama, nisn: dataset.nisn, nisLokal: dataset.nisLokal, jk: dataset.jk, tempatLahir: dataset.tempatLahir, tglLahir: dataset.tglLahir, kelas: dataset.kelas };
          showModalSiswa('edit', siswaData);
      
      } else if (target.classList.contains('btn-delete-siswa')) {
          const id = target.getAttribute('data-id');
          const nama = target.getAttribute('data-nama');
          hapusSiswa(id, nama);
      
      } 
      else if (target.classList.contains('btn-move-up') || target.classList.contains('btn-move-down')) {
          
          const siswaID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up') ? 'up' : 'down';

          const targetSiswa = globalSiswaList.find(s => s.id === siswaID);
          if (!targetSiswa) return;

          const classmates = globalSiswaList
                              .filter(s => s.kelas === targetSiswa.kelas)
                              .sort((a,b) => a.urutan - b.urutan);
          
          const targetIndexInClass = classmates.findIndex(s => s.id === siswaID);

          let swapSiswa = null;
          if (direction === 'up' && targetIndexInClass > 0) {
            swapSiswa = classmates[targetIndexInClass - 1];
          } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
            swapSiswa = classmates[targetIndexInClass + 1];
          }

          if (swapSiswa) {
            const tempUrutan = targetSiswa.urutan;
            targetSiswa.urutan = swapSiswa.urutan;
            swapSiswa.urutan = tempUrutan;
            
            setSiswaOrderDirty(true);
            
            applySiswaFiltersAndRender();
          }
      }
    });

    document.getElementById('siswa-filter-kelas').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('siswa-sort-by').addEventListener('change', applySiswaFiltersAndRender);

    document.getElementById('btn-simpan-urutan-siswa').addEventListener('click', () => {
      setLoading(true, 'Menyimpan urutan...');
      hideMessage('siswa-message');
      
      const urutanData = globalSiswaList.map(siswa => {
        return { id: siswa.id, urutan: siswa.urutan };
      });
      
      google.script.run
        .withSuccessHandler(onSiswaUrutanSaved)
        .withFailureHandler(onGagal)
        .saveSiswaUrutanBatch(urutanData);
    });

    document.getElementById('btn-ambil-default').addEventListener('click', () => {
        const title = "Ambil Mapel Default";
        const message = "Ini akan mengambil mapel default dari master dan menambahkan yang hilang. Lanjutkan?";
        const callback = function() { setLoading(true, 'Menyinkronkan mapel...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).syncDefaultMapel(); };
        showConfirmationModal(title, message, callback, 'primary');
    });
    document.getElementById('btn-hapus-semua').addEventListener('click', () => {
        const title = "PERINGATAN!";
        const message = "Anda yakin ingin menghapus <strong>SEMUA</strong> mata pelajaran? Tindakan ini tidak bisa dibatalkan.";
        const callback = function() { setLoading(true, 'Menghapus semua mapel...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).deleteAllMapel(); };
        showConfirmationModal(title, message, callback, 'danger');
    });
    document.getElementById('btn-tambah-mapel-baru').addEventListener('click', () => { showModalMapel('add'); });
    document.getElementById('btn-tutup-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-batal-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-simpan-mapel').addEventListener('click', simpanMapel);
    document.getElementById('btn-simpan-tipe-ujian').addEventListener('click', simpanTipeUjian);

    document.getElementById('mapel-table-container').addEventListener('change', (e) => {
        if (e.target.classList.contains('mapel-tipe-cek')) {
          setMapelTipeDirty(true);
        }
    });

    document.getElementById('mapel-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        
        if (target.classList.contains('btn-edit')) {
            const id = target.getAttribute('data-id');
            const nama = target.getAttribute('data-nama');
            showModalMapel('edit', id, nama);
        } else if (target.classList.contains('btn-delete')) {
            const id = target.getAttribute('data-id');
            hapusMapel(id);
        }
    });

    document.getElementById('btn-confirm-cancel').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-close').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-ok').addEventListener('click', () => {
        const modal = document.getElementById('confirmation-modal');
        if (typeof modal.onConfirm === 'function') { modal.onConfirm(); }
        hideConfirmationModal();
    });
    document.getElementById('btn-info-close').addEventListener('click', hideInfoModal);
    document.getElementById('btn-info-ok').addEventListener('click', hideInfoModal);

    document.getElementById('btn-tutup-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-batal-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-download-template-siswa').addEventListener('click', downloadTemplateSiswa);
    document.getElementById('btn-proses-import-siswa').addEventListener('click', prosesImportFileSiswa);

    const fileUploadZone = document.getElementById('file-upload-zone');
    const fileUploadInput = document.getElementById('file-upload-siswa');
    const fileUploadText = document.getElementById('file-upload-text');
    const btnProsesImport = document.getElementById('btn-proses-import-siswa');

    fileUploadInput.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadText.innerText = `File dipilih: ${fileName}`;
                fileUploadText.classList.add('file-chosen');
                btnProsesImport.disabled = false;
                hideMessage('template-message');
            } else {
                fileUploadText.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadText.classList.remove('file-chosen');
                btnProsesImport.disabled = true;
            }
        } else {
            fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadText.classList.remove('file-chosen');
            btnProsesImport.disabled = true;
        }
    });

    fileUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZone.classList.add('drag-over');
    });

    fileUploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
    });

    fileUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInput.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInput.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-tutup-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-batal-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-download-template-nilai').addEventListener('click', downloadTemplateNilai);
    document.getElementById('btn-proses-upload-nilai').addEventListener('click', prosesUploadFileNilai);

    const fileUploadZoneNilai = document.getElementById('file-upload-zone-nilai');
    const fileUploadInputNilai = document.getElementById('file-upload-nilai');
    const fileUploadTextNilai = document.getElementById('file-upload-text-nilai');
    const btnProsesUploadNilai = document.getElementById('btn-proses-upload-nilai');

    fileUploadInputNilai.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextNilai.innerText = `File dipilih: ${fileName}`;
                fileUploadTextNilai.classList.add('file-chosen');
                btnProsesUploadNilai.disabled = false;
                hideMessage('template-nilai-message');
            } else {
                fileUploadTextNilai.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextNilai.classList.remove('file-chosen');
                btnProsesUploadNilai.disabled = true;
            }
        } else {
            fileUploadTextNilai.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextNilai.classList.remove('file-chosen');
            btnProsesUploadNilai.disabled = true;
        }
    });

    fileUploadZoneNilai.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.add('drag-over');
    });

    fileUploadZoneNilai.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
    });

    fileUploadZoneNilai.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputNilai.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputNilai.dispatchEvent(changeEvent);
        }
    });

    window.addEventListener('click', (e) => {
      if (!e.target.closest('#dynamic-tooltip') && !e.target.closest('.clickable-nama-siswa') && !e.target.closest('.clickable-mapel-header')) {
        hideDynamicTooltip();
      }
    });

    window.addEventListener('scroll', hideDynamicTooltip, true);

    document.getElementById('btn-buka-input-rapor').addEventListener('click', () => {
      bukaHalamanInputRapor();
    });
    document.getElementById('btn-kembali-ke-dashboard-8').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });
    document.getElementById('btn-buka-rekap-rapor').addEventListener('click', () => {
      bukaHalamanRekapRapor();
    });
    document.getElementById('btn-kembali-ke-input-rapor').addEventListener('click', () => {
      bukaHalamanInputRapor();
    });
    document.getElementById('btn-kembali-ke-input-rapor-2').addEventListener('click', () => {
      bukaHalamanInputRapor();
    });

    document.getElementById('btn-simpan-input-rapor').addEventListener('click', simpanInputNilaiRapor);
    document.getElementById('btn-bersihkan-input-rapor').addEventListener('click', konfirmasiBersihkanNilaiRapor);

    document.getElementById('halaman-input-rapor-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        
        let input = e.target;
        let value = input.value;
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const siswaId = e.target.dataset.siswaId;
        const table = e.target.closest('.input-nilai-table');
        const mapelCount = table.querySelectorAll('th.col-mapel').length;
        updateRowTotalsRapor(siswaId, mapelCount);
      }
    });

    document.getElementById('halaman-input-rapor-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-rekap-rapor').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-rapor-filter-kelas').addEventListener('change', renderNilaiRaporGridTable);
    document.getElementById('rekap-rapor-filter-kelas').addEventListener('change', renderRekapRaporTable);

    const token = localStorage.getItem('sessionToken');
    const lastPageId = localStorage.getItem(LAST_PAGE_KEY);

    if (token) {
      if (lastPageId) {
        bukaHalamanTersimpan(lastPageId);
      } else {
        tampilHalaman('halaman-utama');
      }
      
      google.script.run
        .withSuccessHandler(onTokenCheck) 
        .withFailureHandler(onTokenCheck) 
        .checkToken(token);
        
    } else {
      tampilHalaman('halaman-login');
    }
  });

  function onTokenCheck(response) {
    if (response.status === "sukses") {
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan;
      
    } else {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY);
      tampilHalaman('halaman-login');
      
      if(response.message) {
        showMessage('login-error', response.message, true);
      }
    }
  }

  function hasilLogin(response) {
    setLoading(false);
    if (response.status === "sukses") {
      localStorage.setItem('sessionToken', response.token);
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan;

      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      tampilHalaman('halaman-utama');
    } else {
      showMessage('login-error', response.message, true);
    }
  }

  function hasilRegistrasi(response) {
    setLoading(false);
    if (response.status === "sukses") {
      showMessage('reg-message', response.message, false);

      document.getElementById('reg-nama-sekolah').value = "";
      document.getElementById('reg-jenjang').value = "";
      document.getElementById('reg-email').value = "";
      document.getElementById('reg-password').value = "";

      setTimeout(() => {
        tampilHalaman('halaman-login');
      }, 2500);
    } else {
      showMessage('reg-message', response.message, true);
    }
  }

  function onLogout(response) {
    setLoading(false);
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);

    if (response.status === "sukses") {
      tampilHalaman('halaman-login');
    } else {
      showInfoModal("Gagal Logout", response.message, true);
    }
  }

  function onGagal(error) {
    setLoading(false);
    const errorMsg = error.message;

    if (errorMsg.includes("Sesi") || errorMsg.includes("Token")) {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY);
      tampilHalaman('halaman-login');
      showMessage('login-error', errorMsg, true);
    }
    else if (document.getElementById('halaman-login').style.display !== 'none') {
      showMessage('login-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-registrasi').style.display !== 'none') {
      showMessage('reg-message', 'Error: ' + errorMsg, true);
    
    } else if (document.getElementById('mapel-modal').classList.contains('show')) {
      showMessage('modal-mapel-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('siswa-modal').classList.contains('show')) {
      showMessage('modal-siswa-error', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('import-siswa-modal').classList.contains('show')) {
      showMessage('template-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('upload-nilai-modal').classList.contains('show')) {
      showMessage('template-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-data-sekolah').style.display !== 'none') {
      setFormDisabled('form-data-sekolah', false);
      showMessage('data-sekolah-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-bobot').style.display !== 'none') {
      setFormDisabled('form-bobot', false);
      showMessage('bobot-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-kelas').style.display !== 'none') {
      setFormDisabled('form-kelas', false);
      showMessage('kelas-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-siswa').style.display !== 'none') {
      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;
      showMessage('siswa-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-mapel').style.display !== 'none') {
      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;
      showMessage('mapel-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-nilai-detail').style.display !== 'none') {
      showMessage('input-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-nilai').style.display !== 'none') {
      showMessage('rekap-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-rapor-detail').style.display !== 'none') {
      showMessage('input-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-rapor').style.display !== 'none') {
      showMessage('rekap-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-semester').style.display !== 'none') {
      setFormDisabled('form-semester', false);
      showMessage('semester-message', 'Error: ' + errorMsg, true);
    }
    else {
      showInfoModal('Terjadi Error', errorMsg, true);
    }
  }

  function bukaHalamanMapel() {
    tampilHalaman('halaman-mapel');
    setLoading(true, 'Memuat data mapel...', false); 
    setMapelTipeDirty(false);
    document.getElementById('mapel-table-container').innerHTML = "<p>Memuat data mapel...</p>";

    document.getElementById('btn-tambah-mapel-baru').disabled = true;
    document.getElementById('btn-ambil-default').disabled = true;
    document.getElementById('btn-hapus-semua').disabled = true;
    document.getElementById('btn-simpan-tipe-ujian').disabled = true;

    google.script.run
      .withSuccessHandler(onMapelLoaded)
      .withFailureHandler(onGagal)
      .getMapel();
  }

  function onMapelLoaded(response) {
      setLoading(false);

      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;

      const container = document.getElementById('mapel-table-container');

      if (response.status === "sukses") {
        const jenjangPilihan = jenjangPilihanCache;
        const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';

        let html = '<table class="mapel-table">';
        html += `<tr><th>Kode Mapel</th><th>Nama Mapel</th><th class="col-cek">${labelUjian}</th><th class="col-cek col-up">UP</th><th>Aksi</th></tr>`;

        if (response.mapel.length === 0) {
          html += '<tr><td colspan="5" style="text-align: center;">Belum ada data mapel.</td></tr>';
        }

        response.mapel.forEach(mapel => {
          const isUS = mapel.isUS || false;
          const isUP = mapel.isUP || false;
          
          html += `
            <tr>
              <td>${mapel.id}</td>
              <td>${mapel.nama}</td>
              <td class="col-cek">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="us" ${isUS ? 'checked' : ''}>
              </td>
              <td class="col-cek col-up">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="up" ${isUP ? 'checked' : ''}>
              </td>
              <td>
                <button class="btn-aksi btn-edit" data-id="${mapel.id}" data-nama="${mapel.nama}"><i class="fas fa-pencil-alt"></i>Edit</button>
                <button class="btn-aksi btn-delete" data-id="${mapel.id}"><i class="fas fa-trash-alt"></i>Hapus</button>
              </td>
            </tr>
          `;
        });

        html += '</table>';
        container.innerHTML = html;
      } else {
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat mapel: ${response.message}</p>`;
      }
  }

  function showModalMapel(mode, id = '', nama = '') {
      document.getElementById('modal-mapel-mode').value = mode;
      hideMessage('modal-mapel-error');

      const idInput = document.getElementById('modal-mapel-id');

      if (mode === 'add') {
        document.getElementById('modal-title').innerText = "Tambah Mapel Baru";
        idInput.value = "";
        idInput.readOnly = false;
        document.getElementById('modal-mapel-nama').value = "";
      }
      else if (mode === 'edit') {
        document.getElementById('modal-title').innerText = "Edit Mapel";
        idInput.value = id;
        idInput.readOnly = true;
        document.getElementById('modal-mapel-nama').value = nama;
      }

      document.getElementById('mapel-modal').classList.add('show');
  }

  function tutupModalMapel() {
      document.getElementById('mapel-modal').classList.remove('show');
  }

  function simpanMapel() {
      setLoading(true, 'Menyimpan mapel...');
      hideMessage('modal-mapel-error');

      const mode = document.getElementById('modal-mapel-mode').value;
      const id = document.getElementById('modal-mapel-id').value;
      const nama = document.getElementById('modal-mapel-nama').value;

      if (mode === 'add') {
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .createMapel(id, nama);
      } else {
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .updateMapel(id, nama);
      }
  }

  function hapusMapel(id) {
      const title = "Konfirmasi Hapus";
      const message = `Yakin ingin menghapus mapel dengan ID: <strong>${id}</strong>?<br><br><strong>PERINGATAN:</strong> Menghapus mapel yang sudah memiliki nilai dapat merusak data.`;

      const callback = function() {
        setLoading(true, 'Menghapus mapel...');
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .deleteMapel(id);
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function onTableRefreshed(response) {
      setLoading(false);

      if (response.status === "sukses") {
        if (response.message) {
          showInfoModal("Sukses", response.message, false, bukaHalamanMapel);
        } else {
          bukaHalamanMapel();
        }
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function onMapelSaved(response) {
      setLoading(false);

      if (response.status === "sukses") {
        tutupModalMapel();
        bukaHalamanMapel();
      } else {
        showMessage('modal-mapel-error', response.message, true);
      }
  }

  function simpanTipeUjian() {
      setLoading(true, 'Menyimpan tipe ujian...');
      hideMessage('mapel-message');
      
      const allCheckboxes = document.querySelectorAll('#mapel-table-container .mapel-tipe-cek');
      const dataMap = new Map();

      allCheckboxes.forEach(checkbox => {
          const id = checkbox.dataset.id;
          const tipe = checkbox.dataset.tipe;
          const isChecked = checkbox.checked;

          if (!dataMap.has(id)) {
              dataMap.set(id, { id: id, isUS: false, isUP: false });
          }

          const mapelData = dataMap.get(id);
          if (tipe === 'us') {
              mapelData.isUS = isChecked;
          } else if (tipe === 'up') {
              mapelData.isUP = isChecked;
          }
      });

      const dataToSave = Array.from(dataMap.values());
      
      google.script.run
        .withSuccessHandler(onMapelTipeUjianSaved)
        .withFailureHandler(onGagal)
        .saveMapelTipeUjianBatch(dataToSave);
  }
  
  function onMapelTipeUjianSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setMapelTipeDirty(false);
      showMessage('mapel-message', 'Tipe ujian berhasil disimpan!', false);
    } else {
      showMessage('mapel-message', response.message, true);
    }
  }

  function bukaHalamanDataSekolah() {
    tampilHalaman('halaman-data-sekolah');
    setLoading(true, 'Memuat data sekolah...', false);
    hideMessage('data-sekolah-message');
    document.getElementById('form-data-sekolah').reset();
    setFormDisabled('form-data-sekolah', true);

    google.script.run
      .withSuccessHandler(onDataSekolahLoaded)
      .withFailureHandler(onGagal)
      .getSchoolData();
  }

  function onDataSekolahLoaded(response) {
      setLoading(false);
      setFormDisabled('form-data-sekolah', false);

      if (response.status !== 'sukses') {
        showMessage('data-sekolah-message', response.message, true);
        return;
      }

      const data = response.data;
      jenjangBaseCache = data.jenjangBase;
      jenjangPilihanCache = data.jenjangPilihan;
      populateSelectJenjang(data.jenjangBase, data.jenjangPilihan);

      document.getElementById('data-nama-sekolah').value = data.namaSekolah;
      document.getElementById('data-npsn').value = data.npsn || '';
      document.getElementById('data-nsm').value = data.nsm || '';
      document.getElementById('data-alamat').value = data.alamat || '';
      document.getElementById('data-provinsi').value = data.provinsi || '';
      document.getElementById('data-kabkot').value = data.kabKot || '';
      document.getElementById('data-pilihan-kabkot').value = data.pilihanKabKot || 'Kabupaten';
      document.getElementById('data-kecamatan').value = data.kecamatan || '';
      document.getElementById('data-keldes').value = data.kelDes || '';
      document.getElementById('data-pilihan-keldes').value = data.pilihanKelDes || 'Kelurahan';
      document.getElementById('data-kodepos').value = data.kodePos || '';
      document.getElementById('data-telepon').value = data.telepon || '';
      document.getElementById('data-email').value = data.email || '';
      document.getElementById('data-website').value = data.website || '';
      document.getElementById('data-kepsek').value = data.namaKepsek || '';
      document.getElementById('data-nip-kepsek').value = data.nipKepsek || '';

      updateTampilanNSM();
  }

  function populateSelectJenjang(jenjangBase, selectedValue) {
      const select = document.getElementById('data-jenjang-pilihan');
      select.innerHTML = '';

      let options = [];
      if (jenjangBase === 'SD/MI') {
        options = ['SD', 'MI'];
      } else if (jenjangBase === 'SMP/MTS') {
        options = ['SMP', 'MTS'];
      } else if (jenjangBase === 'SMA/MA') {
        options = ['SMA', 'MA'];
      } else {
        options = [jenjangBase];
      }

      select.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });

      if (selectedValue) {
        select.value = selectedValue;
      } else if (options.length > 1) {
        select.value = options[1];
      }
  }

  function updateTampilanNSM() {
      const jenjangPilihan = document.getElementById('data-jenjang-pilihan').value;
      const grupNSM = document.getElementById('grup-nsm');
      const labelNSM = grupNSM.querySelector('label');

      if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
        labelNSM.innerText = 'NSM (Wajib)';
      } else {
        labelNSM.innerText = 'NSM (Opsional)';
      }
  }

  function simpanDataSekolah() {
      setLoading(true, 'Menyimpan data sekolah...');
      hideMessage('data-sekolah-message');

      const dataToSave = {
        jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
        npsn: document.getElementById('data-npsn').value.trim(),
        nsm: document.getElementById('data-nsm').value.trim(),
        alamat: document.getElementById('data-alamat').value.trim(),
        provinsi: document.getElementById('data-provinsi').value.trim(),
        kabKot: document.getElementById('data-kabkot').value.trim(),
        pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
        kecamatan: document.getElementById('data-kecamatan').value.trim(),
        kelDes: document.getElementById('data-keldes').value.trim(),
        pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
        kodePos: document.getElementById('data-kodepos').value.trim(),
        telepon: document.getElementById('data-telepon').value.trim(),
        email: document.getElementById('data-email').value.trim(),
        website: document.getElementById('data-website').value.trim(),
        namaKepsek: document.getElementById('data-kepsek').value.trim(),
        nipKepsek: document.getElementById('data-nip-kepsek').value.trim()
      };

      const errors = [];
      if (!dataToSave.jenjangPilihan) { errors.push("Jenjang"); }
      if (!dataToSave.npsn) { errors.push("NPSN"); }
      if (!dataToSave.alamat) { errors.push("Alamat Sekolah"); }
      if (!dataToSave.namaKepsek) { errors.push("Nama Kepala Sekolah"); }

      const isMadrasah = (dataToSave.jenjangPilihan === 'MI' || dataToSave.jenjangPilihan === 'MTS' || dataToSave.jenjangPilihan === 'MA');
      if (isMadrasah && !dataToSave.nsm) { errors.push("NSM (wajib untuk Madrasah)"); }

      if (errors.length > 0) {
        setLoading(false);
        const errorMessage = "Field (Wajib) tidak boleh kosong: " + errors.join(', ') + ".";
        showMessage('data-sekolah-message', errorMessage, true);
        return;
      }

      jenjangPilihanCache = dataToSave.jenjangPilihan;
      google.script.run
        .withSuccessHandler(onDataSekolahSaved)
        .withFailureHandler(onGagal)
        .saveSchoolData(dataToSave);
  }

  function onDataSekolahSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('data-sekolah-message', 'Data sekolah berhasil disimpan!', false);
      } else {
        showMessage('data-sekolah-message', response.message, true);
      }
  }

  function sinkronkanBobot(sumber) {
      const inputRapor = document.getElementById('bobot-rapor');
      const inputUjian = document.getElementById('bobot-ujian');

      let nilaiRapor = parseInt(inputRapor.value, 10);
      let nilaiUjian = parseInt(inputUjian.value, 10);

      if (sumber === 'rapor') {
        if (isNaN(nilaiRapor)) { inputUjian.value = ''; return; }
        if (nilaiRapor > 100) { nilaiRapor = 100; inputRapor.value = 100; }
        if (nilaiRapor < 0) { nilaiRapor = 0; inputRapor.value = 0; }
        inputUjian.value = 100 - nilaiRapor;
      } else if (sumber === 'ujian') {
        if (isNaN(nilaiUjian)) { inputRapor.value = ''; return; }
        if (nilaiUjian > 100) { nilaiUjian = 100; inputUjian.value = 100; }
        if (nilaiUjian < 0) { nilaiUjian = 0; inputUjian.value = 0; }
        inputRapor.value = 100 - nilaiUjian;
      }
  }

  function bukaHalamanBobot() {
    tampilHalaman('halaman-bobot');
    setLoading(true, 'Memuat data bobot...', false); 
    hideMessage('bobot-message');
    document.getElementById('form-bobot').reset();
    setFormDisabled('form-bobot', true);

    google.script.run
      .withSuccessHandler(onBobotLoaded)
      .withFailureHandler(onGagal)
      .getBobotData();
  }

  function onBobotLoaded(response) {
      setLoading(false);
      setFormDisabled('form-bobot', false);

      if (response.status !== 'sukses') {
        showMessage('bobot-message', response.message, true);
        return;
      }
      document.getElementById('bobot-rapor').value = response.bobotRapor;
      document.getElementById('bobot-ujian').value = response.bobotUjian;
      document.getElementById('bobot-kkm').value = response.kkm;
  }

  function simpanBobot() {
      setLoading(true, 'Menyimpan data bobot...');
      hideMessage('bobot-message');

      const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
      const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;
      const kkm = parseInt(document.getElementById('bobot-kkm').value, 10);

      if ((bobotRapor + bobotUjian) !== 100) {
        setLoading(false);
        showMessage('bobot-message', 'Total bobot harus 100%. Silakan periksa kembali isian Anda.', true);
        return;
      }
      
      if (isNaN(kkm) || kkm < 0 || kkm > 100) {
        setLoading(false);
        showMessage('bobot-message', 'Nilai KKM harus angka yang valid antara 0 dan 100.', true);
        return;
      }

      google.script.run
        .withSuccessHandler(onBobotSaved)
        .withFailureHandler(onGagal)
        .saveBobotData(bobotRapor, bobotUjian, kkm);
  }

  function onBobotSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('bobot-message', 'Data bobot berhasil disimpan!', false);
      } else {
        showMessage('bobot-message', response.message, true);
      }
  }

  function getCurrentKelasList() {
      const inputs = document.querySelectorAll('#kelas-list-container input');
      const list = [];
      inputs.forEach(input => {
        list.push(input.value);
      });
      return list;
  }

  function renderKelasList(kelasList) {
      const container = document.getElementById('kelas-list-container');
      container.innerHTML = '';

      let listToRender = kelasList;
      if (listToRender.length === 0) {
        listToRender = [''];
      }

      listToRender.forEach((nama, index) => {
        const div = document.createElement('div');
        div.className = 'kelas-input-row';

        let html = `<input type="text" placeholder="Nama Kelas (Contoh: VI A)" value="${nama}">`;

        if (listToRender.length > 1) {
          html += '<button type="button" class="btn-aksi-kelas btn-remove-kelas">&times;</button>';
        }

        if (index === listToRender.length - 1) {
          html += '<button type="button" class="btn-aksi-kelas btn-add-kelas">+</button>';
        }

        div.innerHTML = html;
        container.appendChild(div);
      });
  }

  function bukaHalamanKelas() {
    tampilHalaman('halaman-kelas');
    setLoading(true, 'Memuat data kelas...', false); 
    hideMessage('kelas-message');
    document.getElementById('kelas-list-container').innerHTML = "<p>Memuat data kelas...</p>";
    setFormDisabled('form-kelas', true);

    google.script.run
      .withSuccessHandler(onKelasLoaded)
      .withFailureHandler(onGagal)
      .getKelas();
  }

  function onKelasLoaded(response) {
      setLoading(false);
      setFormDisabled('form-kelas', false);

      if (response.status !== 'sukses') {
        showMessage('kelas-message', response.message, true);
        document.getElementById('kelas-list-container').innerHTML = '';
        return;
      }
      renderKelasList(response.kelas || []);
  }

  function simpanKelas() {
      setLoading(true, 'Menyimpan data kelas...');
      hideMessage('kelas-message');

      const list = getCurrentKelasList()
                   .map(nama => String(nama).trim())
                   .filter(nama => nama.length > 0);

      const uniqueList = new Set(list.map(nama => nama.toUpperCase()));
      if (uniqueList.size !== list.length) {
        setLoading(false);
        showMessage('kelas-message', 'Nama kelas tidak boleh ada yang sama (duplikat).', true);
        return;
      }

      google.script.run
        .withSuccessHandler(onKelasSaved)
        .withFailureHandler(onGagal)
        .saveKelas(list);
  }

  function onKelasSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('kelas-message', 'Data kelas berhasil disimpan!', false);
      } else {
        showMessage('kelas-message', response.message, true);
      }
  }

  function bukaHalamanSiswa() {
    tampilHalaman('halaman-siswa');
    setLoading(true, 'Memuat data siswa...', false); 
    document.getElementById('siswa-table-container').innerHTML = "<p>Memuat data siswa...</p>";

    document.getElementById('btn-tambah-siswa-baru').disabled = true;
    document.getElementById('btn-import-siswa').disabled = true;
    document.getElementById('btn-hapus-semua-siswa').disabled = true;
    document.getElementById('siswa-filter-kelas').disabled = true;
    document.getElementById('siswa-sort-by').disabled = true;

    google.script.run
      .withSuccessHandler(onSiswaLoaded)
      .withFailureHandler(onGagal)
      .getSiswa();
  }

  function onSiswaLoaded(response) {
      setLoading(false);
      setSiswaOrderDirty(false);

      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;

      const container = document.getElementById('siswa-table-container');

      if (response.status === "sukses") {
        globalSiswaList = response.siswa;
        populateSiswaFilters();
        applySiswaFiltersAndRender();
      } else {
        globalSiswaList = [];
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat siswa: ${response.message}</p>`;
      }
  }

  function setSiswaOrderDirty(isDirty) {
    isSiswaOrderDirty = isDirty;
    const btnSimpan = document.getElementById('btn-simpan-urutan-siswa');
    if (btnSimpan) {
      btnSimpan.disabled = !isDirty;
    }
  }

  function onSiswaUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setSiswaOrderDirty(false);
      showMessage('siswa-message', 'Urutan siswa berhasil disimpan!', false);
    } else {
      showMessage('siswa-message', response.message, true);
    }
  }

  function populateSiswaFilters() {
    const selectKelas = document.getElementById('siswa-filter-kelas');
    const selectedValue = selectKelas.value;
    
    const kelasSet = new Set(globalSiswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    
    selectKelas.value = selectedValue || 'semua';
  }
  
  function applySiswaFiltersAndRender() {
    const selectedKelas = document.getElementById('siswa-filter-kelas').value;
    const selectedSort = document.getElementById('siswa-sort-by').value;
  
    let processedSiswa = [...globalSiswaList];
  
    if (selectedKelas !== 'semua') {
      processedSiswa = processedSiswa.filter(siswa => siswa.kelas === selectedKelas);
    }
  
    switch (selectedSort) {
      case 'nama-az':
        processedSiswa.sort((a, b) => a.nama.localeCompare(b.nama));
        break;
      case 'nama-za':
        processedSiswa.sort((a, b) => b.nama.localeCompare(a.nama));
        break;
      case 'nisn-asc':
        processedSiswa.sort((a, b) => a.nisn.localeCompare(b.nisn, undefined, { numeric: true }));
        break;
      case 'nisn-desc':
        processedSiswa.sort((a, b) => b.nisn.localeCompare(a.nisn, undefined, { numeric: true }));
        break;
      case 'default':
      default:
        processedSiswa.sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) {
            return kelasCompare;
          }
          
          const urutanA = Number(a.urutan) || 0;
          const urutanB = Number(b.urutan) || 0;
          
          return urutanA - urutanB;
        });
        break;
    }
  
    renderSiswaTable(processedSiswa);
  }
  
  function renderSiswaTable(siswaList) {
    const container = document.getElementById('siswa-table-container');
    
    let html = '<table class="siswa-table">';
    html += '<tr><th>Nama Siswa</th><th>NISN</th><th>Kelas</th><th>Aksi</th></tr>';
  
    if (siswaList.length === 0) {
      html += '<tr><td colspan="4" style="text-align: center;">Tidak ada data siswa yang sesuai dengan filter.</td></tr>';
    }
  
    let currentKelas = null;
    const selectedSort = document.getElementById('siswa-sort-by').value;
    const isDefaultSort = (selectedSort === 'default');

    siswaList.forEach((siswa, index) => {
      
      const isFirstOfClass = (siswa.kelas !== currentKelas);
      currentKelas = siswa.kelas;
      
      const nextSiswa = siswaList[index + 1];
      const isLastOfClass = (!nextSiswa || nextSiswa.kelas !== siswa.kelas);
      
      let moveButtonsHtml = '';
      if (isDefaultSort) {
        moveButtonsHtml = `
          <button 
            class="btn-aksi btn-move-up" 
            data-id="${siswa.id}" 
            ${isFirstOfClass ? 'disabled' : ''}
            title="Naikkan posisi">
              <i class="fas fa-arrow-up"></i>
          </button>
          <button 
            class="btn-aksi btn-move-down" 
            data-id="${siswa.id}" 
            ${isLastOfClass ? 'disabled' : ''}
            title="Turunkan posisi">
                <i class="fas fa-arrow-down"></i>
          </button>
        `;
      }
      
      html += `
        <tr>
          <td>${siswa.nama}</td>
          <td>${siswa.nisn}</td>
          <td>${siswa.kelas}</td>
          <td>
            <div class="btn-grup-gerak">
              ${moveButtonsHtml}
            </div>
            <div class="btn-grup-aksi">
              <button class="btn-aksi btn-edit btn-edit-siswa"
                data-id="${siswa.id}" data-nama="${siswa.nama}" data-nisn="${siswa.nisn}" data-nis-lokal="${siswa.nisLokal}" data-jk="${siswa.jk}" data-tempat-lahir="${siswa.tempatLahir}" data-tgl-lahir="${siswa.tglLahir}" data-kelas="${siswa.kelas}"
              ><i class="fas fa-pencil-alt"></i>Edit</button>
              <button class="btn-aksi btn-delete btn-delete-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}"><i class="fas fa-trash-alt"></i>Hapus</button>
            </div>
          </td>
        </tr>
      `;
    });
  
    html += '</table>';
    container.innerHTML = html;
  }

  function tutupModalSiswa() {
      document.getElementById('siswa-modal').classList.remove('show');
  }

  function showModalSiswa(mode, siswaData) {
      hideMessage('modal-siswa-error');

      document.getElementById('modal-siswa-mode').value = mode;
      document.getElementById('modal-siswa-id').value = siswaData.id || '';
      document.getElementById('modal-siswa-nama').value = '';
      document.getElementById('modal-siswa-nisn').value = '';
      document.getElementById('modal-siswa-nis-lokal').value = '';
      document.getElementById('modal-siswa-jk').value = '';
      document.getElementById('modal-siswa-tempat-lahir').value = '';
      document.getElementById('modal-siswa-tgl-lahir').value = '';

      const selectKelas = document.getElementById('modal-siswa-kelas');
      selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
      document.getElementById('btn-simpan-siswa').disabled = true;

      if (mode === 'add') {
        document.getElementById('modal-siswa-title').innerText = "Tambah Siswa Baru";
        document.getElementById('modal-siswa-nisn').readOnly = false;
      } else {
        document.getElementById('modal-siswa-title').innerText = "Edit Data Siswa";
        document.getElementById('modal-siswa-nisn').readOnly = false;

        document.getElementById('modal-siswa-id').value = siswaData.id;
        document.getElementById('modal-siswa-nama').value = siswaData.nama;
        document.getElementById('modal-siswa-nisn').value = siswaData.nisn;
        document.getElementById('modal-siswa-nis-lokal').value = siswaData.nisLokal;
        document.getElementById('modal-siswa-jk').value = siswaData.jk;
        document.getElementById('modal-siswa-tempat-lahir').value = siswaData.tempatLahir;
        document.getElementById('modal-siswa-tgl-lahir').value = siswaData.tglLahir;
      }

      document.getElementById('siswa-modal').classList.add('show');

      google.script.run
        .withSuccessHandler((response) => onKelasListLoadedForModal(response, siswaData))
        .withFailureHandler(onGagal)
        .getKelas();
  }

  function onKelasListLoadedForModal(response, siswaData) {
      const selectKelas = document.getElementById('modal-siswa-kelas');
      const btnSimpan = document.getElementById('btn-simpan-siswa');
      hideMessage('modal-siswa-error');

      if (response.status !== 'sukses' || !response.kelas || response.kelas.length === 0) {
        selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
        showMessage('modal-siswa-error', "Tidak dapat menambah/edit siswa. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
        btnSimpan.disabled = true;
      } else {
        selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        response.kelas.forEach(namaKelas => {
          selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
        });
        btnSimpan.disabled = false;

        if (document.getElementById('modal-siswa-mode').value === 'edit') {
          document.getElementById('modal-siswa-kelas').value = siswaData.kelas;
        }
      }
  }

  function simpanSiswa() {
      setLoading(true, 'Menyimpan data siswa...');
      hideMessage('modal-siswa-error');

      const dataSiswa = {
        id: document.getElementById('modal-siswa-id').value,
        nama: document.getElementById('modal-siswa-nama').value.trim(),
        nisn: document.getElementById('modal-siswa-nisn').value.trim(),
        nisLokal: document.getElementById('modal-siswa-nis-lokal').value.trim(),
        jk: document.getElementById('modal-siswa-jk').value,
        tempatLahir: document.getElementById('modal-siswa-tempat-lahir').value.trim(),
        tglLahir: document.getElementById('modal-siswa-tgl-lahir').value,
        kelas: document.getElementById('modal-siswa-kelas').value
      };

      const errors = [];
      if (!dataSiswa.nama) errors.push("Nama Lengkap");
      if (!dataSiswa.nisn) errors.push("NISN");
      if (!dataSiswa.jk) errors.push("Jenis Kelamin");
      if (!dataSiswa.kelas) errors.push("Kelas");

      if (errors.length > 0) {
        setLoading(false);
        showMessage('modal-siswa-error', "Field (Wajib) tidak boleh kosong: " + errors.join(', ') + ".", true);
        return;
      }

      const mode = document.getElementById('modal-siswa-mode').value;
      if (mode === 'add') {
        google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).createSiswa(dataSiswa);
      } else {
        google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).updateSiswa(dataSiswa);
      }
  }

  function onSiswaSaved(response) {
      setSiswaOrderDirty(false);
      setLoading(false);

      if (response.status === "sukses") {
        tutupModalSiswa();
        bukaHalamanSiswa();
      } else {
        showMessage('modal-siswa-error', response.message, true);
      }
  }

  function hapusSiswa(siswaID, namaSiswa) {
      const title = "Konfirmasi Hapus";
      const message = `Yakin ingin menghapus siswa: <strong>${namaSiswa}</strong> (ID: ${siswaID})?<br><br><strong>PERINGATAN:</strong> Semua data nilai yang terkait dengan siswa ini juga akan hilang.`;

      const callback = function() {
        setLoading(true, 'Menghapus siswa...');
        google.script.run
          .withSuccessHandler(onSiswaSaved)
          .withFailureHandler(onGagal)
          .deleteSiswa(siswaID);
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function hapusSemuaSiswa() {
      const title = "PERINGATAN BESAR!";
      const message = "Anda yakin ingin menghapus <strong>SEMUA</strong> data siswa? Tindakan ini tidak bisa dibatalkan dan akan menghapus semua data nilai yang terkait.";

      const callback = function() {
        setLoading(true, 'Menghapus semua siswa...');
        google.script.run
          .withSuccessHandler(onSiswaTableRefreshed)
          .withFailureHandler(onGagal)
          .deleteAllSiswa();
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function onSiswaTableRefreshed(response) {
      setLoading(false);
      if (response.status === "sukses") {
        showInfoModal("Sukses", response.message, false, bukaHalamanSiswa);
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function bukaModalImportSiswa() {
    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
    document.getElementById('import-siswa-results').style.display = 'none';
    document.getElementById('import-siswa-results').innerHTML = '';
    hideMessage('template-message');
    
    const fileUploadText = document.getElementById('file-upload-text');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone').classList.remove('drag-over');

    siswaTelahDiImport = false;
    
    document.getElementById('import-siswa-modal').classList.add('show');
  }

  function tutupModalImportSiswa() {
    document.getElementById('import-siswa-modal').classList.remove('show');
    if (siswaTelahDiImport) {
      siswaTelahDiImport = false;
      bukaHalamanSiswa();
    }
  }

  function downloadTemplateSiswa() {
    setLoading(true, 'Membuat template...');
    hideMessage('template-message');
    google.script.run
      .withSuccessHandler(onTemplateUrlReceived)
      .withFailureHandler(onGagal)
      .getSiswaTemplateUrl();
  }
  
  function onTemplateUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        link.click();
        
        document.body.removeChild(link);

      } catch (e) {
        showMessage('template-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      showMessage('template-message', response.message, true);
    }
  }


  function prosesImportFileSiswa() {
    setLoading(true, 'Mengimpor siswa...');
    document.getElementById('import-siswa-results').style.display = 'none';
    hideMessage('template-message');

    const fileInput = document.getElementById('file-upload-siswa');
    const file = fileInput.files[0];

    if (!file) {
      setLoading(false);
      showMessage('template-message', 'Pilih file Excel terlebih dahulu.', true);
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      const fileData = {
        base64: e.target.result,
        mimeType: file.type,
        fileName: file.name
      };
      
      google.script.run
        .withSuccessHandler(onImportSiswaFinished)
        .withFailureHandler(onGagal)
        .prosesImportExcelSiswa(fileData);
    };

    reader.onerror = (e) => {
      setLoading(false);
      showMessage('template-message', 'Gagal membaca file: ' + e.target.error.name, true);
    };

    reader.readAsDataURL(file);
  }

  function onImportSiswaFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-siswa-results');

    if (response.status !== 'sukses') {
      showMessage('template-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      siswaTelahDiImport = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>NISN</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.nisn || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
  }

  function bukaModalUploadNilai() {
    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    document.getElementById('import-nilai-results').style.display = 'none';
    document.getElementById('import-nilai-results').innerHTML = '';
    hideMessage('template-nilai-message');
    
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-nilai').classList.remove('drag-over');

    nilaiTelahDiUpload = false;
    
    document.getElementById('upload-nilai-modal').classList.add('show');

    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
    
    google.script.run
      .withSuccessHandler(onKelasListLoadedForUploadModal)
      .withFailureHandler(onGagal)
      .getKelas();
  }

  function onKelasListLoadedForUploadModal(response) {
    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    hideMessage('template-nilai-message');

    if (response.status !== 'sukses' || !response.kelas || response.kelas.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('template-nilai-message', "Tidak dapat membuat template. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
    } else {
      selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      response.kelas.forEach(namaKelas => {
        selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
      });
    }
  }

  function tutupModalUploadNilai() {
    document.getElementById('upload-nilai-modal').classList.remove('show');
    if (nilaiTelahDiUpload) {
      nilaiTelahDiUpload = false;
    }
  }

  function downloadTemplateNilai() {
    setLoading(true, 'Membuat template nilai...');
    hideMessage('template-nilai-message');
    
    const kelasDipilih = document.getElementById('upload-nilai-filter-kelas').value;
    if (!kelasDipilih) {
        setLoading(false);
        showMessage('template-nilai-message', 'Gagal memuat kelas. Silakan coba buka ulang modal.', true);
        return;
    }

    google.script.run
      .withSuccessHandler(onTemplateNilaiUrlReceived)
      .withFailureHandler(onGagal)
      .getNilaiTemplateData(kelasDipilih);
  }

  function onTemplateNilaiUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-nilai-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-nilai-message', 'Gagal memproses unduhan: ' + e.message, true);
      }

    } else {
      showMessage('template-nilai-message', response.message, true);
    }
  }

  function prosesUploadFileNilai() {
    setLoading(true, 'Mengupload nilai...');
    document.getElementById('import-nilai-results').style.display = 'none';
    hideMessage('template-nilai-message');

    const fileInput = document.getElementById('file-upload-nilai');
    const file = fileInput.files[0];

    if (!file) {
      setLoading(false);
      showMessage('template-nilai-message', 'Pilih file Excel terlebih dahulu.', true);
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      const fileData = {
        base64: e.target.result,
        mimeType: file.type,
        fileName: file.name
      };
      
      google.script.run
        .withSuccessHandler(onUploadNilaiFinished)
        .withFailureHandler(onGagal)
        .prosesUploadExcelNilai(fileData);
    };

    reader.onerror = (e) => {
      setLoading(false);
      showMessage('template-nilai-message', 'Gagal membaca file: ' + e.target.error.name, true);
    };

    reader.readAsDataURL(file);
  }

  function onUploadNilaiFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-nilai-results');

    if (response.status !== 'sukses') {
      showMessage('template-nilai-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      nilaiTelahDiUpload = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Upload Selesai</h4>';
    html += `<p>Total nilai terdeteksi: <strong>${response.totalDitemukan}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan/diperbarui: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Sheet</th><th>Baris</th><th>Info</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.sheet || 'N/A'}</td>
            <td>${item.baris || 'N/A'}</td>
            <td>${item.info || 'N/A'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
  }

  function bukaHalamanInputUjian() {
    tampilHalaman('halaman-input-ujian');
    
    const labelUjianUtama = document.getElementById('label-ujian-utama');
    
    const jenjangPilihan = jenjangPilihanCache;
    if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
      labelUjianUtama.innerText = 'Ujian Madrasah';
    } else {
      labelUjianUtama.innerText = 'Ujian Sekolah';
    }
  }

  function bukaHalamanInputNilaiDetail(tipeUjian) {
    tampilHalaman('halaman-input-nilai-detail');
    hideMessage('input-nilai-message');
    
    const judulHalaman = document.getElementById('judul-halaman-input-nilai');
    const tableContainer = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');

    tableContainer.innerHTML = '<p>Memuat data siswa dan mata pelajaran...</p>';
    btnSimpan.disabled = true;
    btnBersihkan.disabled = true;
    document.getElementById('input-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };

    if (tipeUjian === 'UM') {
      const jenjangPilihan = jenjangPilihanCache;
      const label = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
      judulHalaman.innerText = `Input Nilai ${label}`;
      judulHalaman.dataset.tipeUjian = 'UM';
    } else {
      judulHalaman.innerText = 'Input Nilai Ujian Praktek';
      judulHalaman.dataset.tipeUjian = 'Praktek';
    }

    setLoading(true, 'Memuat data nilai...', false); 
    google.script.run
      .withSuccessHandler(onNilaiGridLoaded)
      .withFailureHandler(onGagal) 
      .getNilaiUjianGridData(tipeUjian);
  }

  function populateNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('input-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || 'semua';
  }

  function onNilaiGridLoaded(response) {
    setLoading(false);
    const container = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      return;
    }

    globalGridData = response.data;
    
    populateNilaiFilter(globalGridData.siswaList);

    renderNilaiGridTable(); 
    
    const { siswaList, mapelList } = globalGridData;
    if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
      btnSimpan.disabled = false;
      btnBersihkan.disabled = false;
    } else {
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
    }
  }

  function renderNilaiGridTable() {
    const container = document.getElementById('input-nilai-table-container');
    
    const { siswaList, mapelList, nilaiData } = globalGridData;
    
    const selectedKelas = document.getElementById('input-nilai-filter-kelas').value;
    
    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa. Harap isi di menu "Kelola Data Siswa".</p>';
      return;
    }
    
    if (!mapelList || mapelList.length === 0) {
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    let html = '<table class="input-nilai-table">';
    
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th 
                class="col-mapel clickable-mapel-header" 
                data-mapel-nama="${mapel.nama}" 
                title="Klik untuk lihat nama mapel"
              >
                ${mapel.id}
              </th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        
        const storedNilai = nilaiData[key];
        let nilai = '';
        
        if (storedNilai === 0 || storedNilai === '0') {
            nilai = 0;
        } else if (storedNilai) {
            nilai = storedNilai;
        }
        
        html += `<td class="col-mapel">
            <input 
              type="number" 
              class="input-nilai" 
              min="0" 
              max="100" 
              placeholder="-"
              value="${nilai}"
              data-siswa-id="${siswa.id}" 
              data-mapel-id="${mapel.id}"
            >
          </td>`;
      });
      html += `<td class="col-total col-total-jumlah" id="jumlah_${siswa.id}">0</td>`;
      html += `<td class="col-total col-total-rata" id="rata_${siswa.id}">0.00</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;

    const mapelCount = mapelList.length;
    if (mapelCount > 0) {
      filteredSiswaList.forEach(siswa => {
        updateRowTotals(siswa.id, mapelCount);
      });
    }
  }

  function updateRowTotals(siswaId, mapelCount) {
    const jumlahCell = document.getElementById(`jumlah_${siswaId}`);
    const rataCell = document.getElementById(`rata_${siswaId}`);
    
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`.input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 

    rowInputs.forEach(input => {
      const value = input.value; 
      
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });

    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilai() {
    setLoading(true, 'Menyimpan nilai...');
    hideMessage('input-nilai-message');
    
    const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
    
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    const dataToSave = [];
    
    inputs.forEach(input => {
      dataToSave.push({
        siswaId: input.dataset.siswaId,
        mapelId: input.dataset.mapelId,
        tipeUjian: tipeUjian,
        nilai: input.value
      });
    });

    google.script.run
      .withSuccessHandler((response) => onNilaiUjianSaved(response, dataToSave)) 
      .withFailureHandler(onGagal)
      .saveNilaiUjianBatch(dataToSave);
  }

  function onNilaiUjianSaved(response, savedData) { 
    if (response.status === 'sukses') {
      setLoading(false);
      showMessage('input-nilai-message', response.message, false);
      
      if (globalGridData && globalGridData.nilaiData) {
        savedData.forEach(item => {
          const key = `${item.siswaId}_${item.mapelId}`;
          const nilai = item.nilai;
          
          if (nilai === "" || nilai === null || nilai === undefined) {
            delete globalGridData.nilaiData[key];
          } else {
            const numValue = parseInt(nilai, 10);
            if (!isNaN(numValue)) {
              globalGridData.nilaiData[key] = numValue;
            } else {
              delete globalGridData.nilaiData[key];
            }
          }
        });
        console.log("Cache nilai ujian lokal berhasil diperbarui.");
      }

    } else {
      setLoading(false);
      showMessage('input-nilai-message', response.message, true);
    }
  }

  function bukaHalamanRekapNilai() {
    tampilHalaman('halaman-rekap-nilai');
    hideMessage('rekap-nilai-message');
    
    const tableContainer = document.getElementById('rekap-nilai-table-container');

    tableContainer.innerHTML = '<p>Memuat data rekapitulasi nilai...</p>';
    document.getElementById('rekap-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };

    setLoading(true, 'Membuat rekapitulasi nilai...', false);
    google.script.run
      .withSuccessHandler(onRekapNilaiLoaded)
      .withFailureHandler(onGagal) 
      .getRekapitulasiNilaiData();
  }

  function onRekapNilaiLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-nilai-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    globalGridData = response.data;
    
    populateRekapNilaiFilter(globalGridData.siswaList);

    renderRekapNilaiTable();
  }

  function populateRekapNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || 'semua';
  }

  function renderRekapNilaiTable() {
    const container = document.getElementById('rekap-nilai-table-container');
    
    const { siswaList, mapelList, nilaiRekapData } = globalGridData;
    
    const selectedKelas = document.getElementById('rekap-nilai-filter-kelas').value;
    
    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    
    if (!mapelList || mapelList.length === 0) {
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    let html = '<table class="input-nilai-table">';
    
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th 
                class="col-mapel clickable-mapel-header" 
                data-mapel-nama="${mapel.nama}" 
                title="Klik untuk lihat nama mapel"
              >
                ${mapel.id}
              </th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '<th class="th-total th-total-bulat">Pembulatan</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      let sum = 0;
      let count = 0; 
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiRekapData[key];
        
        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
            if (nilai === 0) {
              nilaiTampil = 0;
            } else {
              if (nilai % 1 === 0) {
                nilaiTampil = nilai.toFixed(0);
              } else {
                nilaiTampil = nilai.toFixed(2); 
              }
            }
            sum += nilai;
            count++; 
        }
        
        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">
            ${nilaiTampil}
          </td>`;
      });
      
      const average = (count > 0) ? (sum / count) : 0;
      
      const pembulatan = Math.round(average);
      const sumTampil = parseFloat(sum.toFixed(2));
      
      html += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      html += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function konfirmasiBersihkanNilai() {
    const title = "Konfirmasi Bersihkan Formulir";
    const message = "Ingin memulai lembar baru? <br><br>Ini akan <strong>mengosongkan semua nilai</strong> yang tampil di layar. Data yang sudah tersimpan di server <strong>tetap aman</strong>.";
    
    showConfirmationModal(title, message, bersihkanInputNilai, 'danger');
  }

  function bersihkanInputNilai() {
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    
    const mapelCount = globalGridData.mapelList.length;
    
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotals(siswaId, mapelCount);
      });
    }

    showMessage('input-nilai-message', 'Semua nilai di formulir telah dibersihkan.', false);
  }

  function bukaHalamanInputRapor() {
    tampilHalaman('halaman-input-rapor');
    setLoading(true, 'Memuat daftar semester...', false);
    const container = document.getElementById('rapor-semester-card-container');
    container.innerHTML = '<p>Memuat daftar semester...</p>';

    google.script.run
      .withSuccessHandler(onSemesterListLoaded)
      .withFailureHandler(onGagal)
      .getSemesterList();
  }

  function onSemesterListLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rapor-semester-card-container');
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
      return;
    }

    if (response.semesterList.length === 0) {
      container.innerHTML = '<p>Tidak ada daftar semester yang ditemukan. Periksa pengaturan jenjang dan semester.</p>';
      return;
    }

    let html = '';
    response.semesterList.forEach(semester => {
      const hoverStyle = `onmouseover="this.style.backgroundColor='${semester.color}'; this.style.color='white';" 
                          onmouseout="this.style.backgroundColor='white'; this.style.color='${semester.color}';"`;
      
      html += `
        <button class="dashboard-card" onclick="bukaHalamanInputRaporDetail('${semester.id}')" 
                style="color: ${semester.color || '#0d6efd'};" ${hoverStyle}>
          <i class="fas fa-edit"></i>
          <span>${semester.nama}</span>
        </button>
      `;
    });
    container.innerHTML = html;
  }

  function bukaHalamanInputRaporDetail(semesterId) {
    tampilHalaman('halaman-input-rapor-detail');
    hideMessage('input-rapor-message');
    
    const judulHalaman = document.getElementById('judul-halaman-input-rapor');
    const tableContainer = document.getElementById('input-rapor-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-rapor');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-rapor');

    tableContainer.innerHTML = '<p>Memuat data siswa dan mata pelajaran...</p>';
    btnSimpan.disabled = true;
    btnBersihkan.disabled = true;
    document.getElementById('input-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporGridData = { siswaList: [], mapelList: [], nilaiData: {} };

    judulHalaman.innerText = `Input Nilai Rapor...`;
    judulHalaman.dataset.semesterId = semesterId;
    
    setLoading(true, 'Memuat data nilai rapor...', false); 
    google.script.run
      .withSuccessHandler(onNilaiRaporGridLoaded) 
      .withFailureHandler(onGagal) 
      .getNilaiRaporGridData(semesterId);
  }

  function onNilaiRaporGridLoaded(response) {
    setLoading(false);
    const container = document.getElementById('input-rapor-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-rapor');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-rapor');

    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      globalRaporGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      return;
    }

    if (response.namaSemester) {
        document.getElementById('judul-halaman-input-rapor').innerText = `Input Nilai ${response.namaSemester}`;
    }

    globalRaporGridData = response.data;
    
    populateNilaiRaporFilter(globalRaporGridData.siswaList);
    renderNilaiRaporGridTable(); 
    
    const { siswaList, mapelList } = globalRaporGridData;
    if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
      btnSimpan.disabled = false;
      btnBersihkan.disabled = false;
    } else {
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
    }
  }
  
  function populateNilaiRaporFilter(siswaList) {
    const selectKelas = document.getElementById('input-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || 'semua';
  }

  function renderNilaiRaporGridTable() {
    const container = document.getElementById('input-rapor-table-container');
    const { siswaList, mapelList, nilaiData } = globalRaporGridData;
    const selectedKelas = document.getElementById('input-rapor-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = `<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    let html = '<table class="input-nilai-table">';
    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiData[key];
        let nilai = '';
        if (storedNilai === 0 || storedNilai === '0') {
            nilai = 0;
        } else if (storedNilai) {
            nilai = storedNilai;
        }
        html += `<td class="col-mapel"><input type="number" class="input-nilai" min="0" max="100" placeholder="-" value="${nilai}" data-siswa-id="${siswa.id}" data-mapel-id="${mapel.id}"></td>`;
      });
      html += `<td class="col-total col-total-jumlah" id="jumlah_rapor_${siswa.id}">0</td>`;
      html += `<td class="col-total col-total-rata" id="rata_rapor_${siswa.id}">0.00</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    container.innerHTML = html;

    const mapelCount = mapelList.length;
    if (mapelCount > 0) {
      filteredSiswaList.forEach(siswa => {
        updateRowTotalsRapor(siswa.id, mapelCount);
      });
    }
  }

  function updateRowTotalsRapor(siswaId, mapelCount) {
    const jumlahCell = document.getElementById(`jumlah_rapor_${siswaId}`);
    const rataCell = document.getElementById(`rata_rapor_${siswaId}`);
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`#halaman-input-rapor-detail .input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 

    rowInputs.forEach(input => {
      const value = input.value; 
      
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilaiRapor() {
    setLoading(true, 'Menyimpan nilai rapor...');
    hideMessage('input-rapor-message');
    
    const semesterId = document.getElementById('judul-halaman-input-rapor').dataset.semesterId;
    const inputs = document.querySelectorAll('#input-rapor-table-container .input-nilai');
    const dataToSave = [];
    
    inputs.forEach(input => {
      dataToSave.push({
        siswaId: input.dataset.siswaId,
        mapelId: input.dataset.mapelId,
        semesterId: semesterId,
        nilai: input.value
      });
    });

    google.script.run
      .withSuccessHandler((response) => onNilaiRaporSaved(response, dataToSave)) 
      .withFailureHandler(onGagal)
      .saveNilaiRaporBatch(dataToSave);
  }

  function onNilaiRaporSaved(response, savedData) { 
    if (response.status === 'sukses') {
      setLoading(false);
      showMessage('input-rapor-message', response.message, false);
      
      if (globalRaporGridData && globalRaporGridData.nilaiData) {
         savedData.forEach(item => {
          const key = `${item.siswaId}_${item.mapelId}`;
          const nilai = item.nilai;
          
          if (nilai === "" || nilai === null || nilai === undefined) {
            delete globalRaporGridData.nilaiData[key];
          } else {
            const numValue = parseInt(nilai, 10);
            if (!isNaN(numValue)) {
              globalRaporGridData.nilaiData[key] = numValue;
            } else {
              delete globalRaporGridData.nilaiData[key];
            }
          }
        });
        console.log("Cache nilai rapor lokal berhasil diperbarui.");
      }

    } else {
      setLoading(false);
      showMessage('input-rapor-message', response.message, true);
    }
  }

  function konfirmasiBersihkanNilaiRapor() {
    const title = "Konfirmasi Bersihkan Formulir";
    const message = "Ini akan <strong>mengosongkan semua nilai</strong> yang tampil di layar. Data yang sudah tersimpan <strong>tetap aman</strong>.";
    showConfirmationModal(title, message, bersihkanInputNilaiRapor, 'danger');
  }

  function bersihkanInputNilaiRapor() {
    const inputs = document.querySelectorAll('#input-rapor-table-container .input-nilai');
    const mapelCount = globalRaporGridData.mapelList.length;
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotalsRapor(siswaId, mapelCount);
      });
    }
    showMessage('input-rapor-message', 'Formulir telah dibersihkan.', false);
  }

  function bukaHalamanRekapRapor() {
    tampilHalaman('halaman-rekap-rapor');
    hideMessage('rekap-rapor-message');
    const tableContainer = document.getElementById('rekap-rapor-table-container');
    tableContainer.innerHTML = '<p>Memuat data rekapitulasi nilai rapor...</p>';
    document.getElementById('rekap-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };

    setLoading(true, 'Membuat rekapitulasi rapor...', false);
    google.script.run
      .withSuccessHandler(onRekapRaporLoaded) 
      .withFailureHandler(onGagal) 
      .getRekapitulasiNilaiRaporData();
  }

  function onRekapRaporLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-rapor-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    document.getElementById('judul-halaman-rekap-rapor').innerText = `Rekapitulasi Rapor (${response.data.jumlahSemester} Semester)`;

    globalRaporGridData = response.data;
    populateRekapRaporFilter(globalRaporGridData.siswaList);
    renderRekapRaporTable();
  }

  function populateRekapRaporFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || 'semua';
  }

  function renderRekapRaporTable() {
    const container = document.getElementById('rekap-rapor-table-container');
    const { siswaList, mapelList, nilaiRekapData } = globalRaporGridData; 
    const selectedKelas = document.getElementById('rekap-rapor-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>';
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }

    let html = '<table class="input-nilai-table">';
    
    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '<th class="th-total th-total-bulat">Pembulatan</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 
      
      let sum = 0;
      let count = 0;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiRekapData[key];
        
        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
            if (nilai === 0) {
              nilaiTampil = 0;
            } else {
              if (nilai % 1 !== 0) {
                nilaiTampil = nilai.toFixed(2); 
              } else {
                nilaiTampil = nilai.toFixed(0);
              }
            }
            sum += nilai;
            count++;
        }
        
        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
      });
      
      const average = (count > 0) ? (sum / count) : 0;
      const pembulatan = Math.round(average);
      const sumTampil = parseFloat(sum.toFixed(2));
      
      html += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      html += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function bukaHalamanSemester() {
    tampilHalaman('halaman-semester');
    setLoading(true, 'Memuat pengaturan semester...', false); 
    hideMessage('semester-message');
    document.getElementById('form-semester').reset();
    setFormDisabled('form-semester', true);
    document.getElementById('pilihan-semester').innerHTML = '<option value="">Memuat...</option>';
    
    google.script.run
      .withSuccessHandler(onSemesterSettingLoaded)
      .withFailureHandler(onGagal)
      .getSemesterSetting();
  }

  function onSemesterSettingLoaded(response) {
    setLoading(false);
    setFormDisabled('form-semester', false);
    const select = document.getElementById('pilihan-semester');
    select.innerHTML = '';
    select.disabled = false;
    document.getElementById('btn-simpan-semester').disabled = false;

    if (response.status !== 'sukses') {
      showMessage('semester-message', response.message, true);
      return;
    }

    const jenjang = response.jenjang;
    const setting = response.setting || 5;

    if (jenjang === 'SD/MI') {
      select.innerHTML = '<option value="5">5 Semester (Default)</option>';
      select.innerHTML += '<option value="3">3 Semester</option>';
    } else {
      select.innerHTML = '<option value="5">5 Semester (Otomatis)</option>';
      select.disabled = true;
      document.getElementById('btn-simpan-semester').disabled = true;
    }
    
    select.value = setting;
  }

  function simpanSemester() {
    setLoading(true, 'Menyimpan data semester...');
    hideMessage('semester-message');

    const nilaiSemester = document.getElementById('pilihan-semester').value;

    google.script.run
      .withSuccessHandler(onSemesterSettingSaved)
      .withFailureHandler(onGagal)
      .saveSemesterSetting(nilaiSemester);
  }

  function onSemesterSettingSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('semester-message', 'Pengaturan semester berhasil disimpan!', false);
    } else {
      showMessage('semester-message', response.message, true);
    }
  }

</script>
