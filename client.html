<script>
  // [BARU] Variabel global untuk menyimpan jenjang dasar
  let jenjangBaseCache = '';

  // ===========================================
  // FUNGSI UTILITAS
  // ===========================================
  
  /**
   * Menampilkan atau menyembunyikan spinner loading.
   */
  function setLoading(isLoading) {
    document.getElementById('loader').style.display = isLoading ? 'flex' : 'none';
  }

  /**
   * Menampilkan pesan error atau sukses.
   */
  function showMessage(elementId, message, isError) {
    if (typeof isError === 'undefined' || isError === null) {
      isError = true;
    }
    
    const el = document.getElementById(elementId);
    el.innerText = message;
    el.className = isError ? 'message error' : 'message success';
    el.style.display = 'block';
  }

  /**
   * Menyembunyikan pesan error/sukses.
   */
  function hideMessage(elementId) {
    const el = document.getElementById(elementId);
    if(el) {
      el.style.display = 'none';
      el.innerText = '';
    }
  }

  /**
   * Mengatur halaman mana yang terlihat (Single Page App).
   */
  function tampilHalaman(idHalaman) {
    // Sembunyikan semua container utama
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('halaman-utama').style.display = 'none';
    document.getElementById('halaman-mapel').style.display = 'none';
    document.getElementById('halaman-data-sekolah').style.display = 'none';
    document.getElementById('halaman-bobot').style.display = 'none'; // [BARU] Sembunyikan halaman bobot

    // Sembunyikan pesan error
    hideMessage('login-error');
    hideMessage('reg-message');
    hideMessage('data-sekolah-message');
    hideMessage('bobot-message'); // [BARU] Sembunyikan pesan error bobot

    if (idHalaman === 'halaman-utama') {
      document.getElementById('halaman-utama').style.display = 'block';
    } 
    else if (idHalaman === 'halaman-mapel') {
      document.getElementById('halaman-mapel').style.display = 'block';
    } 
    else if (idHalaman === 'halaman-data-sekolah') { 
      document.getElementById('halaman-data-sekolah').style.display = 'block';
    } 
    else if (idHalaman === 'halaman-bobot') { // [BARU] Tampilkan halaman bobot
      document.getElementById('halaman-bobot').style.display = 'block';
    } 
    else {
      // Tampilkan container auth
      document.getElementById('auth-container').style.display = 'block';
      // Sembunyikan semua halaman di dalam auth-container
      document.getElementById('halaman-login').style.display = 'none';
      document.getElementById('halaman-registrasi').style.display = 'none';
      // Tampilkan halaman yang dituju
      document.getElementById(idHalaman).style.display = 'block';
    }
  }

  /**
   * Menampilkan modal konfirmasi kustom.
   * @param {string} title Judul modal.
   * @param {string} message Pesan (bisa berisi HTML seperti <br> atau <strong>).
   * @param {function} onConfirmCallback Fungsi yang akan dijalankan jika "OK" diklik.
   * @param {string} okButtonType Tipe tombol 'danger' (merah) atau 'primary' (biru).
   */
  function showConfirmationModal(title, message, onConfirmCallback, okButtonType = 'danger') {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-body').innerHTML = message; // innerHTML agar tag <strong> terbaca

    const okButton = document.getElementById('btn-confirm-ok');
    
    // Atur warna tombol OK
    if (okButtonType === 'danger') {
      okButton.style.backgroundColor = 'var(--danger-color)';
    } else {
      okButton.style.backgroundColor = 'var(--primary-color)';
    }
    
    // Simpan fungsi callback di elemen modal untuk dipanggil nanti
    modal.onConfirm = onConfirmCallback;
    
    modal.style.display = 'block';
  }

  /**
   * Menutup modal konfirmasi.
   */
  function hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.style.display = 'none';
    modal.onConfirm = null; // Hapus callback setelah ditutup
  }

  /**
   * Menampilkan modal info kustom (pengganti alert).
   * @param {string} title Judul modal.
   * @param {string} message Pesan.
   * @param {boolean} isError Set ke true untuk teks merah.
   */
  function showInfoModal(title, message, isError, onOkCallback) {
    const modal = document.getElementById('info-modal');
    document.getElementById('info-modal-title').innerText = title;
    
    const modalBody = document.getElementById('info-modal-body');
    modalBody.innerText = message;
    
    if (isError) {
      modalBody.classList.add('error');
    } else {
      modalBody.classList.remove('error');
    }

    // Simpan callback di elemen modal
    modal.onOk = onOkCallback || null;
    
    modal.style.display = 'block';
  }

  /**
   * Menutup modal info.
   */
  function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    modal.style.display = 'none';

    // Periksa dan jalankan callback JIKA ADA
    if (typeof modal.onOk === 'function') {
      modal.onOk(); // Jalankan callback
    }
    modal.onOk = null; // Hapus callback setelah dijalankan
  }

  // ===========================================
  // EVENT LISTENERS
  // ===========================================
  
  document.addEventListener('DOMContentLoaded', (event) => {
  
    // Listener Tombol Login
    document.getElementById('btn-login').addEventListener('click', () => {
      setLoading(true);
      hideMessage('login-error');
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      google.script.run
        .withSuccessHandler(hasilLogin)
        .withFailureHandler(onGagal)
        .prosesLogin(email, pass);
    });
    
    // Listener Tombol Registrasi
    document.getElementById('btn-registrasi').addEventListener('click', () => {
      setLoading(true);
      hideMessage('reg-message');
      
      // [UPDATE] Mengubah namaSekolah menjadi uppercase saat dikirim
      const namaSekolah = document.getElementById('reg-nama-sekolah').value.toUpperCase(); 
      const jenjang = document.getElementById('reg-jenjang').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      
      if (!namaSekolah || !jenjang || !email || !password) {
        setLoading(false);
        showMessage('reg-message', "Semua field wajib diisi.", true);
        return;
      }
      
      google.script.run
        .withSuccessHandler(hasilRegistrasi)
        .withFailureHandler(onGagal)
        .prosesRegistrasi(namaSekolah, jenjang, email, password);
    });

    // Listener Tombol Contoh Hitung Nilai
    document.getElementById('btn-hitung').addEventListener('click', () => {
      setLoading(true);
      document.getElementById('hasil-hitung').innerHTML = "Menghitung...";
      google.script.run
        .withSuccessHandler(hasilHitung)
        .withFailureHandler(onGagal)
        .hitungNilaiIjazahSiswa('S-001'); // Hardcode ID siswa untuk tes
    });
    
    // Listener Tombol Logout
    document.getElementById('btn-logout').addEventListener('click', () => {
      setLoading(true);
      google.script.run
        .withSuccessHandler(onLogout)
        .withFailureHandler(onGagal)
        .prosesLogout();
    });
    
    // Listener untuk link "Daftar di sini"
    document.getElementById('link-ke-registrasi').addEventListener('click', (e) => {
      e.preventDefault(); 
      tampilHalaman('halaman-registrasi');
    });
    
    // Listener untuk link "Login"
    document.getElementById('link-ke-login').addEventListener('click', (e) => {
      e.preventDefault(); 
      tampilHalaman('halaman-login');
    });


    // --- LISTENER UNTUK FITUR BARU (PASSWORD & DATA SEKOLAH) ---
    
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault(); 
      document.getElementById('btn-login').click(); 
    });

    document.getElementById('reg-form').addEventListener('submit', (e) => {
      e.preventDefault(); 
    });
    
    document.getElementById('toggle-login-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-password');
      
      // Terapkan logika dari user
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);

      // Ganti ikon (logika dari user)
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggle-reg-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password');
      
      // Terapkan logika dari user
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);

      // Ganti ikon (logika dari user)
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // [BARU] Listener untuk tombol 'Kelola Data Sekolah'
    document.getElementById('btn-buka-data-sekolah').addEventListener('click', () => {
      bukaHalamanDataSekolah();
    });

    // [BARU] Listener untuk tombol 'Kembali' di hal. data sekolah
    document.getElementById('btn-kembali-ke-dashboard-2').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // [BARU] Listener untuk simpan form data sekolah
    document.getElementById('form-data-sekolah').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanDataSekolah();
    });

    // [BARU] Listener untuk logika kondisional NSM
    document.getElementById('data-jenjang-pilihan').addEventListener('change', updateTampilanNSM);
    // --- AKHIR BAGIAN BARU ---

    
    // --- [BARU] LISTENER FITUR BOBOT ---
    
    document.getElementById('btn-buka-bobot').addEventListener('click', () => {
      bukaHalamanBobot();
    });

    document.getElementById('btn-kembali-ke-dashboard-3').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    document.getElementById('form-bobot').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanBobot();
    });

    // Listener untuk sinkronisasi input bobot
    document.getElementById('bobot-rapor').addEventListener('input', () => {
      sinkronkanBobot('rapor');
    });
    document.getElementById('bobot-ujian').addEventListener('input', () => {
      sinkronkanBobot('ujian');
    });
    
    // --- AKHIR BAGIAN BARU ---


    // --- LISTENER FITUR MAPEL ---

    // Listener untuk membuka halaman kelola mapel
    document.getElementById('btn-buka-mapel').addEventListener('click', () => {
      bukaHalamanMapel();
    });

    document.getElementById('btn-ambil-default').addEventListener('click', () => {
      const title = "Ambil Mapel Default";
      const message = "Ini akan mengambil mapel default dari master dan menambahkan yang hilang. Lanjutkan?";
      
      const callback = function() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(onTableRefreshed)
          .withFailureHandler(onGagal)
          .syncDefaultMapel();
      };
      
      showConfirmationModal(title, message, callback, 'primary'); 
    });

    document.getElementById('btn-hapus-semua').addEventListener('click', () => {
      const title = "PERINGATAN!";
      const message = "Anda yakin ingin menghapus <strong>SEMUA</strong> mata pelajaran? Tindakan ini tidak bisa dibatalkan.";
      
      const callback = function() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(onTableRefreshed)
          .withFailureHandler(onGagal)
          .deleteAllMapel();
      };
      
      showConfirmationModal(title, message, callback, 'danger'); 
    });

    // Listener untuk kembali ke dashboard dari hal. mapel
    document.getElementById('btn-kembali-ke-dashboard').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // Listener untuk tombol 'Tambah Mapel Baru'
    document.getElementById('btn-tambah-mapel-baru').addEventListener('click', () => {
      showModalMapel('add');
    });

    // Listener untuk menutup modal
    document.getElementById('btn-tutup-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-batal-modal').addEventListener('click', tutupModalMapel);

    // Listener untuk tombol simpan di modal
    document.getElementById('btn-simpan-mapel').addEventListener('click', simpanMapel);

    // Listener untuk tombol aksi (Edit/Delete) di tabel
    document.getElementById('mapel-table-container').addEventListener('click', (e) => {
      const target = e.target.closest('button'); 
      if (!target) return; 

      if (target.classList.contains('btn-edit')) {
        const id = target.getAttribute('data-id');
        const nama = target.getAttribute('data-nama');
        showModalMapel('edit', id, nama);
      }
      else if (target.classList.contains('btn-delete')) {
        const id = target.getAttribute('data-id');
        hapusMapel(id);
      }
    });

    document.getElementById('btn-confirm-cancel').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-close').addEventListener('click', hideConfirmationModal);
    
    document.getElementById('btn-confirm-ok').addEventListener('click', () => {
      const modal = document.getElementById('confirmation-modal');
      if (typeof modal.onConfirm === 'function') {
        modal.onConfirm(); 
      }
      hideConfirmationModal(); 
    });

    document.getElementById('btn-info-close').addEventListener('click', hideInfoModal);
    document.getElementById('btn-info-ok').addEventListener('click', hideInfoModal);
    
    // === PEMERIKSAAN TOKEN SAAT LOAD ===
    const token = localStorage.getItem('sessionToken');
    if (token) {
      // Token ada, coba validasi ke server
      setLoading(true);
      google.script.run
        .withSuccessHandler(onTokenCheck)
        .withFailureHandler(onTokenCheck) // Tangani kegagalan juga
        .checkToken(token);
    } else {
      // Tidak ada token, tampilkan halaman login
      tampilHalaman('halaman-login');
      setLoading(false); // Sembunyikan loader
    }
  });


  // ===========================================
  // HANDLER (Callback Functions)
  // ===========================================
  
  /**
   * [CALLBACK] Menangani hasil pemeriksaan token saat load.
   */
  function onTokenCheck(response) {
    setLoading(false);
    if (response.status === "sukses") {
      // Token valid, set dashboard dan tampilkan
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      tampilHalaman('halaman-utama');
    } else {
      // Token tidak valid atau kedaluwarsa
      localStorage.removeItem('sessionToken'); // Hapus token buruk
      tampilHalaman('halaman-login');
      // Tampilkan pesan error jika ada
      if(response.message) {
        showMessage('login-error', response.message, true);
      }
    }
  }
  
  function hasilLogin(response) {
    setLoading(false);
    if (response.status === "sukses") {
      // SIMPAN TOKEN ke localStorage
      localStorage.setItem('sessionToken', response.token);
      
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      tampilHalaman('halaman-utama');
    } else {
      showMessage('login-error', response.message, true);
    }
  }
  
  function hasilRegistrasi(response) {
    setLoading(false);
    if (response.status === "sukses") {
      showMessage('reg-message', response.message, false); // false = sukses
      
      document.getElementById('reg-nama-sekolah').value = "";
      document.getElementById('reg-jenjang').value = "";
      document.getElementById('reg-email').value = "";
      document.getElementById('reg-password').value = "";

      setTimeout(() => {
        tampilHalaman('halaman-login');
      }, 2500);
    } else {
      showMessage('reg-message', response.message, true);
    }
  }
  
  function hasilHitung(response) {
    setLoading(false);
    let html = '';
    if (response.status === "sukses") {
      html = `
        <div class="message success" style="text-align: left; padding: 15px; display: block;">
          <p style="margin-top:0;"><strong>Mapel:</strong> ${response.mapel}</p>
          <p><strong>Rata-rata Rapor:</strong> ${response.nilaiRataRataRapor}</p>
          <p><strong>Rata-rata Ujian:</strong> ${response.nilaiRataRataUjian}</p>
          <h4 style="margin-bottom:0;">Nilai Akhir: ${response.nilaiAkhirIjazah}</h4>
        </div>
      `;
    } else {
      html = `<div class="message error" style="display: block;">${response.message}</div>`;
    }
    document.getElementById('hasil-hitung').innerHTML = html;
  }

  function onLogout(response) {
    setLoading(false);
    localStorage.removeItem('sessionToken');
    
    if (response.status === "sukses") {
      tampilHalaman('halaman-login');
    } else {
      showInfoModal("Gagal Logout", response.message, true); 
    }
  }

  function onGagal(error) {
    setLoading(false);
    const errorMsg = error.message;

    if (errorMsg.includes("Sesi") || errorMsg.includes("Token")) {
      localStorage.removeItem('sessionToken');
      tampilHalaman('halaman-login');
      showMessage('login-error', errorMsg, true);
    }
    else if (document.getElementById('halaman-login').style.display !== 'none') {
      showMessage('login-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-registrasi').style.display !== 'none') {
      showMessage('reg-message', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('mapel-modal').style.display !== 'none') {
      showMessage('modal-mapel-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-data-sekolah').style.display !== 'none') {
      showMessage('data-sekolah-message', 'Error: ' + errorMsg, true);
    } 
    else if (document.getElementById('halaman-bobot').style.display !== 'none') { // [BARU]
      showMessage('bobot-message', 'Error: ' + errorMsg, true);
    } 
    else {
      // Fallback
      showInfoModal('Terjadi Error', errorMsg, true); 
    }
  }
  
  // ===========================================
  // FUNGSI & HANDLER MAPEL
  // ===========================================

  function bukaHalamanMapel() {
    tampilHalaman('halaman-mapel');
    setLoading(true);
    document.getElementById('mapel-table-container').innerHTML = "<p>Memuat data mapel...</p>";
    
    google.script.run
      .withSuccessHandler(onMapelLoaded)
      .withFailureHandler(onGagal)
      .getMapel();
  }

  function onMapelLoaded(response) {
    setLoading(false);
    const container = document.getElementById('mapel-table-container');
    
    if (response.status === "sukses") {
      let html = '<table class="mapel-table">';
      html += '<tr><th>Kode Mapel</th><th>Nama Mapel</th><th>Aksi</th></tr>';
      
      if (response.mapel.length === 0) {
        html += '<tr><td colspan="3" style="text-align: center;">Belum ada data mapel.</td></tr>';
      }
      
      response.mapel.forEach(mapel => {
        html += `
          <tr>
            <td>${mapel.id}</td>
            <td>${mapel.nama}</td>
            <td>
              <button class="btn-aksi btn-edit" data-id="${mapel.id}" data-nama="${mapel.nama}">Edit</button>
              <button class="btn-aksi btn-delete" data-id="${mapel.id}">Hapus</button>
            </td>
          </tr>
        `;
      });
      
      html += '</table>';
      container.innerHTML = html;
    } else {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat mapel: ${response.message}</p>`;
    }
  }

  function showModalMapel(mode, id = '', nama = '') {
    document.getElementById('modal-mapel-mode').value = mode;
    hideMessage('modal-mapel-error');
    
    const idInput = document.getElementById('modal-mapel-id');
    
    if (mode === 'add') {
      document.getElementById('modal-title').innerText = "Tambah Mapel Baru";
      idInput.value = "";
      idInput.readOnly = false;
      document.getElementById('modal-mapel-nama').value = "";
    } 
    else if (mode === 'edit') {
      document.getElementById('modal-title').innerText = "Edit Mapel";
      idInput.value = id;
      idInput.readOnly = true;
      document.getElementById('modal-mapel-nama').value = nama;
    }
    
    document.getElementById('mapel-modal').style.display = 'block';
  }

  function tutupModalMapel() {
    document.getElementById('mapel-modal').style.display = 'none';
  }

  function simpanMapel() {
    setLoading(true);
    hideMessage('modal-mapel-error');
    
    const mode = document.getElementById('modal-mapel-mode').value;
    const id = document.getElementById('modal-mapel-id').value;
    const nama = document.getElementById('modal-mapel-nama').value;
    
    if (mode === 'add') {
      google.script.run
        .withSuccessHandler(onMapelSaved)
        .withFailureHandler(onGagal)
        .createMapel(id, nama);
    } else { // Asumsi mode 'edit'
      google.script.run
        .withSuccessHandler(onMapelSaved)
        .withFailureHandler(onGagal)
        .updateMapel(id, nama);
    }
  }

  function hapusMapel(id) {
    const title = "Konfirmasi Hapus";
    const message = `Yakin ingin menghapus mapel dengan ID: <strong>${id}</strong>?<br><br><strong>PERINGATAN:</strong> Menghapus mapel yang sudah memiliki nilai dapat merusak data.`;
    
    const callback = function() {
      setLoading(true);
      google.script.run
        .withSuccessHandler(onMapelSaved)
        .withFailureHandler(onGagal)
        .deleteMapel(id);
    };
    
    showConfirmationModal(title, message, callback, 'danger');
  }

  /**
   * [CALLBACK] Dipanggil setelah sinkronisasi atau hapus semua.
   * Menampilkan pesan dan memuat ulang tabel.
   */
  function onTableRefreshed(response) {
    setLoading(false); 
    
    if (response.status === "sukses") {
      if (response.message) {
        showInfoModal("Sukses", response.message, false, bukaHalamanMapel);
      } else {
        bukaHalamanMapel();
      }
    } else {
      showInfoModal("Error", response.message, true, null);
    }
  }

  function onMapelSaved(response) {
    setLoading(false); 
    
    if (response.status === "sukses") {
      tutupModalMapel();
      bukaHalamanMapel(); // Muat ulang data tabel
    } else {
      showMessage('modal-mapel-error', response.message, true);
    }
  }


  // ===========================================
  // FUNGSI & HANDLER DATA SEKOLAH
  // ===========================================

  /**
   * Membuka halaman kelola data sekolah dan memuat data.
   */
  function bukaHalamanDataSekolah() {
    tampilHalaman('halaman-data-sekolah');
    setLoading(true);
    hideMessage('data-sekolah-message');
    document.getElementById('form-data-sekolah').reset(); // Bersihkan form
    
    google.script.run
      .withSuccessHandler(onDataSekolahLoaded)
      .withFailureHandler(onGagal)
      .getSchoolData();
  }

  /**
   * [CALLBACK] Menampilkan data sekolah di form setelah dimuat.
   */
  function onDataSekolahLoaded(response) {
    setLoading(false);
    if (response.status !== 'sukses') {
      showMessage('data-sekolah-message', response.message, true);
      return;
    }
    
    const data = response.data;
    
    // Simpan jenjang base di cache
    jenjangBaseCache = data.jenjangBase;
    
    // 1. Isi Pilihan Jenjang
    populateSelectJenjang(data.jenjangBase, data.jenjangPilihan);
    
    // 2. Isi semua field form
    document.getElementById('data-nama-sekolah').value = data.namaSekolah;
    document.getElementById('data-npsn').value = data.npsn || '';
    document.getElementById('data-nsm').value = data.nsm || '';
    document.getElementById('data-alamat').value = data.alamat || '';
    document.getElementById('data-provinsi').value = data.provinsi || '';
    document.getElementById('data-kabkot').value = data.kabKot || '';
    document.getElementById('data-pilihan-kabkot').value = data.pilihanKabKot || 'Kabupaten';
    document.getElementById('data-kecamatan').value = data.kecamatan || '';
    document.getElementById('data-keldes').value = data.kelDes || '';
    document.getElementById('data-pilihan-keldes').value = data.pilihanKelDes || 'Kelurahan';
    document.getElementById('data-kodepos').value = data.kodePos || '';
    document.getElementById('data-telepon').value = data.telepon || '';
    document.getElementById('data-email').value = data.email || '';
    document.getElementById('data-website').value = data.website || '';
    document.getElementById('data-kepsek').value = data.namaKepsek || '';
    document.getElementById('data-nip-kepsek').value = data.nipKepsek || '';
    
    // 3. Jalankan logika NSM
    updateTampilanNSM();
  }

  /**
   * [HELPER] Mengisi dropdown jenjang berdasarkan jenjang dasar.
   */
  function populateSelectJenjang(jenjangBase, selectedValue) {
    const select = document.getElementById('data-jenjang-pilihan');
    select.innerHTML = ''; // Kosongkan dulu
    
    let options = [];
    if (jenjangBase === 'SD/MI') {
      options = ['SD', 'MI'];
    } else if (jenjangBase === 'SMP/MTS') {
      options = ['SMP', 'MTS'];
    } else if (jenjangBase === 'SMA/MA') {
      options = ['SMA', 'MA'];
    } else {
      options = [jenjangBase]; // Fallback
    }

    select.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
    options.forEach(opt => {
      select.innerHTML += `<option value="${opt}">${opt}</option>`;
    });

    // Set nilai yang tersimpan
    if (selectedValue) {
      select.value = selectedValue;
    }
  }

  /**
   * [HELPER] Mengatur tampilan & label field NSM berdasarkan jenjang.
   */
  function updateTampilanNSM() {
    const jenjangPilihan = document.getElementById('data-jenjang-pilihan').value;
    const grupNSM = document.getElementById('grup-nsm');
    const labelNSM = grupNSM.querySelector('label');
    
    if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
      labelNSM.innerText = 'NSM (Wajib)';
    } else {
      labelNSM.innerText = 'NSM (Opsional)';
    }
  }

  /**
   * [UPDATE] Mengumpulkan, memvalidasi, dan mengirim data sekolah untuk disimpan.
   * Logika validasi diubah menjadi dinamis.
   */
  function simpanDataSekolah() {
    setLoading(true);
    hideMessage('data-sekolah-message');

    // 1. Kumpulkan data
    const dataToSave = {
      jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
      npsn: document.getElementById('data-npsn').value.trim(),
      nsm: document.getElementById('data-nsm').value.trim(),
      alamat: document.getElementById('data-alamat').value.trim(),
      provinsi: document.getElementById('data-provinsi').value.trim(),
      kabKot: document.getElementById('data-kabkot').value.trim(),
      pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
      kecamatan: document.getElementById('data-kecamatan').value.trim(),
      kelDes: document.getElementById('data-keldes').value.trim(),
      pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
      kodePos: document.getElementById('data-kodepos').value.trim(),
      telepon: document.getElementById('data-telepon').value.trim(),
      email: document.getElementById('data-email').value.trim(),
      website: document.getElementById('data-website').value.trim(),
      namaKepsek: document.getElementById('data-kepsek').value.trim(),
      nipKepsek: document.getElementById('data-nip-kepsek').value.trim()
    };
    
    // 2. [UPDATE] Validasi Dinamis
    const errors = [];
    if (!dataToSave.jenjangPilihan) {
      errors.push("Jenjang");
    }
    if (!dataToSave.npsn) {
      errors.push("NPSN");
    }
    if (!dataToSave.alamat) {
      errors.push("Alamat Sekolah");
    }
    if (!dataToSave.namaKepsek) {
      errors.push("Nama Kepala Sekolah");
    }
    
    // Validasi NSM (kondisional)
    const isMadrasah = (dataToSave.jenjangPilihan === 'MI' || dataToSave.jenjangPilihan === 'MTS' || dataToSave.jenjangPilihan === 'MA');
    if (isMadrasah && !dataToSave.nsm) {
      errors.push("NSM (wajib untuk Madrasah)");
    }

    // 3. Tampilkan error jika ada
    if (errors.length > 0) {
      setLoading(false);
      const errorMessage = "Field (Wajib) tidak boleh kosong: " + errors.join(', ') + ".";
      showMessage('data-sekolah-message', errorMessage, true);
      return;
    }

    // 4. Kirim ke server (jika tidak ada error)
    google.script.run
      .withSuccessHandler(onDataSekolahSaved)
      .withFailureHandler(onGagal)
      .saveSchoolData(dataToSave);
  }

  /**
   * [CALLBACK] Menampilkan pesan sukses/gagal setelah menyimpan.
   */
  function onDataSekolahSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('data-sekolah-message', 'Data sekolah berhasil disimpan!', false); // false = sukses
    } else {
      showMessage('data-sekolah-message', response.message, true);
    }
  }


  // ===========================================
  // [BARU] FUNGSI & HANDLER BOBOT NILAI
  // ===========================================

  /**
   * [HELPER] Sinkronisasi input bobot agar total 100%.
   */
  function sinkronkanBobot(sumber) {
    const inputRapor = document.getElementById('bobot-rapor');
    const inputUjian = document.getElementById('bobot-ujian');
    
    let nilaiRapor = parseInt(inputRapor.value, 10);
    let nilaiUjian = parseInt(inputUjian.value, 10);
    
    if (sumber === 'rapor') {
      if (isNaN(nilaiRapor)) {
        inputUjian.value = '';
        return;
      }
      if (nilaiRapor > 100) {
        nilaiRapor = 100;
        inputRapor.value = 100;
      }
      if (nilaiRapor < 0) {
         nilaiRapor = 0;
         inputRapor.value = 0;
      }
      inputUjian.value = 100 - nilaiRapor;
    } else if (sumber === 'ujian') {
      if (isNaN(nilaiUjian)) {
        inputRapor.value = '';
        return;
      }
      if (nilaiUjian > 100) {
        nilaiUjian = 100;
        inputUjian.value = 100;
      }
      if (nilaiUjian < 0) {
         nilaiUjian = 0;
         inputUjian.value = 0;
      }
      inputRapor.value = 100 - nilaiUjian;
    }
  }

  /**
   * Membuka halaman kelola bobot dan memuat data.
   */
  function bukaHalamanBobot() {
    tampilHalaman('halaman-bobot');
    setLoading(true);
    hideMessage('bobot-message');
    document.getElementById('form-bobot').reset(); // Bersihkan form
    
    google.script.run
      .withSuccessHandler(onBobotLoaded)
      .withFailureHandler(onGagal)
      .getBobotData(); // Fungsi backend baru
  }

  /**
   * [CALLBACK] Menampilkan data bobot di form setelah dimuat.
   */
  function onBobotLoaded(response) {
    setLoading(false);
    if (response.status !== 'sukses') {
      showMessage('bobot-message', response.message, true);
      return;
    }
    document.getElementById('bobot-rapor').value = response.bobotRapor;
    document.getElementById('bobot-ujian').value = response.bobotUjian;
  }

  /**
   * Mengumpulkan dan mengirim data bobot untuk disimpan.
   */
  function simpanBobot() {
    setLoading(true);
    hideMessage('bobot-message');
    
    const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
    const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;
    
    if ((bobotRapor + bobotUjian) !== 100) {
      setLoading(false);
      showMessage('bobot-message', 'Total bobot harus 100%. Silakan periksa kembali isian Anda.', true);
      return;
    }
    
    google.script.run
      .withSuccessHandler(onBobotSaved)
      .withFailureHandler(onGagal)
      .saveBobotData(bobotRapor, bobotUjian); // Fungsi backend baru
  }
  
  /**
   * [CALLBACK] Menampilkan pesan sukses/gagal setelah menyimpan.
   */
  function onBobotSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('bobot-message', 'Data bobot berhasil disimpan!', false); // false = sukses
    } else {
      showMessage('bobot-message', response.message, true);
    }
  }

</script>
