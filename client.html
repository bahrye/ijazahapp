<script>
  // Variabel global
  let jenjangBaseCache = '';
  let jenjangPilihanCache = ''; // [BARU] Simpan jenjang spesifik (MI, SD, dll)
  const LAST_PAGE_KEY = 'lastVisitedPageId'; // Kunci untuk localStorage
  let siswaTelahDiImport = false; // [BARU] Flag untuk refresh tabel setelah import
  let globalSiswaList = []; // [BARU] Cache untuk daftar siswa
  let isSiswaOrderDirty = false; // [BARU] Flag jika ada urutan yg diubah
  let isMapelTipeDirty = false; // [BARU] Flag jika ada tipe ujian yg diubah
  let globalGridData = { // [BARU] Cache untuk data grid nilai
    siswaList: [],
    mapelList: [],
    nilaiData: {}
  };

  // ===========================================
  // FUNGSI UTILITAS
  // ===========================================

  /**
   * Menampilkan atau menyembunyikan spinner loading.
   */
  function setLoading(isLoading) {
    document.getElementById('loader').style.display = isLoading ? 'flex' : 'none';
  }

  /**
   * [BARU] Mengubah string menjadi Proper Case (Title Case).
   * Contoh: "SYAMSUL BAHRI" menjadi "Syamsul Bahri".
   */
  function toProperCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
  }

  /**
   * [BARU] Memformat nama siswa agar 2 kata di baris pertama.
   * Contoh: "Muhammad Adrian Kurniawan" menjadi "Muhammad Adrian<br>Kurniawan".
   */
  function formatNamaSiswa(namaLengkap) {
    if (!namaLengkap) return '';
    const parts = namaLengkap.split(' ');
    if (parts.length >= 3) {
      const barisSatu = parts.slice(0, 2).join(' ');
      const barisDua = parts.slice(2).join(' ');
      // [DIUBAH] Tambahkan span dengan "white-space: nowrap" 
      // agar 2 kata pertama tidak dipisah oleh browser
      return `<span style="white-space: nowrap;">${barisSatu}</span><br>${barisDua}`;
    }
    return namaLengkap; // Kembalikan nama asli jika 1 atau 2 kata
  }

  /**
   * Menampilkan pesan error atau sukses.
   */
  function showMessage(elementId, message, isError) {
    if (typeof isError === 'undefined' || isError === null) {
      isError = true;
    }

    const el = document.getElementById(elementId);
    if (!el) return; // [BARU] Pengaman jika elemen tidak ada

    el.innerText = message;
    el.className = isError ? 'message error' : 'message success';
    el.style.display = 'block';

    // [BARU] Sembunyikan pesan sukses/info secara otomatis setelah 3 detik
    if (!isError) {
      setTimeout(() => {
        // Cek lagi jika elemen masih ada sebelum disembunyikan
        const currentEl = document.getElementById(elementId);
        if (currentEl) {
           hideMessage(elementId);
        }
      }, 3000); // 3000ms = 3 detik
    }
  }

  /**
   * Menyembunyikan pesan error/sukses.
   */
  function hideMessage(elementId) {
    const el = document.getElementById(elementId);
    if(el) {
      el.style.display = 'none';
      el.innerText = '';
    }
  }

  /**
   * Mengatur halaman mana yang terlihat (Single Page App).
   * Menyimpan halaman terakhir ke localStorage.
   */
  function tampilHalaman(idHalaman) {
    const allPages = [
      'auth-container', 'halaman-utama', 'halaman-mapel',
      'halaman-data-sekolah', 'halaman-bobot', 'halaman-kelas', 'halaman-siswa',
      'halaman-input-ujian', 'halaman-input-nilai-detail'
    ];
    const authSubPages = ['halaman-login', 'halaman-registrasi'];

    // Sembunyikan semua container utama & pesan error
    allPages.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    hideMessage('login-error');
    hideMessage('reg-message');
    hideMessage('data-sekolah-message');
    hideMessage('bobot-message');
    hideMessage('kelas-message');
    hideMessage('siswa-message');
    hideMessage('input-nilai-message');
    hideMessage('mapel-message');

    // Tentukan halaman yang akan ditampilkan
    const targetElement = document.getElementById(idHalaman);
    if (targetElement) {
        if (authSubPages.includes(idHalaman)) {
            // Jika halaman login/registrasi, tampilkan auth-container dan sub-halaman
            document.getElementById('auth-container').style.display = 'block';
            // Sembunyikan semua sub-halaman auth dulu
            authSubPages.forEach(subId => {
                const subEl = document.getElementById(subId);
                if (subEl) subEl.style.display = 'none';
            });
            targetElement.style.display = 'block';
            // Hapus halaman terakhir saat kembali ke login/reg
            localStorage.removeItem(LAST_PAGE_KEY);
        } else {
            // Jika halaman utama atau sub-halaman dashboard
            targetElement.style.display = 'block';
            // Simpan halaman ini sebagai halaman terakhir yang dikunjungi
            localStorage.setItem(LAST_PAGE_KEY, idHalaman);
        }
    } else {
        // Fallback jika ID tidak ditemukan (misalnya saat load pertama kali tanpa last page)
        console.warn("Halaman tidak ditemukan:", idHalaman, ". Menampilkan dashboard.");
        document.getElementById('halaman-utama').style.display = 'block';
        localStorage.setItem(LAST_PAGE_KEY, 'halaman-utama');
    }
  }


  /**
   * Helper untuk menonaktifkan/mengaktifkan semua input dalam form.
   */
  function setFormDisabled(formId, isDisabled) {
    const form = document.getElementById(formId);
    if (!form) return;

    // Ambil semua elemen input, select, textarea
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      // Khusus untuk 'data-nama-sekolah', jangan ubah properti 'disabled' aslinya
      // karena 'data-nama-sekolah' memang selalu disabled
      if (input.id !== 'data-nama-sekolah') {
        input.disabled = isDisabled;
      }
    });

    // Ambil tombol simpan (asumsi tombol submit)
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = isDisabled;
    }
  }

  /**
   * Menampilkan modal konfirmasi kustom.
   */
  function showConfirmationModal(title, message, onConfirmCallback, okButtonType = 'danger') {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-body').innerHTML = message; // innerHTML agar tag <strong> terbaca

    const okButton = document.getElementById('btn-confirm-ok');

    // Atur warna tombol OK
    if (okButtonType === 'danger') {
      okButton.style.backgroundColor = 'var(--danger-color)';
    } else {
      okButton.style.backgroundColor = 'var(--primary-color)';
    }

    // Simpan fungsi callback di elemen modal untuk dipanggil nanti
    modal.onConfirm = onConfirmCallback;

    modal.style.display = 'block';
  }

  /**
   * Menutup modal konfirmasi.
   */
  function hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.style.display = 'none';
    modal.onConfirm = null; // Hapus callback setelah ditutup
  }

  /**
   * Menampilkan modal info kustom (pengganti alert).
   */
  function showInfoModal(title, message, isError, onOkCallback) {
    const modal = document.getElementById('info-modal');
    document.getElementById('info-modal-title').innerText = title;

    const modalBody = document.getElementById('info-modal-body');
    modalBody.innerHTML = message; // [DIUBAH] Gunakan innerHTML agar tag <strong> terbaca

    if (isError) {
      modalBody.classList.add('error');
    } else {
      modalBody.classList.remove('error');
    }

    // Simpan callback di elemen modal
    modal.onOk = onOkCallback || null;

    modal.style.display = 'block';
  }

  /**
   * Menutup modal info.
   */
  function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    modal.style.display = 'none';

    // Periksa dan jalankan callback JIKA ADA
    if (typeof modal.onOk === 'function') {
      modal.onOk(); // Jalankan callback
    }
    modal.onOk = null; // Hapus callback setelah dijalankan
  }

  /**
  * Helper untuk membuka halaman berdasarkan ID tersimpan.
  */
  function bukaHalamanTersimpan(pageId) {
    switch (pageId) {
        case 'halaman-utama':
            tampilHalaman('halaman-utama');
            break; // Dashboard tidak perlu load data awal
        case 'halaman-mapel':
            bukaHalamanMapel();
            break;
        case 'halaman-data-sekolah':
            bukaHalamanDataSekolah();
            break;
        case 'halaman-bobot':
            bukaHalamanBobot();
            break;
        case 'halaman-kelas':
            bukaHalamanKelas();
            break;
        case 'halaman-siswa':
            bukaHalamanSiswa();
            break;
        case 'halaman-input-ujian':
            bukaHalamanInputUjian();
            break;
        case 'halaman-input-nilai-detail':
            // Jika di-refresh, kembalikan ke menu input, bukan halaman detail
            bukaHalamanInputUjian(); 
            break;
        default:
            console.warn("ID halaman tersimpan tidak valid:", pageId, ". Menampilkan dashboard.");
            tampilHalaman('halaman-utama'); // Fallback ke dashboard
            break;
    }
  }

  /**
   * [BARU] Mengatur status "dirty" mapel dan mengaktifkan/menonaktifkan tombol simpan
   */
  function setMapelTipeDirty(isDirty) {
    isMapelTipeDirty = isDirty;
    const btnSimpan = document.getElementById('btn-simpan-tipe-ujian');
    if (btnSimpan) {
      btnSimpan.disabled = !isDirty;
    }
  }

  // ===========================================
  // EVENT LISTENERS
  // ===========================================

  document.addEventListener('DOMContentLoaded', (event) => {

    // Listener Tombol Login
    document.getElementById('btn-login').addEventListener('click', () => {
      setLoading(true);
      hideMessage('login-error');
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      google.script.run
        .withSuccessHandler(hasilLogin)
        .withFailureHandler(onGagal)
        .prosesLogin(email, pass);
    });

    // Listener Tombol Registrasi
    document.getElementById('btn-registrasi').addEventListener('click', () => {
      setLoading(true);
      hideMessage('reg-message');

      const namaSekolah = document.getElementById('reg-nama-sekolah').value.toUpperCase();
      const jenjang = document.getElementById('reg-jenjang').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      if (!namaSekolah || !jenjang || !email || !password) {
        setLoading(false);
        showMessage('reg-message', "Semua field wajib diisi.", true);
        return;
      }

      google.script.run
        .withSuccessHandler(hasilRegistrasi)
        .withFailureHandler(onGagal)
        .prosesRegistrasi(namaSekolah, jenjang, email, password);
    });

    // Listener Tombol Logout
    document.getElementById('btn-logout').addEventListener('click', () => {
      setLoading(true);
      google.script.run
        .withSuccessHandler(onLogout)
        .withFailureHandler(onGagal)
        .prosesLogout();
    });

    // Listener untuk link "Daftar di sini"
    document.getElementById('link-ke-registrasi').addEventListener('click', (e) => {
      e.preventDefault();
      tampilHalaman('halaman-registrasi');
    });

    // Listener untuk link "Login"
    document.getElementById('link-ke-login').addEventListener('click', (e) => {
      e.preventDefault();
      tampilHalaman('halaman-login');
    });
    // Form submit listeners
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      document.getElementById('btn-login').click();
    });

    document.getElementById('reg-form').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Toggle password listeners
    document.getElementById('toggle-login-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggle-reg-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });


    // --- Listener Tombol Menu Dashboard & Kembali ---
    // Listener untuk tombol 'Kelola Data Sekolah'
    document.getElementById('btn-buka-data-sekolah').addEventListener('click', () => {
      bukaHalamanDataSekolah();
    });
    document.getElementById('btn-kembali-ke-dashboard-2').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // Listener untuk tombol 'Kelola Bobot'
    document.getElementById('btn-buka-bobot').addEventListener('click', () => {
      bukaHalamanBobot();
    });
    document.getElementById('btn-kembali-ke-dashboard-3').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // Listener untuk tombol 'Kelola Kelas'
    document.getElementById('btn-buka-kelas').addEventListener('click', () => {
      bukaHalamanKelas();
    });
    document.getElementById('btn-kembali-ke-dashboard-4').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // Listener untuk tombol 'Kelola Siswa'
    document.getElementById('btn-buka-siswa').addEventListener('click', () => {
      bukaHalamanSiswa();
    });
    document.getElementById('btn-kembali-ke-dashboard-5').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // [BARU] Listener untuk Halaman Input Nilai
    document.getElementById('btn-buka-input-ujian').addEventListener('click', () => {
      bukaHalamanInputUjian();
    });
    document.getElementById('btn-kembali-ke-dashboard-6').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });
    document.getElementById('btn-kembali-ke-input-ujian').addEventListener('click', () => {
      bukaHalamanInputUjian();
    });

    // [BARU] Listener untuk 2 kartu di halaman input ujian
    document.getElementById('btn-buka-input-um').addEventListener('click', () => {
      // 'UM' = Ujian Madrasah/Sekolah
      bukaHalamanInputNilaiDetail('UM'); 
    });
    document.getElementById('btn-buka-input-praktek').addEventListener('click', () => {
      // 'Praktek' = Ujian Praktek
      bukaHalamanInputNilaiDetail('Praktek'); 
    });

    // [BARU] Listener untuk tombol simpan nilai (akan kita buat fungsinya di bawah)
    document.getElementById('btn-simpan-input-nilai').addEventListener('click', simpanInputNilai);

    // [BARU] Listener untuk menghitung Jumlah/Rata-rata secara real-time
    document.getElementById('halaman-input-nilai-detail').addEventListener('input', (e) => {
      // Jika yang di-input adalah kotak .input-nilai
      if (e.target.classList.contains('input-nilai')) {
        const siswaId = e.target.dataset.siswaId;
        const table = e.target.closest('.input-nilai-table');
        
        // Hitung jumlah mapel dari header tabel
        const mapelCount = table.querySelectorAll('th.col-mapel').length;
        
        // Panggil fungsi kalkulasi
        updateRowTotals(siswaId, mapelCount);
      }
    });

    // [BARU] Listener untuk klik nama siswa (menampilkan NISN)
    document.getElementById('halaman-input-nilai-detail').addEventListener('click', (e) => {
      // Cek apakah yang diklik adalah elemen nama
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        const namaLengkap = targetNama.dataset.namaLengkap; 
        
        const title = `Info Siswa: ${toProperCase(namaLengkap)}`;
        const message = `NISN untuk siswa ini adalah:\n<strong>${nisn}</strong>`;
        
        // Panggil modal info yang sudah ada
        showInfoModal(title, message, false, null); // false = bukan error
      }
    });

    // [BARU] Listener untuk filter di halaman input nilai
    document.getElementById('input-nilai-filter-kelas').addEventListener('change', renderNilaiGridTable); // Panggil fungsi render ulang

    // Listener untuk tombol 'Kelola Mapel'
    document.getElementById('btn-buka-mapel').addEventListener('click', () => {
      bukaHalamanMapel();
    });
     document.getElementById('btn-kembali-ke-dashboard').addEventListener('click', () => {
      tampilHalaman('halaman-utama');
    });

    // Listener untuk simpan form data sekolah
    document.getElementById('form-data-sekolah').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanDataSekolah();
    });
    document.getElementById('data-jenjang-pilihan').addEventListener('change', updateTampilanNSM);

    // Listener form bobot
    document.getElementById('form-bobot').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanBobot();
    });
    document.getElementById('bobot-rapor').addEventListener('input', () => { sinkronkanBobot('rapor'); });
    document.getElementById('bobot-ujian').addEventListener('input', () => { sinkronkanBobot('ujian'); });

    // Listener form kelas
    document.getElementById('form-kelas').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanKelas();
    });
    document.getElementById('kelas-list-container').addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('btn-add-kelas')) {
        const list = getCurrentKelasList();
        list.push('');
        renderKelasList(list);
        document.querySelector('#kelas-list-container .kelas-input-row:last-child input').focus();
      }
      else if (target.classList.contains('btn-remove-kelas')) {
        const rowToRemove = target.parentElement;
        const list = getCurrentKelasList();
        const allRows = Array.from(document.querySelectorAll('#kelas-list-container .kelas-input-row'));
        const indexToRemove = allRows.indexOf(rowToRemove);
        if (indexToRemove > -1) { list.splice(indexToRemove, 1); }
        renderKelasList(list);
      }
    });

    // Listener fitur siswa
     document.getElementById('btn-import-siswa').addEventListener('click', bukaModalImportSiswa); // [BARU]
     document.getElementById('btn-tambah-siswa-baru').addEventListener('click', () => { showModalSiswa('add', {}); });
     document.getElementById('btn-hapus-semua-siswa').addEventListener('click', hapusSemuaSiswa);
     document.getElementById('btn-simpan-siswa').addEventListener('click', simpanSiswa);
     document.getElementById('btn-tutup-modal-siswa').addEventListener('click', tutupModalSiswa);
     document.getElementById('btn-batal-modal-siswa').addEventListener('click', tutupModalSiswa);
     document.getElementById('siswa-table-container').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-siswa')) {
          const dataset = target.dataset;
          const siswaData = { id: dataset.id, nama: dataset.nama, nisn: dataset.nisn, nisLokal: dataset.nisLokal, jk: dataset.jk, tempatLahir: dataset.tempatLahir, tglLahir: dataset.tglLahir, kelas: dataset.kelas };
          showModalSiswa('edit', siswaData);
      
      } else if (target.classList.contains('btn-delete-siswa')) {
          const id = target.getAttribute('data-id');
          const nama = target.getAttribute('data-nama');
          hapusSiswa(id, nama);
      
      } 
      // [LOGIKA BARU - INSTAN]
      else if (target.classList.contains('btn-move-up') || target.classList.contains('btn-move-down')) {
          
          const siswaID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up') ? 'up' : 'down';

          // 1. Cari siswa yang diklik di data global
          const targetSiswa = globalSiswaList.find(s => s.id === siswaID);
          if (!targetSiswa) return;

          // 2. Dapatkan "teman sekelas" dia, urutkan sesuai urutan saat ini
          const classmates = globalSiswaList
                              .filter(s => s.kelas === targetSiswa.kelas)
                              .sort((a,b) => a.urutan - b.urutan);
          
          // 3. Cari posisinya di dalam kelas
          const targetIndexInClass = classmates.findIndex(s => s.id === siswaID);

          // 4. Tentukan siswa yang akan ditukar
          let swapSiswa = null;
          if (direction === 'up' && targetIndexInClass > 0) {
            swapSiswa = classmates[targetIndexInClass - 1];
          } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
            swapSiswa = classmates[targetIndexInClass + 1];
          }

          // 5. Lakukan penukaran (swap) nilai 'urutan'
          if (swapSiswa) {
            const tempUrutan = targetSiswa.urutan;
            targetSiswa.urutan = swapSiswa.urutan;
            swapSiswa.urutan = tempUrutan;
            
            // 6. Set status "dirty"
            setSiswaOrderDirty(true);
            
            // 7. Render ulang tabel (instan!)
            applySiswaFiltersAndRender();
          }
      }
    });

    // [BARU] Listener untuk filter/sort siswa
    document.getElementById('siswa-filter-kelas').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('siswa-sort-by').addEventListener('change', applySiswaFiltersAndRender);

    // [BARU] Listener untuk simpan urutan siswa
    document.getElementById('btn-simpan-urutan-siswa').addEventListener('click', () => {
      setLoading(true);
      hideMessage('siswa-message');
      
      // Buat array 'ringan' berisi {id, urutan} dari data global
      const urutanData = globalSiswaList.map(siswa => {
        return { id: siswa.id, urutan: siswa.urutan };
      });
      
      google.script.run
        .withSuccessHandler(onSiswaUrutanSaved)
        .withFailureHandler(onGagal)
        .saveSiswaUrutanBatch(urutanData); // Panggil fungsi batch baru
    });

    // Listener fitur mapel
    document.getElementById('btn-ambil-default').addEventListener('click', () => {
        const title = "Ambil Mapel Default";
        const message = "Ini akan mengambil mapel default dari master dan menambahkan yang hilang. Lanjutkan?";
        const callback = function() { setLoading(true); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).syncDefaultMapel(); };
        showConfirmationModal(title, message, callback, 'primary');
    });
    document.getElementById('btn-hapus-semua').addEventListener('click', () => {
        const title = "PERINGATAN!";
        const message = "Anda yakin ingin menghapus <strong>SEMUA</strong> mata pelajaran? Tindakan ini tidak bisa dibatalkan.";
        const callback = function() { setLoading(true); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).deleteAllMapel(); };
        showConfirmationModal(title, message, callback, 'danger');
    });
    document.getElementById('btn-tambah-mapel-baru').addEventListener('click', () => { showModalMapel('add'); });
    document.getElementById('btn-tutup-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-batal-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-simpan-mapel').addEventListener('click', simpanMapel);
    // [BARU] Tambahkan listener untuk tombol simpan tipe ujian
    document.getElementById('btn-simpan-tipe-ujian').addEventListener('click', simpanTipeUjian);

    // [DIUBAH] Modifikasi listener 'mapel-table-container'
    // 1. Ubah listener dari 'click' ke 'change' untuk checkbox
    document.getElementById('mapel-table-container').addEventListener('change', (e) => {
        if (e.target.classList.contains('mapel-tipe-cek')) {
          setMapelTipeDirty(true);
        }
    });

    // 2. Buat listener 'click' HANYA untuk tombol (edit/delete)
    document.getElementById('mapel-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button'); // Hanya cari tombol
        if (!target) return;
        
        if (target.classList.contains('btn-edit')) {
            const id = target.getAttribute('data-id');
            const nama = target.getAttribute('data-nama');
            showModalMapel('edit', id, nama);
        } else if (target.classList.contains('btn-delete')) {
            const id = target.getAttribute('data-id');
            hapusMapel(id);
        }
    });

    // Listener modal konfirmasi & info
    document.getElementById('btn-confirm-cancel').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-close').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-ok').addEventListener('click', () => {
        const modal = document.getElementById('confirmation-modal');
        if (typeof modal.onConfirm === 'function') { modal.onConfirm(); }
        hideConfirmationModal();
    });
    document.getElementById('btn-info-close').addEventListener('click', hideInfoModal);
    document.getElementById('btn-info-ok').addEventListener('click', hideInfoModal);

    // [BARU] Listener untuk modal import siswa
    document.getElementById('btn-tutup-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-batal-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-download-template-siswa').addEventListener('click', downloadTemplateSiswa);
    document.getElementById('btn-proses-import-siswa').addEventListener('click', prosesImportFileSiswa);

    // [BARU] Listener canggih untuk File Upload Zone
    const fileUploadZone = document.getElementById('file-upload-zone');
    const fileUploadInput = document.getElementById('file-upload-siswa');
    const fileUploadText = document.getElementById('file-upload-text');
    const btnProsesImport = document.getElementById('btn-proses-import-siswa');

    // 1. Saat file dipilih (baik diklik atau di-drag)
    fileUploadInput.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadText.innerText = `File dipilih: ${fileName}`;
                fileUploadText.classList.add('file-chosen');
                btnProsesImport.disabled = false;
                hideMessage('template-message');
            } else {
                fileUploadText.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadText.classList.remove('file-chosen');
                btnProsesImport.disabled = true;
            }
        } else {
            fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadText.classList.remove('file-chosen');
            btnProsesImport.disabled = true;
        }
    });

    // 2. Efek visual Drag & Drop
    fileUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault(); // Wajib untuk mengizinkan 'drop'
        fileUploadZone.classList.add('drag-over');
    });

    fileUploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
    });

    fileUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
        
        // Ambil file dari event drop dan masukkan ke input
        if (e.dataTransfer.files.length > 0) {
          fileUploadInput.files = e.dataTransfer.files;
          // Picu event 'change' secara manual agar logika di atas berjalan
          const changeEvent = new Event('change');
          fileUploadInput.dispatchEvent(changeEvent);
        }
    });

    // === PEMERIKSAAN TOKEN & HALAMAN TERAKHIR SAAT LOAD ===
    const token = localStorage.getItem('sessionToken');
    const lastPageId = localStorage.getItem(LAST_PAGE_KEY);

    if (token) {
      // 1. Langsung tampilkan halaman terakhir (agar "instant")
      // Kita "percaya" token di localStorage untuk sementara.
      if (lastPageId) {
        bukaHalamanTersimpan(lastPageId);
      } else {
        tampilHalaman('halaman-utama'); // Default ke dashboard
      }
      
      // 2. Validasi token di background (tanpa loading spinner)
      // onTokenCheck akan me-refresh nama sekolah (jika sukses)
      // atau me-logout paksa (jika gagal/kedaluwarsa).
      google.script.run
        .withSuccessHandler(onTokenCheck) 
        .withFailureHandler(onTokenCheck) 
        .checkToken(token);
        
    } else {
      // Tidak ada token, tampilkan halaman login (ini sudah benar)
      tampilHalaman('halaman-login');
    }
  });


  // ===========================================
  // HANDLER (Callback Functions)
  // ===========================================

  /**
   * Menangani hasil pemeriksaan token saat load.
   * Akan navigasi ke halaman terakhir jika valid.
   */
  function onTokenCheck(response) {
    // setLoading(false); // Kita tidak menyalakan loading, jadi tidak perlu dimatikan.

    if (response.status === "sukses") {
      // Token valid, cukup perbarui nama sekolah.
      // Halaman sudah ditampilkan oleh logika DOMContentLoaded.
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan; // [BARU]
      
    } else {
      // Token tidak valid atau kedaluwarsa
      // Ini akan "menendang" pengguna kembali ke halaman login.
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY); // Hapus juga halaman terakhir
      tampilHalaman('halaman-login');
      
      // Tampilkan pesan error jika ada
      if(response.message) {
        showMessage('login-error', response.message, true);
      }
    }
  }

  function hasilLogin(response) {
    setLoading(false);
    if (response.status === "sukses") {
      // SIMPAN TOKEN ke localStorage
      localStorage.setItem('sessionToken', response.token);
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan; // [BARU]

      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      tampilHalaman('halaman-utama'); // tampilHalaman akan menyimpan 'halaman-utama'
    } else {
      showMessage('login-error', response.message, true);
    }
  }

  function hasilRegistrasi(response) {
    setLoading(false);
    if (response.status === "sukses") {
      showMessage('reg-message', response.message, false); // false = sukses

      document.getElementById('reg-nama-sekolah').value = "";
      document.getElementById('reg-jenjang').value = "";
      document.getElementById('reg-email').value = "";
      document.getElementById('reg-password').value = "";

      setTimeout(() => {
        tampilHalaman('halaman-login'); // tampilHalaman akan menghapus last page
      }, 2500);
    } else {
      showMessage('reg-message', response.message, true);
    }
  }

  /**
   * Menghapus halaman terakhir saat logout.
   */
  function onLogout(response) {
    setLoading(false);
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY); // Hapus halaman terakhir

    if (response.status === "sukses") {
      tampilHalaman('halaman-login'); // tampilHalaman akan menghapus last page lagi (redundant tapi aman)
    } else {
      showInfoModal("Gagal Logout", response.message, true);
    }
  }


  function onGagal(error) {
    setLoading(false);
    const errorMsg = error.message;

    if (errorMsg.includes("Sesi") || errorMsg.includes("Token")) {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY); // Hapus halaman terakhir juga
      tampilHalaman('halaman-login');
      showMessage('login-error', errorMsg, true);
    }
    else if (document.getElementById('halaman-login').style.display !== 'none') {
      showMessage('login-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-registrasi').style.display !== 'none') {
      showMessage('reg-message', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('mapel-modal').style.display !== 'none') {
      showMessage('modal-mapel-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('siswa-modal').style.display !== 'none') {
      showMessage('modal-siswa-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-data-sekolah').style.display !== 'none') {
      setFormDisabled('form-data-sekolah', false); // Aktifkan form saat gagal
      showMessage('data-sekolah-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-bobot').style.display !== 'none') {
      setFormDisabled('form-bobot', false); // Aktifkan form saat gagal
      showMessage('bobot-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-kelas').style.display !== 'none') {
      setFormDisabled('form-kelas', false); // Aktifkan form saat gagal
      showMessage('kelas-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-siswa').style.display !== 'none') {
      showMessage('siswa-message', 'Error: ' + errorMsg, true); // Halaman siswa tidak punya form utama yg perlu di-enable
    }
    // [BARU] Tambahkan penanganan error untuk halaman input nilai
    else if (document.getElementById('halaman-input-nilai-detail').style.display !== 'none') {
      showMessage('input-nilai-message', 'Error: ' + errorMsg, true);
    }
    else {
      // Fallback
      showInfoModal('Terjadi Error', errorMsg, true);
    }
  }

  // ===========================================
  // FUNGSI & HANDLER MAPEL
  // ===========================================

  function bukaHalamanMapel() {
    tampilHalaman('halaman-mapel'); // tampilHalaman akan menyimpan ID
    setMapelTipeDirty(false); // [BARU] Reset dirty flag
    document.getElementById('mapel-table-container').innerHTML = "<p>Memuat data mapel...</p>";

    google.script.run
      .withSuccessHandler(onMapelLoaded)
      .withFailureHandler(onGagal)
      .getMapel();
  }

  function onMapelLoaded(response) {
      const container = document.getElementById('mapel-table-container');

      if (response.status === "sukses") {
        // [BARU] Tentukan label US/UM
        const jenjangPilihan = jenjangPilihanCache;
        const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';

        let html = '<table class="mapel-table">';
        // [DIUBAH] Tambahkan 2 header kolom baru
        html += `<tr><th>Kode Mapel</th><th>Nama Mapel</th><th class="col-cek">${labelUjian}</th><th class="col-cek col-up">UP</th><th>Aksi</th></tr>`;

        if (response.mapel.length === 0) {
          // [DIUBAH] Colspan jadi 5
          html += '<tr><td colspan="5" style="text-align: center;">Belum ada data mapel.</td></tr>';
        }

        response.mapel.forEach(mapel => {
          // [BARU] Ambil status boolean
          const isUS = mapel.isUS || false;
          const isUP = mapel.isUP || false;
          
          html += `
            <tr>
              <td>${mapel.id}</td>
              <td>${mapel.nama}</td>
              <td class="col-cek">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="us" ${isUS ? 'checked' : ''}>
              </td>
              <td class="col-cek col-up">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="up" ${isUP ? 'checked' : ''}>
              </td>
              <td>
                <button class="btn-aksi btn-edit" data-id="${mapel.id}" data-nama="${mapel.nama}"><i class="fas fa-pencil-alt"></i>Edit</button>
                <button class="btn-aksi btn-delete" data-id="${mapel.id}"><i class="fas fa-trash-alt"></i>Hapus</button>
              </td>
            </tr>
          `;
        });

        html += '</table>';
        container.innerHTML = html;
      } else {
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat mapel: ${response.message}</p>`;
      }
  }

  function showModalMapel(mode, id = '', nama = '') {
      document.getElementById('modal-mapel-mode').value = mode;
      hideMessage('modal-mapel-error');

      const idInput = document.getElementById('modal-mapel-id');

      if (mode === 'add') {
        document.getElementById('modal-title').innerText = "Tambah Mapel Baru";
        idInput.value = "";
        idInput.readOnly = false;
        document.getElementById('modal-mapel-nama').value = "";
      }
      else if (mode === 'edit') {
        document.getElementById('modal-title').innerText = "Edit Mapel";
        idInput.value = id;
        idInput.readOnly = true;
        document.getElementById('modal-mapel-nama').value = nama;
      }

      document.getElementById('mapel-modal').style.display = 'block';
  }

  function tutupModalMapel() {
      document.getElementById('mapel-modal').style.display = 'none';
  }

  function simpanMapel() {
      setLoading(true);
      hideMessage('modal-mapel-error');

      const mode = document.getElementById('modal-mapel-mode').value;
      const id = document.getElementById('modal-mapel-id').value;
      const nama = document.getElementById('modal-mapel-nama').value;

      if (mode === 'add') {
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .createMapel(id, nama);
      } else { // Asumsi mode 'edit'
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .updateMapel(id, nama);
      }
  }

  function hapusMapel(id) {
      const title = "Konfirmasi Hapus";
      const message = `Yakin ingin menghapus mapel dengan ID: <strong>${id}</strong>?<br><br><strong>PERINGATAN:</strong> Menghapus mapel yang sudah memiliki nilai dapat merusak data.`;

      const callback = function() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(onMapelSaved)
          .withFailureHandler(onGagal)
          .deleteMapel(id);
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function onTableRefreshed(response) {
      setLoading(false);

      if (response.status === "sukses") {
        if (response.message) {
          showInfoModal("Sukses", response.message, false, bukaHalamanMapel);
        } else {
          bukaHalamanMapel();
        }
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function onMapelSaved(response) {
      setLoading(false);

      if (response.status === "sukses") {
        tutupModalMapel();
        bukaHalamanMapel(); // Muat ulang data tabel
      } else {
        showMessage('modal-mapel-error', response.message, true);
      }
  }

/**
   * [BARU] Mengumpulkan dan menyimpan semua status tipe ujian (checkbox).
   */
  function simpanTipeUjian() {
      setLoading(true);
      hideMessage('mapel-message');
      
      const allCheckboxes = document.querySelectorAll('#mapel-table-container .mapel-tipe-cek');
      const dataMap = new Map();

      // 1. Loop semua checkbox dan kumpulkan datanya per ID mapel
      allCheckboxes.forEach(checkbox => {
          const id = checkbox.dataset.id;
          const tipe = checkbox.dataset.tipe;
          const isChecked = checkbox.checked;

          // Jika mapel ini belum ada di Map, tambahkan
          if (!dataMap.has(id)) {
              dataMap.set(id, { id: id, isUS: false, isUP: false });
          }

          // Update data di Map
          const mapelData = dataMap.get(id);
          if (tipe === 'us') {
              mapelData.isUS = isChecked;
          } else if (tipe === 'up') {
              mapelData.isUP = isChecked;
          }
      });

      // 2. Ubah Map menjadi array
      const dataToSave = Array.from(dataMap.values());
      
      // 3. Kirim ke server
      google.script.run
        .withSuccessHandler(onMapelTipeUjianSaved)
        .withFailureHandler(onGagal)
        .saveMapelTipeUjianBatch(dataToSave); // Panggil fungsi batch baru
  }
  
  /**
   * [BARU] Callback setelah tipe ujian mapel berhasil disimpan
   */
  function onMapelTipeUjianSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setMapelTipeDirty(false); // Nonaktifkan tombol
      showMessage('mapel-message', 'Tipe ujian berhasil disimpan!', false);
    } else {
      // Biarkan tombol aktif agar user bisa mencoba lagi
      showMessage('mapel-message', response.message, true);
    }
  }

  // ===========================================
  // FUNGSI & HANDLER DATA SEKOLAH
  // ===========================================

  function bukaHalamanDataSekolah() {
    tampilHalaman('halaman-data-sekolah'); // tampilHalaman akan menyimpan ID
    hideMessage('data-sekolah-message');
    document.getElementById('form-data-sekolah').reset();
    setFormDisabled('form-data-sekolah', true);

    google.script.run
      .withSuccessHandler(onDataSekolahLoaded)
      .withFailureHandler(onGagal)
      .getSchoolData();
  }

  function onDataSekolahLoaded(response) {
      setFormDisabled('form-data-sekolah', false);

      if (response.status !== 'sukses') {
        showMessage('data-sekolah-message', response.message, true);
        return;
      }

      const data = response.data;
      jenjangBaseCache = data.jenjangBase;
      jenjangPilihanCache = data.jenjangPilihan; // [BARU] Simpan data terbaru
      populateSelectJenjang(data.jenjangBase, data.jenjangPilihan);

      document.getElementById('data-nama-sekolah').value = data.namaSekolah;
      document.getElementById('data-npsn').value = data.npsn || '';
      document.getElementById('data-nsm').value = data.nsm || '';
      document.getElementById('data-alamat').value = data.alamat || '';
      document.getElementById('data-provinsi').value = data.provinsi || '';
      document.getElementById('data-kabkot').value = data.kabKot || '';
      document.getElementById('data-pilihan-kabkot').value = data.pilihanKabKot || 'Kabupaten';
      document.getElementById('data-kecamatan').value = data.kecamatan || '';
      document.getElementById('data-keldes').value = data.kelDes || '';
      document.getElementById('data-pilihan-keldes').value = data.pilihanKelDes || 'Kelurahan';
      document.getElementById('data-kodepos').value = data.kodePos || '';
      document.getElementById('data-telepon').value = data.telepon || '';
      document.getElementById('data-email').value = data.email || '';
      document.getElementById('data-website').value = data.website || '';
      document.getElementById('data-kepsek').value = data.namaKepsek || '';
      document.getElementById('data-nip-kepsek').value = data.nipKepsek || '';

      updateTampilanNSM();
  }

  function populateSelectJenjang(jenjangBase, selectedValue) {
      const select = document.getElementById('data-jenjang-pilihan');
      select.innerHTML = ''; // Kosongkan dulu

      let options = [];
      if (jenjangBase === 'SD/MI') {
        options = ['SD', 'MI'];
      } else if (jenjangBase === 'SMP/MTS') {
        options = ['SMP', 'MTS'];
      } else if (jenjangBase === 'SMA/MA') {
        options = ['SMA', 'MA'];
      } else {
        options = [jenjangBase]; // Fallback
      }

      select.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });

      // Set nilai yang tersimpan
      if (selectedValue) {
        select.value = selectedValue;
      }
  }

  function updateTampilanNSM() {
      const jenjangPilihan = document.getElementById('data-jenjang-pilihan').value;
      const grupNSM = document.getElementById('grup-nsm');
      const labelNSM = grupNSM.querySelector('label');

      if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
        labelNSM.innerText = 'NSM (Wajib)';
      } else {
        labelNSM.innerText = 'NSM (Opsional)';
      }
  }

  function simpanDataSekolah() {
      setLoading(true);
      hideMessage('data-sekolah-message');

      // 1. Kumpulkan data
      const dataToSave = {
        jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
        npsn: document.getElementById('data-npsn').value.trim(),
        nsm: document.getElementById('data-nsm').value.trim(),
        alamat: document.getElementById('data-alamat').value.trim(),
        provinsi: document.getElementById('data-provinsi').value.trim(),
        kabKot: document.getElementById('data-kabkot').value.trim(),
        pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
        kecamatan: document.getElementById('data-kecamatan').value.trim(),
        kelDes: document.getElementById('data-keldes').value.trim(),
        pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
        kodePos: document.getElementById('data-kodepos').value.trim(),
        telepon: document.getElementById('data-telepon').value.trim(),
        email: document.getElementById('data-email').value.trim(),
        website: document.getElementById('data-website').value.trim(),
        namaKepsek: document.getElementById('data-kepsek').value.trim(),
        nipKepsek: document.getElementById('data-nip-kepsek').value.trim()
      };

      // 2. Validasi Dinamis
      const errors = [];
      if (!dataToSave.jenjangPilihan) { errors.push("Jenjang"); }
      if (!dataToSave.npsn) { errors.push("NPSN"); }
      if (!dataToSave.alamat) { errors.push("Alamat Sekolah"); }
      if (!dataToSave.namaKepsek) { errors.push("Nama Kepala Sekolah"); }

      // Validasi NSM (kondisional)
      const isMadrasah = (dataToSave.jenjangPilihan === 'MI' || dataToSave.jenjangPilihan === 'MTS' || dataToSave.jenjangPilihan === 'MA');
      if (isMadrasah && !dataToSave.nsm) { errors.push("NSM (wajib untuk Madrasah)"); }

      // 3. Tampilkan error jika ada
      if (errors.length > 0) {
        setLoading(false);
        const errorMessage = "Field (Wajib) tidak boleh kosong: " + errors.join(', ') + ".";
        showMessage('data-sekolah-message', errorMessage, true);
        return;
      }

      // 4. Kirim ke server (jika tidak ada error)
      jenjangPilihanCache = dataToSave.jenjangPilihan;
      google.script.run
        .withSuccessHandler(onDataSekolahSaved)
        .withFailureHandler(onGagal)
        .saveSchoolData(dataToSave);
  }

  function onDataSekolahSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('data-sekolah-message', 'Data sekolah berhasil disimpan!', false); // false = sukses
      } else {
        showMessage('data-sekolah-message', response.message, true);
      }
  }


  // ===========================================
  // FUNGSI & HANDLER BOBOT NILAI
  // ===========================================

  function sinkronkanBobot(sumber) {
      const inputRapor = document.getElementById('bobot-rapor');
      const inputUjian = document.getElementById('bobot-ujian');

      let nilaiRapor = parseInt(inputRapor.value, 10);
      let nilaiUjian = parseInt(inputUjian.value, 10);

      if (sumber === 'rapor') {
        if (isNaN(nilaiRapor)) { inputUjian.value = ''; return; }
        if (nilaiRapor > 100) { nilaiRapor = 100; inputRapor.value = 100; }
        if (nilaiRapor < 0) { nilaiRapor = 0; inputRapor.value = 0; }
        inputUjian.value = 100 - nilaiRapor;
      } else if (sumber === 'ujian') {
        if (isNaN(nilaiUjian)) { inputRapor.value = ''; return; }
        if (nilaiUjian > 100) { nilaiUjian = 100; inputUjian.value = 100; }
        if (nilaiUjian < 0) { nilaiUjian = 0; inputUjian.value = 0; }
        inputRapor.value = 100 - nilaiUjian;
      }
  }

  function bukaHalamanBobot() {
    tampilHalaman('halaman-bobot'); // tampilHalaman akan menyimpan ID
    hideMessage('bobot-message');
    document.getElementById('form-bobot').reset();
    setFormDisabled('form-bobot', true);

    google.script.run
      .withSuccessHandler(onBobotLoaded)
      .withFailureHandler(onGagal)
      .getBobotData();
  }

  function onBobotLoaded(response) {
      setFormDisabled('form-bobot', false);

      if (response.status !== 'sukses') {
        showMessage('bobot-message', response.message, true);
        return;
      }
      document.getElementById('bobot-rapor').value = response.bobotRapor;
      document.getElementById('bobot-ujian').value = response.bobotUjian;
  }

  function simpanBobot() {
      setLoading(true);
      hideMessage('bobot-message');

      const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
      const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;

      if ((bobotRapor + bobotUjian) !== 100) {
        setLoading(false);
        showMessage('bobot-message', 'Total bobot harus 100%. Silakan periksa kembali isian Anda.', true);
        return;
      }

      google.script.run
        .withSuccessHandler(onBobotSaved)
        .withFailureHandler(onGagal)
        .saveBobotData(bobotRapor, bobotUjian);
  }

  function onBobotSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('bobot-message', 'Data bobot berhasil disimpan!', false); // false = sukses
      } else {
        showMessage('bobot-message', response.message, true);
      }
  }

  // ===========================================
  // FUNGSI & HANDLER KELOLA KELAS
  // ===========================================

  function getCurrentKelasList() {
      const inputs = document.querySelectorAll('#kelas-list-container input');
      const list = [];
      inputs.forEach(input => {
        list.push(input.value); // Simpan semua, termasuk yg kosong, untuk re-render
      });
      return list;
  }

  function renderKelasList(kelasList) {
      const container = document.getElementById('kelas-list-container');
      container.innerHTML = ''; // Kosongkan kontainer

      let listToRender = kelasList;
      // Jika list kosong (setelah load atau semua dihapus), tampilkan 1 baris kosong
      if (listToRender.length === 0) {
        listToRender = [''];
      }

      listToRender.forEach((nama, index) => {
        const div = document.createElement('div');
        div.className = 'kelas-input-row';

        let html = `<input type="text" placeholder="Nama Kelas (Contoh: VI A)" value="${nama}">`;

        // Tampilkan tombol Hapus (x) jika ada lebih dari 1 baris
        if (listToRender.length > 1) {
          html += '<button type="button" class="btn-aksi-kelas btn-remove-kelas">&times;</button>';
        }

        // Tampilkan tombol Tambah (+) hanya di baris terakhir
        if (index === listToRender.length - 1) {
          html += '<button type="button" class="btn-aksi-kelas btn-add-kelas">+</button>';
        }

        div.innerHTML = html;
        container.appendChild(div);
      });
  }

  function bukaHalamanKelas() {
    tampilHalaman('halaman-kelas'); // tampilHalaman akan menyimpan ID
    hideMessage('kelas-message');
    document.getElementById('kelas-list-container').innerHTML = "<p>Memuat data kelas...</p>";
    setFormDisabled('form-kelas', true);

    google.script.run
      .withSuccessHandler(onKelasLoaded)
      .withFailureHandler(onGagal)
      .getKelas();
  }

  function onKelasLoaded(response) {
      setFormDisabled('form-kelas', false);

      if (response.status !== 'sukses') {
        showMessage('kelas-message', response.message, true);
        document.getElementById('kelas-list-container').innerHTML = '';
        return;
      }
      renderKelasList(response.kelas || []);
  }

  function simpanKelas() {
      setLoading(true);
      hideMessage('kelas-message');

      // 1. Ambil semua nilai, ubah ke string, trim, dan filter yang kosong
      const list = getCurrentKelasList()
                   .map(nama => String(nama).trim())
                   .filter(nama => nama.length > 0);

      // 2. Validasi duplikat
      const uniqueList = new Set(list.map(nama => nama.toUpperCase())); // Cek duplikat case-insensitive
      if (uniqueList.size !== list.length) {
        setLoading(false);
        showMessage('kelas-message', 'Nama kelas tidak boleh ada yang sama (duplikat).', true);
        return;
      }

      // 3. Kirim ke server
      google.script.run
        .withSuccessHandler(onKelasSaved)
        .withFailureHandler(onGagal)
        .saveKelas(list);
  }

  function onKelasSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        showMessage('kelas-message', 'Data kelas berhasil disimpan!', false); // false = sukses
      } else {
        showMessage('kelas-message', response.message, true);
      }
  }


  // ===========================================
  // FUNGSI & HANDLER KELOLA SISWA
  // ===========================================

  function bukaHalamanSiswa() {
    tampilHalaman('halaman-siswa'); // tampilHalaman akan menyimpan ID
    document.getElementById('siswa-table-container').innerHTML = "<p>Memuat data siswa...</p>";

    google.script.run
      .withSuccessHandler(onSiswaLoaded)
      .withFailureHandler(onGagal)
      .getSiswa();
  }

  function onSiswaLoaded(response) {
      setSiswaOrderDirty(false); // [BARU] Reset dirty flag
      const container = document.getElementById('siswa-table-container');

      if (response.status === "sukses") {
        // 1. Simpan data asli ke cache global
        globalSiswaList = response.siswa;
  
        // 2. [BARU] Isi filter dropdown
        populateSiswaFilters();
  
        // 3. [BARU] Terapkan filter/sort default dan render tabel
        applySiswaFiltersAndRender();
  
      } else {
        // Jika gagal, reset cache dan tampilkan error
        globalSiswaList = [];
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat siswa: ${response.message}</p>`;
      }
  }

  /**
   * [BARU] Mengatur status "dirty" dan mengaktifkan/menonaktifkan tombol simpan
   */
  function setSiswaOrderDirty(isDirty) {
    isSiswaOrderDirty = isDirty;
    const btnSimpan = document.getElementById('btn-simpan-urutan-siswa');
    if (btnSimpan) {
      btnSimpan.disabled = !isDirty;
    }
  }

  /**
   * [BARU] Callback setelah urutan siswa berhasil disimpan
   */
  function onSiswaUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setSiswaOrderDirty(false); // Nonaktifkan tombol
      showMessage('siswa-message', 'Urutan siswa berhasil disimpan!', false);
    } else {
      // Biarkan tombol aktif agar user bisa mencoba lagi
      showMessage('siswa-message', response.message, true);
    }
  }

  /**
   * [BARU] Mengisi dropdown filter kelas berdasarkan data di globalSiswaList
   */
  function populateSiswaFilters() {
    const selectKelas = document.getElementById('siswa-filter-kelas');
    // Simpan value yang sedang dipilih (jika ada, misal saat refresh data)
    const selectedValue = selectKelas.value;
    
    // Kumpulkan semua nama kelas unik
    const kelasSet = new Set(globalSiswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(); // Urutkan nama kelas A-Z
  
    // Buat HTML untuk opsi
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    
    // Setel kembali value yang tadi dipilih (jika masih ada)
    selectKelas.value = selectedValue || 'semua';
  }
  
  /**
   * [BARU] Menerapkan filter & sorting, lalu memanggil renderSiswaTable
   */
  function applySiswaFiltersAndRender() {
    const selectedKelas = document.getElementById('siswa-filter-kelas').value;
    const selectedSort = document.getElementById('siswa-sort-by').value;
  
    // Mulai dengan data lengkap dari cache
    let processedSiswa = [...globalSiswaList];
  
    // 1. Terapkan Filter
    if (selectedKelas !== 'semua') {
      processedSiswa = processedSiswa.filter(siswa => siswa.kelas === selectedKelas);
    }
  
    // 2. Terapkan Sorting
    switch (selectedSort) {
      case 'nama-az':
        processedSiswa.sort((a, b) => a.nama.localeCompare(b.nama));
        break;
      case 'nama-za':
        processedSiswa.sort((a, b) => b.nama.localeCompare(a.nama));
        break;
      case 'nisn-asc':
        // localeCompare dengan numeric: true agar '10' > '2'
        processedSiswa.sort((a, b) => a.nisn.localeCompare(b.nisn, undefined, { numeric: true }));
        break;
      case 'nisn-desc':
        processedSiswa.sort((a, b) => b.nisn.localeCompare(a.nisn, undefined, { numeric: true }));
        break;
      case 'default':
      default:
        processedSiswa.sort((a, b) => {
          // 1. Urutkan berdasarkan Kelas
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) {
            return kelasCompare; // Kembalikan jika kelas berbeda
          }
          
          // 2. Jika kelas sama, urutkan berdasarkan 'urutan'
          const urutanA = Number(a.urutan) || 0;
          const urutanB = Number(b.urutan) || 0; // <-- PERBAIKAN
          
          return urutanA - urutanB; // Urutkan angka secara menaik
        });
        break;
    }
  
    // 3. Render tabel dengan data yang sudah diproses
    renderSiswaTable(processedSiswa);
  }
  
  /**
   * [DIUBAH] Merender HTML tabel siswa ke dalam kontainer
   * Memindahkan tombol Naik/Turun ke kolom Aksi
   */
  function renderSiswaTable(siswaList) {
    const container = document.getElementById('siswa-table-container');
    
    let html = '<table class="siswa-table">';
    // [DIUBAH] Header kembali normal (4 kolom)
    html += '<tr><th>Nama Siswa</th><th>NISN</th><th>Kelas</th><th>Aksi</th></tr>';
  
    if (siswaList.length === 0) {
      // [DIUBAH] Colspan jadi 4
      html += '<tr><td colspan="4" style="text-align: center;">Tidak ada data siswa yang sesuai dengan filter.</td></tr>';
    }
  
    let currentKelas = null; // Untuk melacak grup kelas
    const selectedSort = document.getElementById('siswa-sort-by').value;
    // [PENTING] Hanya aktifkan tombol panah jika urutan "default" dipilih
    const isDefaultSort = (selectedSort === 'default');

    siswaList.forEach((siswa, index) => {
      
      // [LOGIKA LAMA] untuk tombol disabled
      const isFirstOfClass = (siswa.kelas !== currentKelas);
      currentKelas = siswa.kelas;
      
      const nextSiswa = siswaList[index + 1];
      const isLastOfClass = (!nextSiswa || nextSiswa.kelas !== siswa.kelas);
      
      // [BARU] Buat tombol Naik/Turun
      // Tombol panah hanya muncul JIKA urutan default aktif
      let moveButtonsHtml = '';
      if (isDefaultSort) {
        moveButtonsHtml = `
          <button 
            class="btn-aksi btn-move-up" 
            data-id="${siswa.id}" 
            ${isFirstOfClass ? 'disabled' : ''}
            title="Naikkan posisi">
              <i class="fas fa-arrow-up"></i>
          </button>
          <button 
            class="btn-aksi btn-move-down" 
            data-id="${siswa.id}" 
            ${isLastOfClass ? 'disabled' : ''}
            title="Turunkan posisi">
                <i class="fas fa-arrow-down"></i>
          </button>
        `;
      }
      
      // [DIUBAH] Gabungkan semua tombol di kolom "Aksi"
      html += `
        <tr>
          <td>${siswa.nama}</td>
          <td>${siswa.nisn}</td>
          <td>${siswa.kelas}</td>
          <td>
            ${moveButtonsHtml}
            <button class="btn-aksi btn-edit btn-edit-siswa"
              data-id="${siswa.id}" data-nama="${siswa.nama}" data-nisn="${siswa.nisn}" data-nis-lokal="${siswa.nisLokal}" data-jk="${siswa.jk}" data-tempat-lahir="${siswa.tempatLahir}" data-tgl-lahir="${siswa.tglLahir}" data-kelas="${siswa.kelas}"
            ><i class="fas fa-pencil-alt"></i>Edit</button>
            <button class="btn-aksi btn-delete btn-delete-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}"><i class="fas fa-trash-alt"></i>Hapus</button>
          </td>
        </tr>
      `;
    });
  
    html += '</table>';
    container.innerHTML = html;
  }

  function tutupModalSiswa() {
      document.getElementById('siswa-modal').style.display = 'none';
  }

  function showModalSiswa(mode, siswaData) {
      hideMessage('modal-siswa-error');

      // 1. Reset form
      document.getElementById('modal-siswa-mode').value = mode;
      document.getElementById('modal-siswa-id').value = siswaData.id || '';
      document.getElementById('modal-siswa-nama').value = '';
      document.getElementById('modal-siswa-nisn').value = '';
      document.getElementById('modal-siswa-nis-lokal').value = '';
      document.getElementById('modal-siswa-jk').value = '';
      document.getElementById('modal-siswa-tempat-lahir').value = '';
      document.getElementById('modal-siswa-tgl-lahir').value = '';

      const selectKelas = document.getElementById('modal-siswa-kelas');
      selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
      document.getElementById('btn-simpan-siswa').disabled = true;

      // Atur judul & isi form jika edit
      if (mode === 'add') {
        document.getElementById('modal-siswa-title').innerText = "Tambah Siswa Baru";
        document.getElementById('modal-siswa-nisn').readOnly = false;
      } else {
        document.getElementById('modal-siswa-title').innerText = "Edit Data Siswa";
        document.getElementById('modal-siswa-nisn').readOnly = false; // NISN bisa diedit

        // Isi form (kecuali kelas)
        document.getElementById('modal-siswa-id').value = siswaData.id;
        document.getElementById('modal-siswa-nama').value = siswaData.nama;
        document.getElementById('modal-siswa-nisn').value = siswaData.nisn;
        document.getElementById('modal-siswa-nis-lokal').value = siswaData.nisLokal;
        document.getElementById('modal-siswa-jk').value = siswaData.jk;
        document.getElementById('modal-siswa-tempat-lahir').value = siswaData.tempatLahir;
        document.getElementById('modal-siswa-tgl-lahir').value = siswaData.tglLahir;
      }

      document.getElementById('siswa-modal').style.display = 'block';

      // 2. Muat kelas
      google.script.run
        .withSuccessHandler((response) => onKelasListLoadedForModal(response, siswaData))
        .withFailureHandler(onGagal)
        .getKelas();
  }

  function onKelasListLoadedForModal(response, siswaData) {
      const selectKelas = document.getElementById('modal-siswa-kelas');
      const btnSimpan = document.getElementById('btn-simpan-siswa');
      hideMessage('modal-siswa-error');

      if (response.status !== 'sukses' || !response.kelas || response.kelas.length === 0) {
        selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
        showMessage('modal-siswa-error', "Tidak dapat menambah/edit siswa. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
        btnSimpan.disabled = true;
      } else {
        selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        response.kelas.forEach(namaKelas => {
          selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
        });
        btnSimpan.disabled = false;

        // Set kelas jika mode edit
        if (document.getElementById('modal-siswa-mode').value === 'edit') {
          document.getElementById('modal-siswa-kelas').value = siswaData.kelas;
        }
      }
  }

  function simpanSiswa() {
      setLoading(true);
      hideMessage('modal-siswa-error');

      // 1. Kumpulkan data
      const dataSiswa = {
        id: document.getElementById('modal-siswa-id').value,
        nama: document.getElementById('modal-siswa-nama').value.trim(),
        nisn: document.getElementById('modal-siswa-nisn').value.trim(),
        nisLokal: document.getElementById('modal-siswa-nis-lokal').value.trim(),
        jk: document.getElementById('modal-siswa-jk').value,
        tempatLahir: document.getElementById('modal-siswa-tempat-lahir').value.trim(),
        tglLahir: document.getElementById('modal-siswa-tgl-lahir').value,
        kelas: document.getElementById('modal-siswa-kelas').value
      };

      // 2. Validasi
      const errors = [];
      if (!dataSiswa.nama) errors.push("Nama Lengkap");
      if (!dataSiswa.nisn) errors.push("NISN");
      if (!dataSiswa.jk) errors.push("Jenis Kelamin");
      if (!dataSiswa.kelas) errors.push("Kelas");

      if (errors.length > 0) {
        setLoading(false);
        showMessage('modal-siswa-error', "Field (Wajib) tidak boleh kosong: " + errors.join(', ') + ".", true);
        return;
      }

      // 3. Kirim ke backend
      const mode = document.getElementById('modal-siswa-mode').value;
      if (mode === 'add') {
        google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).createSiswa(dataSiswa);
      } else {
        google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).updateSiswa(dataSiswa);
      }
  }

  function onSiswaSaved(response) {
      setSiswaOrderDirty(false); // [BARU] Reset dirty flag
      setLoading(false);

      if (response.status === "sukses") {
        tutupModalSiswa();
        bukaHalamanSiswa(); // Muat ulang data tabel siswa
      } else {
        showMessage('modal-siswa-error', response.message, true);
      }
  }

  function hapusSiswa(siswaID, namaSiswa) {
      const title = "Konfirmasi Hapus";
      const message = `Yakin ingin menghapus siswa: <strong>${namaSiswa}</strong> (ID: ${siswaID})?<br><br><strong>PERINGATAN:</strong> Semua data nilai yang terkait dengan siswa ini juga akan hilang.`;

      const callback = function() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(onSiswaSaved) // Bisa pakai callback yang sama
          .withFailureHandler(onGagal)
          .deleteSiswa(siswaID);
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function hapusSemuaSiswa() {
      const title = "PERINGATAN BESAR!";
      const message = "Anda yakin ingin menghapus <strong>SEMUA</strong> data siswa? Tindakan ini tidak bisa dibatalkan dan akan menghapus semua data nilai yang terkait.";

      const callback = function() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(onSiswaTableRefreshed)
          .withFailureHandler(onGagal)
          .deleteAllSiswa();
      };

      showConfirmationModal(title, message, callback, 'danger');
  }

  function onSiswaTableRefreshed(response) {
      setLoading(false);
      if (response.status === "sukses") {
        showInfoModal("Sukses", response.message, false, bukaHalamanSiswa);
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  // ===========================================
  // [DIUBAH] FUNGSI & HANDLER IMPORT SISWA (VERSI EXCEL)
  // ===========================================

  /**
   * Membuka modal import dan mereset tampilannya.
   */
  function bukaModalImportSiswa() {
    // Reset modal
    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
    document.getElementById('import-siswa-results').style.display = 'none';
    document.getElementById('import-siswa-results').innerHTML = '';
    hideMessage('template-message');
    
    // [BARU] Reset teks file upload zone
    const fileUploadText = document.getElementById('file-upload-text');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone').classList.remove('drag-over');

    // Reset flag
    siswaTelahDiImport = false;
    
    // Tampilkan modal
    document.getElementById('import-siswa-modal').style.display = 'block';
  }

  /**
   * Menutup modal import.
   * Akan me-refresh tabel siswa jika ada data baru yang berhasil di-import.
   */
  function tutupModalImportSiswa() {
    document.getElementById('import-siswa-modal').style.display = 'none';
    if (siswaTelahDiImport) {
      siswaTelahDiImport = false; // Reset flag
      bukaHalamanSiswa(); // Muat ulang tabel siswa
    }
  }

  /**
   * [DIUBAH] Memanggil server untuk mendapatkan URL download template Excel.
   */
  function downloadTemplateSiswa() {
    setLoading(true);
    hideMessage('template-message');
    google.script.run
      .withSuccessHandler(onTemplateUrlReceived)
      .withFailureHandler(onGagal) // onGagal akan menampilkan error di 'template-message' jika modal terbuka
      .getSiswaTemplateUrl();
  }
  
  /**
   * [DIUBAH] Callback setelah data template diterima dari server (dalam format Base64).
   * Fungsi ini akan membuat file dari Base64 dan memicu download di sisi klien.
   */
  function onTemplateUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-message', 'Template berhasil dibuat. Mengunduh...', false);

      // Logika baru untuk mengunduh file dari data Base64
      try {
        // 1. Buat "data URL" dari Base64
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        
        // 2. Buat elemen link 'a' palsu
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName); // Atur nama file
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        // 3. Klik link tersebut secara programatik
        link.click();
        
        // 4. Hapus link palsu dari DOM
        document.body.removeChild(link);

      } catch (e) {
        // Tangani jika browser gagal memproses data URL (jarang terjadi)
        showMessage('template-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      // Menampilkan pesan error dari server (misal: "Gagal membuat template dinamis: ...")
      showMessage('template-message', response.message, true);
    }
  }


  /**
   * [DIUBAH] Membaca file Excel sebagai DataURL (Base64) dan mengirimkannya ke server.
   */
  function prosesImportFileSiswa() {
    setLoading(true);
    document.getElementById('import-siswa-results').style.display = 'none';
    hideMessage('template-message');

    const fileInput = document.getElementById('file-upload-siswa');
    const file = fileInput.files[0];

    if (!file) {
      setLoading(false);
      showMessage('template-message', 'Pilih file Excel terlebih dahulu.', true);
      return;
    }

    const reader = new FileReader();

    // Callback ketika file selesai dibaca
    reader.onload = (e) => {
      const fileData = {
        base64: e.target.result,
        mimeType: file.type,
        fileName: file.name
      };
      
      // Kirim objek fileData (mengandung base64) ke server
      google.script.run
        .withSuccessHandler(onImportSiswaFinished)
        .withFailureHandler(onGagal)
        .prosesImportExcelSiswa(fileData);
    };

    // Callback jika gagal baca file
    reader.onerror = (e) => {
      setLoading(false);
      showMessage('template-message', 'Gagal membaca file: ' + e.target.error.name, true);
    };

    // Mulai baca file sebagai DataURL (Base64)
    reader.readAsDataURL(file);
  }

  /**
   * [SAMA] Menampilkan hasil import yang dikembalikan oleh server.
   * (Fungsi ini tidak perlu diubah, hanya disalin ulang)
   */
  function onImportSiswaFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-siswa-results');

    if (response.status !== 'sukses') {
      // Ini adalah error server, bukan error validasi data
      showMessage('template-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    // Set flag agar tabel di-refresh saat modal ditutup
    if (response.berhasilDiUpload > 0) {
      siswaTelahDiImport = true;
    }

    // Bangun HTML untuk laporan
    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    // Jika ada data yang gagal, tampilkan tabel
    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>NISN</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.nisn || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    // Reset input file agar bisa upload file yang sama lagi
    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
  }

  // ===========================================
  // [BARU] FUNGSI & HANDLER INPUT NILAI UJIAN
  // ===========================================

  /**
   * Membuka halaman menu Input Nilai.
   * Mengatur label tombol 'Ujian Madrasah/Sekolah' secara dinamis.
   */
  function bukaHalamanInputUjian() {
    tampilHalaman('halaman-input-ujian'); // tampilHalaman akan menyimpan ID
    
    const labelUjianUtama = document.getElementById('label-ujian-utama');
    
    // [DIUBAH] Gunakan jenjangPilihanCache (MI, MTS, MA)
    const jenjangPilihan = jenjangPilihanCache;
    if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
      labelUjianUtama.innerText = 'Ujian Madrasah';
    } else {
      // Default ke 'Ujian Sekolah' (mencakup SD, SMP, SMA, atau jika kosong)
      labelUjianUtama.innerText = 'Ujian Sekolah';
    }
  }

  /**
   * [DIUBAH] Membuka halaman detail untuk input nilai (tabel).
   * @param {string} tipeUjian - 'UM' (Utama) atau 'Praktek'.
   */
  function bukaHalamanInputNilaiDetail(tipeUjian) {
    tampilHalaman('halaman-input-nilai-detail'); // tampilHalaman akan menyimpan ID
    hideMessage('input-nilai-message');
    
    const judulHalaman = document.getElementById('judul-halaman-input-nilai');
    const tableContainer = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');

    // 1. Reset tampilan
    tableContainer.innerHTML = '<p>Memuat data siswa dan mata pelajaran...</p>';
    btnSimpan.disabled = true;
    document.getElementById('input-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>'; // [BARU] Reset filter
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} }; // [BARU] Reset cache

    // 2. Atur Judul Halaman dan simpan tipe ujian di 'data-' attribute
    if (tipeUjian === 'UM') {
      const jenjangPilihan = jenjangPilihanCache;
      const label = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
      judulHalaman.innerText = `Input Nilai ${label}`;
      judulHalaman.dataset.tipeUjian = 'UM';
    } else {
      judulHalaman.innerText = 'Input Nilai Ujian Praktek';
      judulHalaman.dataset.tipeUjian = 'Praktek';
    }

    // 3. Muat semua data grid (siswa, mapel, nilai)
    setLoading(true);
    google.script.run
      .withSuccessHandler(onNilaiGridLoaded) // Fungsi rendering baru
      .withFailureHandler(onGagal) 
      .getNilaiUjianGridData(tipeUjian); // Fungsi backend baru
  }

  /**
   * [BARU] Mengisi dropdown filter kelas di halaman input nilai.
   */
  function populateNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('input-nilai-filter-kelas');
    const selectedValue = selectKelas.value; // Simpan value yg mungkin sudah dipilih
  
    // Kumpulkan semua nama kelas unik dari siswaList
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(); // Urutkan A-Z
  
    // Buat HTML untuk opsi
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || 'semua'; // Set kembali
  }

  /**
   * [DIUBAH] Menjadi handler untuk data yang di-fetch.
   * Sekarang mendelegasikan rendering ke renderNilaiGridTable().
   */
  function onNilaiGridLoaded(response) {
    setLoading(false);
    const container = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      btnSimpan.disabled = true;
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} }; // [BARU] Reset cache
      return;
    }

    // 1. [DIUBAH] Simpan data ke cache global
    globalGridData = response.data;
    
    // 2. [BARU] Isi dropdown filter kelas
    populateNilaiFilter(globalGridData.siswaList);

    // 3. [BARU] Panggil fungsi render (yang akan membaca dari cache)
    renderNilaiGridTable(); 
    
    // 4. [DIUBAH] Aktifkan tombol simpan HANYA jika ada siswa & mapel
    const { siswaList, mapelList } = globalGridData;
    if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
      btnSimpan.disabled = false;
    } else {
      btnSimpan.disabled = true;
    }
  }

  /**
   * [BARU] Merender tabel grid nilai berdasarkan data di cache global
   * dan filter yang dipilih.
   */
  function renderNilaiGridTable() {
    const container = document.getElementById('input-nilai-table-container');
    
    // 1. Ambil data dari cache global
    const { siswaList, mapelList, nilaiData } = globalGridData;
    
    // 2. Ambil filter yang dipilih
    const selectedKelas = document.getElementById('input-nilai-filter-kelas').value;
    
    // 3. Validasi data (seperti di onNilaiGridLoaded)
    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa. Harap isi di menu "Kelola Data Siswa".</p>';
      return;
    }
    
    if (!mapelList || mapelList.length === 0) {
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }

    // 4. [BARU] Filter siswaList berdasarkan kelas yang dipilih
    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    // 5. [BARU] Cek jika hasil filter kosong
    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       // Ini seharusnya sudah ditangani oleh validasi #3, tapi sebagai pengaman
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    // 6. Mulai bangun tabel (Logika ini disalin dari onNilaiGridLoaded)
    let html = '<table class="input-nilai-table">';
    
    // Header
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel" title="${mapel.nama}">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '</tr></thead>';
    
    // Body (Gunakan filteredSiswaList)
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => { // [DIUBAH] Gunakan filteredSiswaList
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiData[key] || '';
        
        html += `<td class="col-mapel">
            <input 
              type="number" 
              class="input-nilai" 
              min="0" 
              max="100" 
              placeholder="0"
              value="${nilai}"
              data-siswa-id="${siswa.id}" 
              data-mapel-id="${mapel.id}"
            >
          </td>`;
      });
      html += `<td class="col-total col-total-jumlah" id="jumlah_${siswa.id}">0</td>`;
      html += `<td class="col-total col-total-rata" id="rata_${siswa.id}">0.00</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;

    // 7. Hitung total awal (Gunakan filteredSiswaList)
    const mapelCount = mapelList.length;
    if (mapelCount > 0) {
      filteredSiswaList.forEach(siswa => { // [DIUBAH] Gunakan filteredSiswaList
        updateRowTotals(siswa.id, mapelCount);
      });
    }
  }


  /**
   * [BARU] Menghitung dan memperbarui sel Jumlah & Rata-Rata untuk satu baris siswa.
   * @param {string} siswaId - ID siswa (misal: "SIS-1")
   * @param {number} mapelCount - Jumlah total mapel untuk perhitungan rata-rata
   */
  function updateRowTotals(siswaId, mapelCount) {
    // 1. Temukan sel target
    const jumlahCell = document.getElementById(`jumlah_${siswaId}`);
    const rataCell = document.getElementById(`rata_${siswaId}`);
    
    // Jika sel tidak ditemukan, keluar (pengaman)
    if (!jumlahCell || !rataCell) return;

    // 2. Temukan semua input nilai HANYA untuk baris siswa ini
    const rowInputs = document.querySelectorAll(`.input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    
    // 3. Loop melalui input, validasi, dan jumlahkan
    rowInputs.forEach(input => {
      const value = parseFloat(input.value);
      if (!isNaN(value) && value >= 0 && value <= 100) {
        sum += value;
      }
    });

    // 4. Hitung rata-rata (pastikan tidak dibagi 0)
    const average = (mapelCount > 0) ? (sum / mapelCount) : 0;
    
    // 5. Tampilkan hasilnya di tabel
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2); // Tampilkan 2 angka desimal
  }

  /**
   * [DIUBAH] Mengumpulkan dan menyimpan semua nilai dari tabel grid.
   */
  function simpanInputNilai() {
    setLoading(true);
    hideMessage('input-nilai-message');
    
    // 1. Ambil tipe ujian dari judul halaman
    const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
    
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    const dataToSave = [];
    
    inputs.forEach(input => {
      dataToSave.push({
        siswaId: input.dataset.siswaId,
        mapelId: input.dataset.mapelId,
        tipeUjian: tipeUjian, // Ambil dari variabel di atas
        nilai: input.value
      });
    });

    // 2. Kirim data ke fungsi backend baru
    google.script.run
      .withSuccessHandler(onNilaiUjianSaved)
      .withFailureHandler(onGagal)
      .saveNilaiUjianBatch(dataToSave); // <-- Ini sekarang fungsi asli
  }

  /**
   * Callback setelah nilai berhasil disimpan.
   * (RANGKA)
   */
  function onNilaiUjianSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('input-nilai-message', response.message, false); // false = sukses
    } else {
      showMessage('input-nilai-message', response.message, true);
    }
  }

</script>
