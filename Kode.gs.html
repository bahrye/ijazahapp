// ! ID MASTER SHEET ANDA
// ! Ini adalah sheet yang berisi daftar sekolah (Email, Password, ID Sheet mereka)
const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const MAPEL_CACHE_KEY = 'mapel_data'; 
// [BARU] ID Folder Google Drive target Anda
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

// [BARU] PASTE ID TEMPLATE GOOGLE SHEET ANDA DI SINI
const TEMPLATE_SISWA_SHEET_ID = "1EWfAFmXD4OtbOTKmq0WFtbaRaVG_NAjHH5IjIgM92FY";

// ===========================================
// [BARU] KONSTANTA TEMPLATE STATIS
// ===========================================
// GANTI "..." DENGAN STRING BASE64 DARI LANGKAH 1
const TEMPLATE_SISWA_BASE64 = "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";
const TEMPLATE_SISWA_FILENAME = "template_import_siswa.xlsx";
const TEMPLATE_SISWA_MIMETYPE = MimeType.MICROSOFT_EXCEL;
// ===========================================

/**
 * Fungsi utama untuk menampilkan halaman web.
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

/**
 * Fungsi utility untuk menyisipkan file CSS atau JS ke dalam HTML.
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ===========================================
// FUNGSI OTENTIKASI & SESI
// ===========================================

/**
 * Memproses login pengguna.
 * [UPDATE] Mengirim nama sekolah sbg uppercase dan jenjangPilihan.
 */
function prosesLogin(email, password) {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      return { status: "gagal", message: "Database Master tidak dikonfigurasi. Hubungi Admin." };
    }
    const dataSekolah = sheetSekolah.getDataRange().getValues();

    for (let i = 1; i < dataSekolah.length; i++) {
      const row = dataSekolah[i];
      const dbEmail = row[3];
      const dbPassword = row[4];
      
      if (dbEmail === email && dbPassword === password) {
        
        // Buat token unik
        const token = Utilities.getUuid();
        const now = new Date().getTime(); // Stempel waktu
        const namaSekolahUpper = row[1].toUpperCase();
        const userSpreadsheetID = row[5]; // [BARU] Ambil ID sheet
        
        const userProperties = PropertiesService.getUserProperties();
        userProperties.setProperty('sessionToken', token);
        userProperties.setProperty('lastActivity', now.toString());
        
        // [BARU] Ambil jenjangPilihan SPESIFIK dari sheet sekolah
        const jenjangPilihan = getJenjangPilihanFromSheet(userSpreadsheetID);

        // Simpan data lain seperti biasa
        userProperties.setProperty('sekolahID', row[0]);
        userProperties.setProperty('namaSekolah', namaSekolahUpper); 
        userProperties.setProperty('jenjang', row[2]); // Ini "SD/MI", "SMP/MTS"
        userProperties.setProperty('spreadsheetID', userSpreadsheetID); // [DIUBAH] Gunakan variabel
        userProperties.setProperty('jenjangPilihan', jenjangPilihan); // [BARU] Simpan "MI"
        
        return { 
          status: "sukses", 
          namaSekolah: namaSekolahUpper,
          jenjang: row[2], // "SD/MI"
          jenjangPilihan: jenjangPilihan, // [BARU] "MI"
          token: token
        };
      }
    }
    
    return { status: "gagal", message: "Email atau password salah." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * Memproses registrasi sekolah baru.
 * [UPDATE] Menyimpan nama sekolah sbg uppercase.
 */
function prosesRegistrasi(namaSekolah, jenjang, email, password) {
  let newSSID = null; // Variabel untuk menyimpan ID sheet baru jika terjadi error
  try {
    if (!namaSekolah || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    let sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    if (!sheetSekolah) {
       sheetSekolah = masterSS.insertSheet('Sheet_Sekolah');
       sheetSekolah.appendRow(['SekolahID', 'NamaSekolah', 'Jenjang', 'EmailAdmin', 'Password', 'SpreadsheetID']);
    }
    
    const dataSekolah = sheetSekolah.getDataRange().getValues();

    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][3] === email) {
        return { status: "gagal", message: "Email ini sudah terdaftar." };
      }
    }

    // --- [BLOK KODE BARU: LOGIKA FOLDER] ---
    let targetFolder;
    try {
      // Langsung ambil folder target menggunakan ID
      targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      return { status: "gagal", message: "Error: Folder target tidak ditemukan atau tidak dapat diakses. ID: " + TARGET_FOLDER_ID };
    }
    // --- [AKHIR BLOK KODE BARU] ---

    // [UPDATE] Pastikan namaSekolah adalah uppercase
    const namaSekolahUpper = namaSekolah.toUpperCase();

    // Buat Spreadsheet Baru untuk Sekolah
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); // [UPDATE]
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (manual): " + newSSID);

    // --- [BLOK KODE BARU: PINDAHKAN FILE] ---
    // Pindahkan file spreadsheet yang baru dibuat ke folder target
    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); // Tambahkan ke folder target
    DriveApp.getRootFolder().removeFile(newFile); // Hapus dari root (ini adalah operasi 'move')
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName());
    // --- [AKHIR BLOK KODE BARU] ---

    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    // [UPDATE] Menambahkan header baru untuk data siswa
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    // [BARU] Set format kolom C (NISN) dan D (NIS_Lokal) ke Teks
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    newSpreadsheet.insertSheet('Kelas')
      .appendRow(['NamaKelas']);
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    // [DIUBAH] Header sekarang 4 kolom
    sheetMapel.appendRow(['MapelID', 'NamaMapel', 'isUS', 'isUP']); 

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      // [DIUBAH] Rentang sekarang 4 kolom
      // Ini akan memperbaiki error "Data 4 kolom, rentang 2 kolom"
      sheetMapel.getRange(2, 1, defaultMapel.length, 4).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Rapor')
      .appendRow([
        'SiswaID', 'MapelID', 
        'Sem1_P', 'Sem1_K', 'Sem2_P', 'Sem2_K', 
        'Sem3_P', 'Sem3_K', 'Sem4_P', 'Sem4_K', 'Sem5_P', 'Sem5_K'
      ]);

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);

    // Tambahkan sheet Data_Sekolah
    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      // Header (A1:P1)
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheetDataSekolah.appendRow([
      // Data Default (A2:P2)
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    // Set baris data (baris 2) agar formatnya Teks Biasa (@)
    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    newSpreadsheet.deleteSheet(defaultSheet);
    
    const newSekolahID = "SKL-" + (sheetSekolah.getLastRow());
    
    sheetSekolah.appendRow([
      newSekolahID, 
      namaSekolahUpper, // [UPDATE]
      jenjang, 
      email, 
      password, 
      newSSID
    ]);

    return { status: "sukses", message: "Registrasi berhasil! Anda akan diarahkan ke halaman login." };
    
  } catch (e) {
    Logger.log(e);
    // Jika terjadi error SETELAH spreadsheet dibuat, hapus spreadsheet tersebut
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

/**
 * Menghapus sesi pengguna.
 */
function prosesLogout() {
  try {
    PropertiesService.getUserProperties().deleteAllProperties();
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [PENJAGA] Memvalidasi sesi & mereset timer 3 jam.
 */
function validateAndRefreshSession() {
  const userProperties = PropertiesService.getUserProperties();
  const lastActivityStr = userProperties.getProperty('lastActivity');
  const storedToken = userProperties.getProperty('sessionToken');
  
  if (!storedToken || !lastActivityStr) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  
  const lastActivity = parseInt(lastActivityStr, 10);
  const now = new Date().getTime();
  const threeHours = 3 * 60 * 60 * 1000;
  
  if (now - lastActivity > threeHours) {
    userProperties.deleteAllProperties();
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  
  userProperties.setProperty('lastActivity', now.toString());
  return userProperties;
}

/**
 * [CHECK AWAL] Memeriksa token saat halaman dimuat.
 * [UPDATE] Mengirim nama sekolah sbg uppercase dan jenjangPilihan.
 */
function checkToken(tokenFromClient) {
  try {
    const userProperties = validateAndRefreshSession(); 
    const storedToken = userProperties.getProperty('sessionToken');

    if (tokenFromClient === storedToken) {
      return { 
        status: "sukses", 
        namaSekolah: userProperties.getProperty('namaSekolah').toUpperCase(),
        jenjang: userProperties.getProperty('jenjang'),
        jenjangPilihan: userProperties.getProperty('jenjangPilihan') // [BARU]
      };
    } else {
      userProperties.deleteAllProperties();
      return { status: "gagal", message: "Token tidak cocok. Silakan login ulang." };
    }
    
  } catch (e) {
    // Tangkap error dari validateAndRefreshSession (mis. kedaluwarsa)
    return { status: "gagal", message: e.message };
  }
}


// [PERUBAHAN] Bagian "FUNGSI PENGOLAHAN NILAI (CONTOH)" telah dihapus


// ===========================================
// FUNGSI HELPER MAPEL DEFAULT (DINAMIS)
// ===========================================

// GANTI FUNGSI INI
/**
 * Mengambil daftar mapel default dari Master Sheet berdasarkan jenjang.
 * [DIUBAH] Mengembalikan 4 kolom [ID, Nama, isUS, isUP] (default false)
 */
function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; // Kembalikan array kosong jika sheet tidak ada
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); // Hapus baris header

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; // Kolom Jenjang
      const mapelID = row[1];     // Kolom MapelID
      const namaMapel = row[2];   // Kolom NamaMapel

      // Filter: jika jenjangnya cocok ATAU jenjangnya "UMUM"
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { // Pastikan data tidak kosong
          // [DIUBAH] Tambahkan 2 kolom default 'false'
          defaultMapel.push([mapelID, namaMapel, false, false]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; // Kembalikan array kosong jika terjadi error
  }
}

// ===========================================
// FUNGSI CRUD MATA PELAJARAN
// ===========================================

/**
 * [HELPER] Menghapus cache mapel agar data dimuat ulang.
 */
function clearMapelCache() {
  try {
    CacheService.getUserCache().remove(MAPEL_CACHE_KEY);
  } catch (e) {
    Logger.log("Gagal membersihkan cache mapel: " + e.message);
  }
}

function getMapelSheet() {
  // Panggil 'penjaga' di awal
  const userProperties = validateAndRefreshSession();
  const spreadsheetID = userProperties.getProperty('spreadsheetID');
  
  const ss = SpreadsheetApp.openById(spreadsheetID);
  const sheetMapel = ss.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  return sheetMapel;
}

function getMapel() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedMapel = userCache.get(MAPEL_CACHE_KEY);

    if (cachedMapel != null) {
      // Data ditemukan di cache, kirim langsung (super cepat)
      Logger.log("Mengambil mapel dari CACHE");
      return { status: "sukses", mapel: JSON.parse(cachedMapel) };
    }
    
    // Data tidak ada di cache, ambil dari sheet (lambat)
    Logger.log("Mengambil mapel dari SPREADSHEET");
    const sheetMapel = getMapelSheet();
    const data = sheetMapel.getDataRange().getValues();
    const headers = data.shift(); // Hapus header
    
    // [DIUBAH] Tambahkan isUS (col 2) dan isUP (col 3)
    const mapel = data.map(row => ({ 
                        id: row[0], 
                        nama: row[1],
                        isUS: row[2] || false, // default false jika kosong
                        isUP: row[3] || false  // default false jika kosong
                      }))
                      .filter(row => row.id); // Filter baris kosong
    
    // Simpan ke cache untuk 10 menit (600 detik)
    userCache.put(MAPEL_CACHE_KEY, JSON.stringify(mapel), 600); 
    
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toUpperCase() === mapelID.toUpperCase()) {
        return { status: "gagal", message: "MapelID '" + mapelID + "' sudah ada." };
      }
    }
    
    // [DIUBAH] Tambahkan 2 kolom baru dengan nilai default 'false'
    sheetMapel.appendRow([mapelID, namaMapel, false, false]);
    
    clearMapelCache();
    return { status: "sukses" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === mapelID) {
        sheetMapel.getRange(i + 1, 2).setValue(namaMapel);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteMapel(mapelID) {
  try {
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === mapelID) {
        sheetMapel.deleteRow(i + 1);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// ===========================================
// FUNGSI KELOLA MAPEL (BULK)
// ===========================================

// GANTI FUNGSI INI
/**
 * [SINKRONISASI] Menambahkan mapel default yang hilang ke sheet Mapel sekolah.
 */
function syncDefaultMapel() {
  try {
    const userProperties = validateAndRefreshSession();
    const jenjang = userProperties.getProperty('jenjang');
    
    // 1. Ambil daftar mapel default (sekarang 4 kolom)
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const defaultMapelList = getDynamicDefaultMapel(jenjang, masterSS); // Array [ [ID, Nama, false, false], ... ]
    
    // 2. Ambil daftar mapel yang ada di sheet sekolah
    const sheetMapel = getMapelSheet(); // Ini sudah memvalidasi sesi
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift(); // Hapus header
    
    // Buat Set (untuk pencarian cepat) dari MapelID yang sudah ada
    const existingMapelIDs = new Set();
    dataMapel.forEach(row => {
      if (row[0]) {
        existingMapelIDs.add(row[0].toUpperCase()); // Simpan dalam huruf besar
      }
    });

    // 3. Filter mapel default yang BELUM ADA
    const mapelToAdd = [];
    defaultMapelList.forEach(mapel => { // 'mapel' sekarang array 4-elemen
      const mapelID = mapel[0];
      if (!existingMapelIDs.has(mapelID.toUpperCase())) {
        // [DIUBAH] Langsung push 'mapel' (karena sudah 4 kolom)
        mapelToAdd.push(mapel); 
      }
    });
    
    // 4. Tambahkan mapel yang hilang ke sheet
    if (mapelToAdd.length > 0) {
      // Rentang 4 kolom (ini sudah benar dari sebelumnya)
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 4)
                .setValues(mapelToAdd);
      clearMapelCache();
      return { status: "sukses", message: `Berhasil menambahkan ${mapelToAdd.length} mapel default yang hilang.` };
    } else {
      return { status: "sukses", message: "Data mapel Anda sudah sinkron. Tidak ada yang ditambahkan." };
    }
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [HAPUS SEMUA] Menghapus semua mapel dari sheet sekolah.
 */
function deleteAllMapel() {
  try {
    const sheetMapel = getMapelSheet(); // Ini sudah memvalidasi sesi
    const lastRow = sheetMapel.getLastRow();
    
    // Hapus semua baris KECUALI baris header (baris 1)
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache();
    return { status: "sukses", message: "Semua mapel telah dihapus." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU] Menyimpan status tipe ujian (US/UP) untuk semua mapel secara batch.
 * Menerima array: [{id: "MTK", isUS: true, isUP: false}, ...]
 */
function saveMapelTipeUjianBatch(tipeUjianData) {
  try {
    validateAndRefreshSession();
    
    const sheetMapel = getMapelSheet();
    
    // 1. Ambil semua data dari sheet
    const dataRange = sheetMapel.getDataRange();
    const data = dataRange.getValues(); // Termasuk header
    
    // 2. Buat Peta (Map) dari data baru untuk pencarian cepat
    // Peta: "MTK" -> {id: "MTK", isUS: true, isUP: false}
    const dataMap = new Map(tipeUjianData.map(item => [item.id, item]));
    
    let changesMade = false;
    
    // 3. Loop melalui data sheet (mulai dari baris 1, karena 0 adalah header)
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0]; // Kolom A (MapelID)
      const newData = dataMap.get(id);
      
      // Jika ID ini ada di data baru
      if (newData) {
        // Cek apakah nilainya berbeda
        if (data[i][2] != newData.isUS || data[i][3] != newData.isUP) {
          data[i][2] = newData.isUS; // Perbarui Kolom C (isUS)
          data[i][3] = newData.isUP; // Perbarui Kolom D (isUP)
          changesMade = true;
        }
      }
    }
    
    // 4. Jika ada perubahan, tulis kembali SEMUA data ke sheet
    if (changesMade) {
      dataRange.setValues(data);
      clearMapelCache(); // Hapus cache karena data berubah
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

// ===========================================
// [BARU] FUNGSI CRUD KELOLA SISWA
// ===========================================

/**
 * [HELPER] Membuka sheet Siswa, atau membuatnya jika belum ada.
 */
function getSiswaSheet(ss) {
  let sheet = ss.getSheetByName('Siswa');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  // [BARU] Set format kolom C (NISN) dan D (NIS_Lokal) ke Teks
  // Ini akan berlaku untuk sheet baru DAN sheet lama yang mungkin formatnya salah
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  // [BARU] Pastikan kolom Urutan (I) ada
  try {
    const header = sheet.getRange('I1').getValue();
    if (header !== 'Urutan') {
      sheet.getRange('I1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan: " + e.message);
  }

  return sheet;
}

/**
 * [SERVER] Mengambil daftar siswa dari sheet 'Siswa'.
 */
function getSiswa() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    const headers = data.shift(); // Ambil header
    
    const siswaList = data.map(row => {
      // [DIUBAH] Ambil nomor ID sebagai fallback urutan
      const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);

      // Ubah baris array menjadi objek agar mudah dibaca di client
      return {
        id: row[0],
        nama: row[1],
        nisn: row[2],
        nisLokal: row[3] || '',
        jk: row[4] || '',
        tempatLahir: row[5] || '',
        tglLahir: (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : '',
        kelas: row[7] || '',
        urutan: row[8] || idNum // [BARU] Ambil dari col I, atau fallback ke ID num
      };
    });

    // [DIUBAH] Urutkan siswa berdasarkan Kelas (A-Z), 
    // lalu berdasarkan Urutan (numerik)
    siswaList.sort((a, b) => {
      // 1. Urutkan berdasarkan Kelas
      const kelasCompare = a.kelas.localeCompare(b.kelas);
      if (kelasCompare !== 0) {
        return kelasCompare; // Kembalikan jika kelas berbeda
      }
      
      // 2. Jika kelas sama, urutkan berdasarkan 'urutan'
      // Pastikan 'urutan' adalah angka
      const urutanA = Number(a.urutan) || 0;
      const urutanB = Number(b.urutan) || 0;
      
      return urutanA - urutanB; // Urutkan angka secara menaik
    });
    
    return { status: "sukses", siswa: siswaList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menambah siswa baru ke sheet 'Siswa'.
 */
function createSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    // Validasi server-side
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    let maxIdNum = 0;
    let maxUrutan = 0;
    const nisnSet = new Set();

    for (let i = 1; i < data.length; i++) {
      // Cek NISN Duplikat
      if (data[i][2]) {
        nisnSet.add(String(data[i][2]));
      }
      
      // Cari Max ID
      const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) {
        maxIdNum = idNum;
      }
      
      // Cari Max Urutan
      const urutanNum = Number(data[i][8] || 0); // Cek Kolom I
      if (urutanNum > maxUrutan) {
        maxUrutan = urutanNum;
      }
    }
    
    // Cek duplikat NISN
    if (nisnSet.has(String(dataSiswa.nisn))) {
      return { status: "gagal", message: "NISN '" + dataSiswa.nisn + "' sudah terdaftar." };
    }

    // Tentukan ID dan Urutan baru
    // Kita gunakan max(maxId, maxUrutan) agar urutan tidak tumpang tindih
    const nextNum = Math.max(maxIdNum, maxUrutan) + 1;
    
    const newSiswaID = "SIS-" + nextNum;
    const newUrutan = nextNum;
    
    const newRow = [
      newSiswaID,
      dataSiswa.nama,
      dataSiswa.nisn,
      dataSiswa.nisLokal,
      dataSiswa.jk,
      dataSiswa.tempatLahir,
      dataSiswa.tglLahir || null, 
      dataSiswa.kelas,
      newUrutan // [PERBAIKAN] Set Urutan baru yang aman
    ];
    
    sheet.appendRow(newRow);

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Mengedit data siswa di sheet 'Siswa'.
 */
function updateSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    // Validasi server-side
    if (!dataSiswa.id || !dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data tidak lengkap. ID, Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == dataSiswa.id) { // Kolom SiswaID (index 0)
        rowToUpdate = i + 1; // getRange() adalah 1-indexed
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      return { status: "gagal", message: "SiswaID '" + dataSiswa.id + "' tidak ditemukan." };
    }
    
    // Buat data baris untuk update
    const updatedRow = [
      dataSiswa.id, // Kolom A (SiswaID)
      dataSiswa.nama, // Kolom B (NamaSiswa)
      dataSiswa.nisn, // Kolom C (NISN)
      dataSiswa.nisLokal, // Kolom D
      dataSiswa.jk, // Kolom E
      dataSiswa.tempatLahir, // Kolom F
      dataSiswa.tglLahir || null, // Kolom G
      dataSiswa.kelas // Kolom H
    ];
    
    // Update 1 baris penuh (Kolom A sampai H)
    sheet.getRange(rowToUpdate, 1, 1, updatedRow.length).setValues([updatedRow]);

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menghapus satu siswa dari sheet 'Siswa'.
 */
function deleteSiswa(siswaID) {
  try {
    validateAndRefreshSession();
    
    if (!siswaID) {
      return { status: "gagal", message: "SiswaID tidak boleh kosong." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    // Cari dari bawah ke atas agar aman saat menghapus
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == siswaID) { // Kolom SiswaID (index 0)
        sheet.deleteRow(i + 1); // i adalah 0-indexed, deleteRow adalah 1-indexed
        return { status: "sukses" };
      }
    }
    
    return { status: "gagal", message: "SiswaID '" + siswaID + "' tidak ditemukan." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menghapus semua siswa dari sheet 'Siswa'.
 */
function deleteAllSiswa() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);

    const lastRow = sheet.getLastRow();
    
    // Hapus semua baris KECUALI baris header (baris 1)
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    return { status: "sukses", message: "Semua data siswa telah dihapus." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA DATA SEKOLAH
// ===========================================

/**
 * [HELPER] Membuka sheet Data_Sekolah, atau membuatnya jika belum ada.
 * [UPDATE] Menambahkan format teks '@' untuk akun lama.
 */
function getDataSekolahSheet(ss) {
  let sheet = ss.getSheetByName('Data_Sekolah');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas akun lama)
    sheet = ss.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); // Pastikan sheet dibuat
  }
  return sheet;
}

// TAMBAHKAN FUNGSI HELPER BARU INI (setelah getDataSekolahSheet)
/**
 * [HELPER BARU] Mengambil jenjangPilihan (SD/MI/SMP/dll) dari sheet Data_Sekolah.
 * @param {string} spreadsheetID - ID spreadsheet milik sekolah.
 * @returns {string} Nilai jenjangPilihan (mis. "MI") or empty string.
 */
function getJenjangPilihanFromSheet(spreadsheetID) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss); // Menggunakan helper yg sudah ada
    const jenjangPilihan = sheet.getRange('A2').getValue(); // Ambil dari A2
    return String(jenjangPilihan);
  } catch (e) {
    Logger.log(`Gagal mengambil jenjangPilihan dari sheet ${spreadsheetID}: ${e.message}`);
    return ""; // Kembalikan string kosong jika gagal
  }
}

/**
 * [SERVER] Mengambil data sekolah dari sheet 'Data_Sekolah'.
 * [UPDATE] Mengirim nama sekolah sbg uppercase.
 */
function getSchoolData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const namaSekolah = userProperties.getProperty('namaSekolah'); // Sudah uppercase dari login/token
    const jenjangBase = userProperties.getProperty('jenjang'); // "SD/MI", "SMP/MTS", dll.
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    const data = sheet.getRange('A2:P2').getValues()[0];
    
    // Map data dari array ke objek agar mudah dibaca di client
    const dataSekolah = {
      jenjangBase: jenjangBase,
      namaSekolah: namaSekolah.toUpperCase(), // [UPDATE] Pastikan uppercase
      jenjangPilihan: data[0],
      npsn: data[1],
      nsm: data[2],
      alamat: data[3],
      provinsi: data[4],
      kabKot: data[5],
      pilihanKabKot: data[6],
      kecamatan: data[7],
      kelDes: data[8],
      pilihanKelDes: data[9],
      kodePos: data[10],
      telepon: data[11],
      email: data[12],
      website: data[13],
      namaKepsek: data[14],
      nipKepsek: data[15]
    };
    
    return { status: "sukses", data: dataSekolah };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan data sekolah ke sheet 'Data_Sekolah'.
 * [UPDATE] Menyimpan jenjangPilihan ke session.
 */
function saveSchoolData(data) {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    
    // [BARU] Update jenjangPilihan di session
    userProperties.setProperty('jenjangPilihan', data.jenjangPilihan);

    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    // Ubah objek kembali menjadi array DENGAN URUTAN YANG BENAR
    const dataArray = [
      data.jenjangPilihan, data.npsn, data.nsm, data.alamat, data.provinsi,
      data.kabKot, data.pilihanKabKot, data.kecamatan, data.kelDes, data.pilihanKelDes,
      data.kodePos, data.telepon, data.email, data.website, data.namaKepsek, data.nipKepsek
    ];
    
    // Tulis data ke baris 2
    sheet.getRange('A2:P2').setValues([dataArray]);
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA BOBOT NILAI
// ===========================================

/**
 * [HELPER] Membuka sheet Pengaturan, atau membuatnya jika belum ada.
 */
function getPengaturanSheet(ss) {
  let sheet = ss.getSheetByName('Pengaturan');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); // Default
    sheet.appendRow(['Bobot_Ujian', 40]); // Default
    SpreadsheetApp.flush();
  }
  return sheet;
}

/**
 * [SERVER] Mengambil data bobot dari sheet 'Pengaturan'.
 */
function getBobotData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let bobotRapor = 60; // Default
    let bobotUjian = 40; // Default

    // Loop untuk mencari berdasarkan nama (lebih kuat drpd B2/B3)
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Bobot_Rapor') {
        bobotRapor = data[i][1];
      } else if (data[i][0] === 'Bobot_Ujian') {
        bobotUjian = data[i][1];
      }
    }
    
    return { status: "sukses", bobotUjian: bobotUjian, bobotRapor: bobotRapor };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan data bobot ke sheet 'Pengaturan'.
 */
function saveBobotData(bobotRapor, bobotUjian) {
  try {
    validateAndRefreshSession(); // Validasi sesi
    
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);

    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let foundRapor = false;
    let foundUjian = false;

    // Loop untuk update berdasarkan nama
    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1; // Index baris (mulai dari 1)
      if (data[i][0] === 'Bobot_Rapor') {
        sheet.getRange('B' + rowIdx).setValue(bobotRapor);
        foundRapor = true;
      } else if (data[i][0] === 'Bobot_Ujian') {
        sheet.getRange('B' + rowIdx).setValue(bobotUjian);
        foundUjian = true;
      }
    }
    
    // Jika setting tidak ditemukan (mis. sheet lama), tambahkan
    if (!foundRapor) {
      sheet.appendRow(['Bobot_Rapor', bobotRapor]);
    }
    if (!foundUjian) {
      sheet.appendRow(['Bobot_Ujian', bobotUjian]);
    }

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA KELAS
// ===========================================

/**
 * [HELPER] Membuka sheet Kelas, atau membuatnya jika belum ada.
 */
function getKelasSheet(ss) {
  let sheet = ss.getSheetByName('Kelas');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

/**
 * [SERVER] Mengambil daftar kelas dari sheet 'Kelas'.
 */
function getKelas() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    data.shift(); // Hapus header
    
    // Ubah dari 2D array [[Kelas 1], [Kelas 2]] menjadi 1D array [Kelas 1, Kelas 2]
    const kelasList = data.map(row => row[0]).filter(nama => nama); // filter string kosong
    
    return { status: "sukses", kelas: kelasList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan daftar kelas ke sheet 'Kelas'.
 * Ini akan menghapus semua data lama dan menggantinya dengan yang baru.
 */
function saveKelas(kelasList) {
  try {
    validateAndRefreshSession(); // Validasi sesi

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);

    // 1. Hapus data lama (semua baris kecuali header)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    // 2. Tulis data baru jika ada
    if (kelasList && kelasList.length > 0) {
      // Ubah dari 1D array [Kelas 1, Kelas 2] menjadi 2D array [[Kelas 1], [Kelas 2]]
      const dataToSave = kelasList.map(nama => [nama]);
      
      // Tulis data ke sheet mulai dari baris 2, kolom 1
      sheet.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    }

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

// ===========================================
// [BARU] FUNGSI IMPORT SISWA (VERSI EXCEL)
// ===========================================

/**
 * [VERSI INSTAN] Mengirim template siswa statis (Base64)
 * yang sudah disimpan di konstanta global.
 */
function getSiswaTemplateUrl() {
  try {
    // 1. Validasi sesi (tetap penting)
    validateAndRefreshSession();

    // 2. Cek apakah konstanta ada
    if (!TEMPLATE_SISWA_BASE64 || TEMPLATE_SISWA_BASE64.length < 1000) {
      throw new Error("TEMPLATE_SISWA_BASE64 belum diatur di Kode.gs atau string-nya rusak/terlalu pendek.");
    }

    // 3. Langsung kirim data statis (super cepat!)
    return { 
      status: "sukses", 
      base64: TEMPLATE_SISWA_BASE64, 
      mimeType: TEMPLATE_SISWA_MIMETYPE,
      fileName: TEMPLATE_SISWA_FILENAME
    };

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Gagal memuat template: " + e.message };
  }
}


/**
 * [SERVER] Memproses import siswa dari file EXCEL (Base64).
 * Ini menggunakan Drive API (Advanced Service).
 */
function prosesImportExcelSiswa(fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;

  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const sheetKelas = getKelasSheet(ss);

    // 1. Decode Base64 dan buat file Excel sementara
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    // Simpan file Excel sementara ke Drive
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();

    // 2. Konversi file Excel ke Google Sheet sementara
    // Ini memerlukan "Drive API" (Layanan Lanjutan)
    const conversionResource = {
      title: `[TEMP] Konversi - ${fileName}`,
      mimeType: MimeType.GOOGLE_SHEETS
    };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, {
      convert: true
    });
    tempConvertedSheetId = convertedFile.id;
    
    // 3. Buka dan Baca Google Sheet sementara
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0]; // Ambil sheet pertama
    const excelData = dataSheet.getDataRange().getValues();

    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    const header = excelData.shift(); // Hapus baris header

    // 4. Dapatkan data existing (NISN & Kelas) - LOGIKA INI SAMA DENGAN SEBELUMNYA
    const dataNisn = sheetSiswa.getRange('C2:C' + sheetSiswa.getLastRow()).getValues()
                       .map(row => String(row[0]).trim()) // Paksa jadi string dan trim
                       .filter(nisn => nisn);
    const existingNisnSet = new Set(dataNisn);

    const dataKelas = sheetKelas.getRange('A2:A' + sheetKelas.getLastRow()).getValues()
                        .map(row => String(row[0]).trim()) // Paksa jadi string dan trim
                        .filter(kelas => kelas);
    const existingKelasSet = new Set(dataKelas);

    // 5. Siapkan variabel loop
    const gagalList = [];
    const rowsToAppend = [];
    // const lastRowIndex = sheetSiswa.getLastRow(); // [DIHAPUS] Logika lama tidak aman
    
    // [BARU] Dapatkan data ID dan Urutan yang ada
    const existingData = sheetSiswa.getDataRange().getValues();
    let maxIdNum = 0;
    let maxUrutan = 0;
    for (let i = 1; i < existingData.length; i++) {
      const idNum = parseInt((existingData[i][0] || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      
      const urutanNum = Number(existingData[i][8] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    
    // [BARU] Tentukan nomor awal
    let nextNum = Math.max(maxIdNum, maxUrutan) + 1;

    // 6. Loop dan validasi setiap baris dari data Excel
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2; // +1 (karena 0-index) +1 (karena header)

      // Pastikan urutan ini sama dengan template
      const nama = (row[0] ? String(row[0]) : '').trim();
      const nisn = (row[1] ? String(row[1]) : '').trim();
      const nisLokal = (row[2] ? String(row[2]) : '').trim();
      const jk = (row[3] ? String(row[3]) : '').trim().toUpperCase();
      const tempatLahir = (row[4] ? String(row[4]) : '').trim();
      // Tangani tanggal dari Excel (bisa jadi objek Date)
      let tglLahir = (row[5] ? row[5] : '');
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      } else {
        tglLahir = String(tglLahir).trim();
      }
      const kelas = (row[6] ? String(row[6]) : '').trim();

      // Validasi 1: Data Wajib
      if (!nama || !nisn || !jk || !kelas) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Data wajib (Nama, NISN, JK, Kelas) tidak lengkap." });
        continue;
      }
      
      // Validasi 2: Duplikat NISN
      if (existingNisnSet.has(nisn)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "NISN sudah terdaftar." });
        continue;
      }

      // Validasi 3: Jenis Kelamin (L/P)
      if (jk !== 'L' && jk !== 'P') {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Jenis Kelamin harus 'L' atau 'P'." });
        continue;
      }

      // Validasi 4: Kelas
      if (!existingKelasSet.has(kelas)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: `Kelas '${kelas}' tidak ditemukan di Data Kelas.` });
        continue;
      }

      // [VALIDASI LOLOS]
      const newSiswaID = "SIS-" + nextNum;
      const newUrutan = nextNum;
      
      const newRow = [
        newSiswaID, nama, nisn, nisLokal, jk, 
        tempatLahir, (tglLahir || null), kelas,
        newUrutan // [PERBAIKAN] Tambahkan 'urutan' ke Kolom I
      ];
      
      rowsToAppend.push(newRow);
      existingNisnSet.add(nisn);
      nextNum++; // [BARU] Naikkan counter untuk siswa berikutnya
    }

    // 7. Simpan data baru (Batch Append)
    if (rowsToAppend.length > 0) {
      sheetSiswa.getRange(sheetSiswa.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
                .setValues(rowsToAppend);
    }

    // 8. Hapus file sementara
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);

    // 9. Kembalikan Laporan
    return { 
      status: "sukses", 
      totalDiProses: excelData.length, 
      berhasilDiUpload: rowsToAppend.length, 
      gagalDiUpload: gagalList.length, 
      dataGagal: gagalList 
    };

  } catch (e) {
    Logger.log(e);
    // Hapus file sementara jika terjadi error
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

/**
 * [BARU] Memindahkan urutan siswa (Naik/Turun)
 * dengan menukar nilai 'Urutan' mereka.
 */
function moveSiswaUrutan(siswaID, direction) {
  try {
    validateAndRefreshSession();
    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    const headers = data.shift();
    
    // 1. Temukan data siswa yang akan dipindah (target)
    let targetRowIndex = -1; // 0-based index di array 'data'
    let targetData = null;
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === siswaID) {
        targetRowIndex = i;
        targetData = {
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0)),
          sheetRow: i + 2 // 1-based sheet row
        };
        break;
      }
    }
    
    if (!targetData) {
      throw new Error("SiswaID tidak ditemukan.");
    }
    
    // 2. Buat daftar "teman sekelas"
    const classmates = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i][7] === targetData.kelas) { // Jika kelas sama
        const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
        classmates.push({
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || idNum),
          sheetRow: i + 2 // 1-based sheet row
        });
      }
    }
    
    // 3. Urutkan teman sekelas
    classmates.sort((a, b) => a.urutan - b.urutan);
    
    // 4. Temukan siswa target dan siswa untuk ditukar
    let targetIndexInClass = classmates.findIndex(s => s.id === siswaID);
    let swapTarget = null;
    
    if (direction === 'up' && targetIndexInClass > 0) {
      swapTarget = classmates[targetIndexInClass - 1];
    } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
      swapTarget = classmates[targetIndexInClass + 1];
    }
    
    // 5. Lakukan penukaran
    if (swapTarget) {
      // Ambil nilai 'Urutan' mereka
      const targetUrutanVal = targetData.urutan;
      const swapUrutanVal = swapTarget.urutan;
      
      // Tukar nilai di sheet (Kolom I)
      sheet.getRange(targetData.sheetRow, 9).setValue(swapUrutanVal);
      sheet.getRange(swapTarget.sheetRow, 9).setValue(targetUrutanVal);
      
      return { status: "sukses" };
    }
    
    return { status: "gagal", message: "Tidak bisa bergerak lebih jauh." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU] Menyimpan urutan siswa secara batch.
 * Menerima array: [{id: "SIS-1", urutan: 10}, {id: "SIS-2", urutan: 20}]
 */
function saveSiswaUrutanBatch(urutanData) {
  try {
    validateAndRefreshSession();
    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    // 1. Ambil semua data dari sheet
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    
    // 2. Buat Peta (Map) dari data baru untuk pencarian cepat
    // Peta: "SIS-1" -> 10, "SIS-2" -> 20
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    
    let changesMade = false;
    
    // 3. Loop melalui data sheet (mulai dari baris 1, karena 0 adalah header)
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0]; // Kolom A (SiswaID)
      const newUrutan = urutanMap.get(id);
      
      // Jika ID ini ada di data baru DAN nilainya berbeda
      if (newUrutan !== undefined && data[i][8] != newUrutan) { // Kolom I (Urutan)
        data[i][8] = newUrutan; // Perbarui nilai di array
        changesMade = true;
      }
    }
    
    // 4. Jika ada perubahan, tulis kembali SEMUA data ke sheet
    if (changesMade) {
      // Kita menulis ulang semua data (termasuk header)
      dataRange.setValues(data);
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}
