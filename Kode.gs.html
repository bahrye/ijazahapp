const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

const MASTER_SHEET_CACHE_KEY = 'MASTER_SHEET_DATA_V1';

const MAPEL_CACHE_KEY = 'mapel_data_v1';
const SISWA_CACHE_KEY = 'siswa_data_v1';
const NILAI_GRID_CACHE_KEY_PREFIX = 'nilai_grid_v1_';
const REKAP_NILAI_CACHE_KEY = 'rekap_nilai_v1';
const NILAI_RAPOR_GRID_CACHE_KEY_PREFIX = 'nilai_rapor_grid_v1_';
const REKAP_NILAI_RAPOR_CACHE_KEY = 'rekap_nilai_rapor_v1';

const TEMPLATE_SISWA_FILENAME = "template_import_siswa.xlsx";
const TEMPLATE_SISWA_MIMETYPE = MimeType.MICROSOFT_EXCEL;

const SHEET_REGISTRASI_PENDING = "Registrasi_Pending";
const TOKEN_EXPIRY_HOURS = 24; // Token berlaku 24 jam

const NILAI_IJAZAH_CACHE_KEY = 'nilai_ijazah_v1';

/**
 * Mengubah array byte (dari computeDigest) menjadi string heksadesimal.
 */
function bytesToHex(bytes) {
  return bytes.map(byte => {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}

/**
 * Membuat string salt acak yang unik.
 */
function generateSalt() {
  return Utilities.getUuid();
}

/**
 * Membuat hash SHA-256 dari password dan salt.
 * Mengembalikan hash sebagai string hex.
 */
function hashPassword(password, salt) {
  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password + salt, Utilities.Charset.UTF_8);
  return bytesToHex(digest);
}

/**
 * Memverifikasi apakah password inputan cocok dengan hash yang tersimpan.
 */
function verifyPassword(inputPassword, storedHash, storedSalt) {
  const newHash = hashPassword(inputPassword, storedSalt);
  return newHash === storedHash;
}

/**
 * Fungsi baru untuk mendapatkan atau membuat sheet Registrasi_Pending.
 */
function getSheetRegistrasiPending(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_REGISTRASI_PENDING);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_REGISTRASI_PENDING);
    // Kolom: Email, NamaSekolah, Jenjang, Password, Token, Timestamp
    sheet.appendRow(['Email', 'NamaSekolah', 'Jenjang', 'Password', 'VerificationToken', 'Timestamp']);
    sheet.setFrozenRows(1);
  }
  return sheet;
}

function doGet(e) {
  // Cek apakah ada parameter 'v' (untuk verifikasi)
  if (e.parameter.v) {
    const token = e.parameter.v;
    // Proses token dan dapatkan pesan HTML
    const message = prosesVerifikasiToken(token);
    
    // Tampilkan halaman 'verifikasi.html' dan ganti kontennya dengan pesan hasil
    return HtmlService.createTemplateFromFile('verifikasi')
      .evaluate()
      .setTitle('Verifikasi Akun')
      .setContent(`<div>${message}</div>`); // Mengganti konten <body>
  }
  
  // Jika tidak ada parameter 'v', jalankan aplikasi utama seperti biasa
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

// --- FUNGSI BARU ---
/**
 * Mengirim email verifikasi ke pengguna.
 */
function kirimEmailVerifikasi(email, namaSekolah, token) {
  try {
    const url = ScriptApp.getService().getUrl() + '?v=' + token;
    const subject = "Verifikasi Akun Aplikasi Nilai Ijazah";
    const body = `
      <div style="font-family: Arial, sans-serif; line-height: 1.6;">
        <p>Halo, Admin ${namaSekolah},</p>
        <p>Terima kasih telah mendaftar di Aplikasi Pengolahan Nilai Ijazah.</p>
        <p>Untuk mengaktifkan akun Anda, silakan klik tombol di bawah ini:</p>
        <p style="margin: 25px 0;">
          <a href="${url}" style="font-size: 16px; font-weight: bold; padding: 12px 20px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 5px;">
            Aktivasi Akun Saya
          </a>
        </p>
        <p>Jika tombol di atas tidak berfungsi, salin dan tempel URL berikut di browser Anda:</p>
        <p style="word-break: break-all;">${url}</p>
        <p>Link ini akan kedaluwarsa dalam ${TOKEN_EXPIRY_HOURS} jam.</p>
        <br>
        <p>Terima kasih.</p>
      </div>
    `;

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body,
      name: "Admin Aplikasi Ijazah" // Nama pengirim
    });
    Logger.log("Email verifikasi terkirim ke: " + email);
  } catch (e) {
    Logger.log(`Gagal mengirim email verifikasi ke ${email}: ${e.message}`);
    // Sebaiknya jangan gagalkan registrasi jika email gagal, cukup log saja
  }
}

// --- FUNGSI BARU (HASIL REFATOR DARI prosesRegistrasi) ---
/**
 * Fungsi ini berisi LOGIKA PEMBUATAN SPREADSHEET YANG SEBENARNYA.
 * Dipanggil HANYA SETELAH verifikasi berhasil.
 */
function buatDatabaseSekolahBaru(namaSekolah, jenjang, email, password, masterSS) {
  let newSSID = null; 
  try {
    let targetFolder;
    try {
      targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      throw new Error("Error: Folder target tidak ditemukan atau tidak dapat diakses. ID: " + TARGET_FOLDER_ID);
    }

    // (Ini adalah LOGIKA LAMA Anda dari prosesRegistrasi, baris 246-333)
    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); 
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (via verifikasi): " + newSSID);

    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); 
    DriveApp.getRootFolder().removeFile(newFile); 
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName());

    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    
    const sheetKelas = newSpreadsheet.insertSheet('Kelas');
    sheetKelas.appendRow(['NamaKelas']); 

    let defaultKelas = '';
    switch (jenjang) {
      case 'SD/MI':
        defaultKelas = 'VI';
        break;
      case 'SMP/MTS':
        defaultKelas = 'IX';
        break;
      case 'SMA/MA':
        defaultKelas = 'XII';
        break;
    }
    
    if (defaultKelas) {
      sheetKelas.appendRow([defaultKelas]);
    }
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    sheetMapel.appendRow(['MapelID', 'NamaMapel', 'isUS', 'isUP']); 

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      sheetMapel.getRange(2, 1, defaultMapel.length, 4).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Rapor')
      .appendRow([
        'SiswaID', 'MapelID', 
        'Sem1_P', 'Sem1_K', 'Sem2_P', 'Sem2_K', 
        'Sem3_P', 'Sem3_K', 'Sem4_P', 'Sem4_K', 'Sem5_P', 'Sem5_K'
      ]);

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
      
    // --- PERBAIKAN SKEMA RAPOR ---
    // Pastikan sheet baru juga menggunakan skema yang benar
    newSpreadsheet.insertSheet('Nilai_Rapor_Akhir')
      .appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    // --- AKHIR PERBAIKAN ---
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);
    sheetSetting.appendRow(['Jumlah_Semester', 5]);
    sheetSetting.appendRow(['KKM', 76]);

    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    let jenjangPilihanDefault = '';
    if (jenjang === 'SD/MI') {
      jenjangPilihanDefault = 'MI';
    } else if (jenjang === 'SMP/MTS') {
      jenjangPilihanDefault = 'MTS';
    } else if (jenjang === 'SMA/MA') {
      jenjangPilihanDefault = 'MA';
    }
    
    sheetDataSekolah.appendRow([
      jenjangPilihanDefault, 
      '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    newSpreadsheet.deleteSheet(defaultSheet);
    // (AKHIR DARI LOGIKA LAMA)

    // Kembalikan SSID yang baru dibuat
    return newSSID;

  } catch (e) {
    Logger.log(e);
    // Jika gagal, hapus spreadsheet yang mungkin setengah jadi
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    // Lempar error ke 'prosesVerifikasiToken'
    throw new Error("Gagal membuat database: " + e.message);
  }
}

function prosesVerifikasiToken(token) {
  if (!token) {
    return "<h1>Token Tidak Ditemukan</h1><p>Permintaan verifikasi tidak valid.</p>";
  }
  
  let masterSS;
  let sheetSekolah;
  let sheetPending;
  
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    sheetPending = getSheetRegistrasiPending(masterSS); 

    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbToken = row[4];
      const dbTimestamp = new Date(row[5]).getTime();

      if (dbToken === token) {
        if (dbTimestamp < expiryLimit) {
          sheetPending.deleteRow(i + 1);
          return "<h1>Token Kedaluwarsa</h1><p>Link verifikasi Anda sudah kedaluwarsa (lebih dari " + TOKEN_EXPIRY_HOURS + " jam). Silakan lakukan registrasi ulang.</p>";
        }

        const email = row[0];
        const namaSekolah = row[1];
        const jenjang = row[2];
        const password = row[3];
        
        const dataSekolah = sheetSekolah.getDataRange().getValues();
        for (let j = 1; j < dataSekolah.length; j++) {
          if (dataSekolah[j][3] === email) {
            sheetPending.deleteRow(i + 1);
            return "<h1>Akun Sudah Aktif</h1><p>Akun Anda dengan email ini sudah terverifikasi dan aktif. Silakan login.</p>";
          }
        }

        try {
          const newSSID = buatDatabaseSekolahBaru(namaSekolah, jenjang, email, password, masterSS);
          
          const newSalt = generateSalt();
          const newHash = hashPassword(password, newSalt);
          
          const newSekolahID = "SKL-" + (sheetSekolah.getLastRow());
          sheetSekolah.appendRow([
            newSekolahID, 
            namaSekolah.toUpperCase(), 
            jenjang, 
            email, 
            newHash, 
            newSSID,
            newSalt
          ]);

          sheetPending.deleteRow(i + 1);
          
          clearMasterSheetCache();
          
          return "<h1>Verifikasi Berhasil!</h1><p>Akun Anda telah berhasil diaktifkan. Anda sekarang dapat menutup halaman ini dan login ke aplikasi.</p>";
          
        } catch (e) {
          Logger.log(`Verifikasi sukses untuk ${email} TAPI GAGAL buat DB: ${e.message}`);
          return `<h1>Verifikasi Berhasil, Namun...</h1><p>Terjadi error saat membuat database untuk sekolah Anda. Silakan hubungi admin. (Error: ${e.message})</p>`;
        }
      }
    }
    
    return "<h1>Token Tidak Valid</h1><p>Token verifikasi Anda tidak ditemukan. Mungkin sudah digunakan atau tidak valid.</p>";

  } catch (e) {
    Logger.log(e);
    return `<h1>Error Server</h1><p>Terjadi error: ${e.message}. Silakan coba lagi nanti.</p>`;
  } finally {
    lock.releaseLock();
  }
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function getCachedMasterSheetData() {
  const cache = CacheService.getScriptCache();
  
  let cachedData = cache.get(MASTER_SHEET_CACHE_KEY);
  if (cachedData != null) {
    Logger.log("Mengambil data Master Sheet dari SCRIPT CACHE");
    return JSON.parse(cachedData);
  }
  
  Logger.log("Mengambil data Master Sheet dari SPREADSHEET (Fresh)");
  let masterSS;
  try {
     masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  } catch (e) {
    Logger.log("Gagal membuka Master Sheet ID: " + MASTER_SHEET_ID + ". Error: " + e.message);
    throw new Error("Database Master tidak dapat diakses. Hubungi Admin.");
  }

  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  if (!sheetSekolah) {
    Logger.log("Sheet 'Sheet_Sekolah' tidak ditemukan di Master Sheet.");
    throw new Error("Database Master tidak dikonfigurasi. Hubungi Admin.");
  }
  
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  
  cache.put(MASTER_SHEET_CACHE_KEY, JSON.stringify(dataSekolah), 3600); 
  
  return dataSekolah;
}

function clearMasterSheetCache() {
  try {
    CacheService.getScriptCache().remove(MASTER_SHEET_CACHE_KEY);
    Logger.log("Cache Master Sheet dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache Master Sheet: " + e.message);
  }
}

function clearRekapNilaiCache() {
  try {
    const userCache = CacheService.getUserCache();
    userCache.remove(REKAP_NILAI_CACHE_KEY);
    userCache.remove(NILAI_IJAZAH_CACHE_KEY);
    Logger.log("Cache Rekap Nilai dan Ijazah dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache rekap nilai: " + e.message);
  }
}

function clearNilaiUjianCache() {
  try {
    const userCache = CacheService.getUserCache();
    userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM');
    userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek');
    Logger.log("Cache Nilai Ujian (UM & Praktek) dibersihkan.");
    
    clearRekapNilaiCache(); 
  } catch (e) {
    Logger.log("Gagal membersihkan cache nilai ujian: " + e.message);
  }
}

function clearRekapNilaiRaporCache() {
  try {
    const userCache = CacheService.getUserCache();
    userCache.remove(REKAP_NILAI_RAPOR_CACHE_KEY);
    userCache.remove(NILAI_IJAZAH_CACHE_KEY);
    Logger.log("Cache Rekap Nilai Rapor dan Ijazah dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache rekap nilai rapor: " + e.message);
  }
}

function clearNilaiRaporCache() {
  try {
    const userCache = CacheService.getUserCache();
    
    // 1. Hapus cache rekap rapor utama
    userCache.remove(REKAP_NILAI_RAPOR_CACHE_KEY);
    Logger.log("Cache Rekap Nilai Rapor (Utama) dibersihkan.");

    // 2. Dapatkan daftar semester untuk menghapus cache grid-nya
    //    Kita bisa memanggil getSemesterList() karena properti pengguna 
    //    sudah di-set oleh fungsi pemanggil (misal: saveMapelTipeUjianBatch).
    const semesterListData = getSemesterList(); 
    if (semesterListData.status === 'sukses') {
      semesterListData.semesterList.forEach(semester => {
        const cacheKey = NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semester.id;
        userCache.remove(cacheKey);
        Logger.log("Cache Grid Nilai Rapor dibersihkan untuk: " + semester.id);
      });
    } else {
        Logger.log("Peringatan: Gagal mendapatkan daftar semester saat membersihkan cache grid rapor.");
    }
    
  } catch (e) {
    Logger.log("Gagal membersihkan cache nilai rapor: " + e.message);
  }
}

function clearSiswaCache() {
  try {
    CacheService.getUserCache().remove(SISWA_CACHE_KEY);
    Logger.log("Cache Siswa dibersihkan.");
    
    clearNilaiUjianCache(); 
    clearNilaiRaporCache();
    CacheService.getUserCache().remove(NILAI_IJAZAH_CACHE_KEY);
    
  } catch (e) {
    Logger.log("Gagal membersihkan cache siswa: " + e.message);
  }
}

function clearMapelCache() {
  try {
    CacheService.getUserCache().remove(MAPEL_CACHE_KEY);
    Logger.log("Cache Mapel dibersihkan.");
    
    clearNilaiUjianCache();
    clearNilaiRaporCache();
    CacheService.getUserCache().remove(NILAI_IJAZAH_CACHE_KEY);
  } catch (e) {
    Logger.log("Gagal membersihkan cache mapel: " + e.message);
  }
}

function prosesLogin(email, password) {
  try {
    const dataSekolahFromCache = getCachedMasterSheetData();
    let cachedRow = null;
    let passwordIsValid = false;

    for (let i = 1; i < dataSekolahFromCache.length; i++) {
      const row = dataSekolahFromCache[i];
      const dbEmail = row[3]; 
      
      if (dbEmail === email) {
        const dbHashOrPassword = row[4]; 
        const dbSalt = row[6]; 
        
        if (dbSalt) {
          passwordIsValid = verifyPassword(password, dbHashOrPassword, dbSalt);
        } else {
          passwordIsValid = (dbHashOrPassword === password);
        }

        if (passwordIsValid) {
          cachedRow = row; 
        }
        break; 
      }
    }

    if (!passwordIsValid || !cachedRow) {
      return { status: "gagal", message: "Email atau password salah." };
    }

    Logger.log(`Verifikasi live data untuk: ${email}`);
    
    let masterSS;
    let sheetSekolah;
    try {
      masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
      sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
      if (!sheetSekolah) {
        throw new Error("Sheet_Sekolah tidak ditemukan.");
      }
    } catch (e) {
      Logger.log("Gagal membuka Master Sheet saat verifikasi login: " + e.message);
      return { status: "gagal", message: "Gagal memverifikasi akun. Hubungi Admin." };
    }

    const emailColumnRange = sheetSekolah.getRange('D:D');
    const textFinder = emailColumnRange.createTextFinder(email).matchEntireCell(true);
    const foundCell = textFinder.findNext();

    let liveRowFound = false;

    if (foundCell) {
      const rowIndex = foundCell.getRow();
      const livePassDataRange = sheetSekolah.getRange(rowIndex, 5, 1, 3); 
      const livePassDataValues = livePassDataRange.getValues()[0];
      const liveHash = livePassDataValues[0]; 
      const liveSalt = livePassDataValues[2]; 
      
      if (verifyPassword(password, liveHash, liveSalt)) {
          liveRowFound = true;
      }
    }

    if (!liveRowFound) {
        Logger.log(`Login GAGAL untuk ${email}: Ditemukan di cache, TAPI tidak ada di live data (mungkin dihapus atau password diubah).`);
        clearMasterSheetCache(); 
        return { status: "gagal", message: "Email atau password salah." };
    }

    const token = Utilities.getUuid();
    const now = new Date().getTime(); 
    const namaSekolahUpper = cachedRow[1].toUpperCase();
    const userSpreadsheetID = cachedRow[5]; 
    
    const userProperties = PropertiesService.getUserProperties();
    userProperties.setProperty('sessionToken', token);
    userProperties.setProperty('lastActivity', now.toString());
    
    const jenjangPilihan = getJenjangPilihanFromSheet(userSpreadsheetID);

    userProperties.setProperty('sekolahID', cachedRow[0]);
    userProperties.setProperty('namaSekolah', namaSekolahUpper); 
    userProperties.setProperty('jenjang', cachedRow[2]); 
    userProperties.setProperty('spreadsheetID', userSpreadsheetID); 
    userProperties.setProperty('jenjangPilihan', jenjangPilihan); 
    
    return { 
      status: "sukses", 
      namaSekolah: namaSekolahUpper,
      jenjang: cachedRow[2], 
      jenjangPilihan: jenjangPilihan, 
      token: token
    };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesRegistrasi(namaSekolah, jenjang, email, password) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);

  try {
    if (!namaSekolah || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    
    let sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (sheetSekolah) {
      const dataSekolah = sheetSekolah.getDataRange().getValues();
      for (let i = 1; i < dataSekolah.length; i++) {
        if (dataSekolah[i][3] === email) {
          return { status: "gagal", message: "Email ini sudah terdaftar dan aktif." };
        }
      }
    } else {
       sheetSekolah = masterSS.insertSheet('Sheet_Sekolah');
       sheetSekolah.appendRow(['SekolahID', 'NamaSekolah', 'Jenjang', 'EmailAdmin', 'HashedPassword', 'SpreadsheetID', 'Salt']);
    }
    
    const sheetPending = getSheetRegistrasiPending(masterSS);
    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbEmail = row[0];
      const dbTimestamp = new Date(row[5]).getTime();

      if (dbEmail === email) {
        if (dbTimestamp < expiryLimit) {
          sheetPending.deleteRow(i + 1);
          Logger.log(`Registrasi pending kedaluwarsa untuk ${email} dihapus.`);
          break; 
        } else {
          const dbNamaSekolah = row[1];
          const dbToken = row[4];
          kirimEmailVerifikasi(email, dbNamaSekolah, dbToken);
          return { 
            status: "pending", 
            message: "Email ini sudah terdaftar dan menunggu verifikasi. Kami telah mengirim ulang link verifikasi ke email Anda." 
          };
        }
      }
    }

    const verificationToken = Utilities.getUuid() + Utilities.getUuid();
    const namaSekolahUpper = namaSekolah.toUpperCase();

    sheetPending.appendRow([
      email,
      namaSekolahUpper,
      jenjang,
      password,
      verificationToken,
      now 
    ]);
    
    kirimEmailVerifikasi(email, namaSekolahUpper, verificationToken);

    return { 
      status: "pending", 
      message: "Registrasi awal berhasil! Kami telah mengirimkan link verifikasi ke email Anda. Silakan cek inbox (atau folder spam)." 
    };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  } finally {
    lock.releaseLock();
  }
}

function prosesLogout() {
  try {
    PropertiesService.getUserProperties().deleteAllProperties();
    
    // --- PERBAIKAN DI SINI ---
    // Panggil fungsi pembersih cache yang sudah ada.
    // Fungsi-fungsi ini sudah otomatis membersihkan cache nilai dan rekap juga.
    clearSiswaCache();
    clearMapelCache(); 
    
    Logger.log("User cache dan properti dibersihkan saat logout.");
    // --- AKHIR PERBAIKAN ---

    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateAndRefreshSession() {
  const userProperties = PropertiesService.getUserProperties();
  const lastActivityStr = userProperties.getProperty('lastActivity');
  const storedToken = userProperties.getProperty('sessionToken');
  
  if (!storedToken || !lastActivityStr) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  
  const lastActivity = parseInt(lastActivityStr, 10);
  const now = new Date().getTime();

  // --- PERUBAHAN DI SINI ---
  // Mengembalikan durasi menjadi 3 jam
  const threeHours = 3 * 60 * 60 * 1000; 
  
  if (now - lastActivity > threeHours) { // Menggunakan variabel 'threeHours'
    userProperties.deleteAllProperties();
    // Mengembalikan pesan error
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  // --- AKHIR PERUBAHAN ---
  
  userProperties.setProperty('lastActivity', now.toString());
  return userProperties;
}

function checkToken(tokenFromClient) {
  try {
    const userProperties = validateAndRefreshSession(); 
    const storedToken = userProperties.getProperty('sessionToken');

    if (tokenFromClient === storedToken) {
      return { 
        status: "sukses", 
        namaSekolah: userProperties.getProperty('namaSekolah').toUpperCase(),
        jenjang: userProperties.getProperty('jenjang'),
        jenjangPilihan: userProperties.getProperty('jenjangPilihan') 
      };
    } else {
      userProperties.deleteAllProperties();
      return { status: "gagal", message: "Token tidak cocok. Silakan login ulang." };
    }
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; 
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); 

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; 
      const mapelID = row[1];     
      const namaMapel = row[2];   
      
      const val_us = row[3]; 
      const val_up = row[4]; 

      let isUS_default = false;
      let isUP_default = false;

      if (val_us === true) {
        isUS_default = true;
      } else if (typeof val_us === 'string') {
        isUS_default = val_us.trim().toUpperCase() === 'TRUE';
      }

      if (val_up === true) {
        isUP_default = true;
      } else if (typeof val_up === 'string') {
        isUP_default = val_up.trim().toUpperCase() === 'TRUE';
      }
      
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { 
          defaultMapel.push([mapelID, namaMapel, isUS_default, isUP_default]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; 
  }
}

function getMapelSheet() {
  const userProperties = validateAndRefreshSession();
  const spreadsheetID = userProperties.getProperty('spreadsheetID');
  
  const ss = SpreadsheetApp.openById(spreadsheetID);
  const sheetMapel = ss.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  return sheetMapel;
}

function getMapel() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedMapel = userCache.get(MAPEL_CACHE_KEY);

    if (cachedMapel != null) {
      Logger.log("Mengambil mapel dari CACHE");
      return { status: "sukses", mapel: JSON.parse(cachedMapel) };
    }
    
    Logger.log("Mengambil mapel dari SPREADSHEET (via getMapel)");
    
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const mapel = getMapelDataInternal(ss); 
    
    userCache.put(MAPEL_CACHE_KEY, JSON.stringify(mapel), 600); 
    
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); 
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toUpperCase() === mapelID.toUpperCase()) {
        return { status: "gagal", message: "MapelID '" + mapelID + "' sudah ada." };
      }
    }
    
    sheetMapel.appendRow([mapelID, namaMapel, false, false]);
    
    clearMapelCache();
    return { status: "sukses" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); 
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === mapelID) {
        sheetMapel.getRange(i + 1, 2).setValue(namaMapel);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteMapel(mapelID) {
  try {
    const sheetMapel = getMapelSheet(); 
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === mapelID) {
        sheetMapel.deleteRow(i + 1);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function syncDefaultMapel() {
  try {
    const userProperties = validateAndRefreshSession();
    const jenjang = userProperties.getProperty('jenjang');
    
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sourceData = getDynamicDefaultMapel(jenjang, masterSS); 
    
    const sourceMap = new Map();
    sourceData.forEach(row => {
      sourceMap.set(row[0], { name: row[1], isUS: row[2], isUP: row[3] });
    });

    const sheetMapel = getMapelSheet(); 
    const targetRange = sheetMapel.getDataRange();
    const targetValues = targetRange.getValues();
    const targetHeader = targetValues.shift(); 
    
    const targetIdSet = new Set(targetValues.map(row => row[0]));

    const mapelToAdd = [];
    let changesMade = false;

    for (let i = 0; i < targetValues.length; i++) {
      const targetId = targetValues[i][0]; 
      const sourceRowData = sourceMap.get(targetId); 

      if (sourceRowData) {
        if (targetValues[i][2] !== sourceRowData.isUS || 
            targetValues[i][3] !== sourceRowData.isUP) 
        {
          targetValues[i][2] = sourceRowData.isUS;
          targetValues[i][3] = sourceRowData.isUP;
          changesMade = true;
        }
      }
    }

    for (const [sourceId, sourceData] of sourceMap.entries()) {
      if (!targetIdSet.has(sourceId)) {
        mapelToAdd.push([sourceId, sourceData.name, sourceData.isUS, sourceData.isUP]);
      }
    }
    
    let message = "";
    if (changesMade) {
      sheetMapel.getRange(2, 1, targetValues.length, 4).setValues(targetValues);
      message += "Data mapel yang ada telah diperbarui. ";
    }
    
    if (mapelToAdd.length > 0) {
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 4)
                .setValues(mapelToAdd);
      message += `Berhasil menambahkan ${mapelToAdd.length} mapel default yang hilang.`;
    }

    if (!changesMade && mapelToAdd.length === 0) {
      message = "Data mapel Anda sudah sinkron. Tidak ada yang diubah.";
    }

    clearMapelCache();
    return { status: "sukses", message: message };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllMapel() {
  try {
    const sheetMapel = getMapelSheet(); 
    const lastRow = sheetMapel.getLastRow();
    
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache();
    return { status: "sukses", message: "Semua mapel telah dihapus." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveMapelTipeUjianBatch(tipeUjianData) {
  try {
    validateAndRefreshSession();
    
    const sheetMapel = getMapelSheet();
    
    const dataRange = sheetMapel.getDataRange();
    const data = dataRange.getValues(); 
    
    const dataMap = new Map(tipeUjianData.map(item => [item.id, item]));
    
    let changesMade = false;
    
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0]; 
      const newData = dataMap.get(id);
      
      if (newData) {
        if (data[i][2] != newData.isUS || data[i][3] != newData.isUP) {
          data[i][2] = newData.isUS; 
          data[i][3] = newData.isUP; 
          changesMade = true;
        }
      }
    }
    
    if (changesMade) {
      dataRange.setValues(data);
      clearMapelCache(); 
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getSiswaSheet(ss) {
  let sheet = ss.getSheetByName('Siswa');
  if (!sheet) {
    sheet = ss.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  try {
    const header = sheet.getRange('I1').getValue();
    if (header !== 'Urutan') {
      sheet.getRange('I1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan: " + e.message);
  }

  return sheet;
}

function getSiswa() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedSiswa = userCache.get(SISWA_CACHE_KEY);

    if (cachedSiswa != null) {
      Logger.log("Mengambil siswa dari USER CACHE");
      return { status: "sukses", siswa: JSON.parse(cachedSiswa) };
    }
    Logger.log("Mengambil siswa dari SPREADSHEET");

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    const headers = data.shift(); 
    
    const siswaList = data.map(row => {
      const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);

      return {
        id: row[0],
        nama: row[1],
        nisn: row[2],
        nisLokal: row[3] || '',
        jk: row[4] || '',
        tempatLahir: row[5] || '',
        tglLahir: (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : '',
        kelas: row[7] || '',
        urutan: row[8] || idNum 
      };
    });

    siswaList.sort((a, b) => {
      const kelasCompare = a.kelas.localeCompare(b.kelas);
      if (kelasCompare !== 0) {
        return kelasCompare; 
      }
      
      const urutanA = Number(a.urutan) || 0;
      const urutanB = Number(b.urutan) || 0;
      
      return urutanA - urutanB; 
    });
    
    userCache.put(SISWA_CACHE_KEY, JSON.stringify(siswaList), 3600); 
    
    return { status: "sukses", siswa: siswaList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function createSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const lastRow = sheet.getLastRow();
    let nextNum = 1;
    const nisnSet = new Set();

    if (lastRow > 1) {
      const lastRowData = sheet.getRange(lastRow, 1, 1, 9).getValues()[0]; 
      const lastSiswaId = lastRowData[0] || 'SIS-0'; 
      const lastUrutan = lastRowData[8] || 0;     
      
      const lastIdNum = parseInt(lastSiswaId.split('-')[1] || 0);
      const lastUrutanNum = Number(lastUrutan);
      
      nextNum = Math.max(lastIdNum, lastUrutanNum) + 1;

      const dataNisn = sheet.getRange('C2:C' + lastRow).getValues();
      dataNisn.forEach(row => {
        if(row[0]) {
          nisnSet.add(String(row[0]));
        }
      });
      
    }
    
    if (nisnSet.has(String(dataSiswa.nisn))) {
      return { status: "gagal", message: "NISN '" + dataSiswa.nisn + "' sudah terdaftar." };
    }

    const newSiswaID = "SIS-" + nextNum;
    const newUrutan = nextNum;
    
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;
    
    const newRow = [
      newSiswaID,
      dataSiswa.nama,
      formattedNisn, 
      formattedNisLokal, 
      dataSiswa.jk,
      dataSiswa.tempatLahir,
      dataSiswa.tglLahir || null, 
      dataSiswa.kelas,
      newUrutan 
    ];
    
    sheet.appendRow(newRow);
    
    clearSiswaCache();

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function updateSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    if (!dataSiswa.id || !dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data tidak lengkap. ID, Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == dataSiswa.id) { 
        rowToUpdate = i + 1; 
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      return { status: "gagal", message: "SiswaID '" + dataSiswa.id + "' tidak ditemukan." };
    }
    
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;

    const updatedRow = [
      dataSiswa.id, 
      dataSiswa.nama, 
      formattedNisn, 
      formattedNisLokal, 
      dataSiswa.jk, 
      dataSiswa.tempatLahir, 
      dataSiswa.tglLahir || null, 
      dataSiswa.kelas 
    ];
    
    sheet.getRange(rowToUpdate, 1, 1, updatedRow.length).setValues([updatedRow]);

    clearSiswaCache();
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function deleteSiswa(siswaID) {
  try {
    validateAndRefreshSession();
    
    if (!siswaID) {
      return { status: "gagal", message: "SiswaID tidak boleh kosong." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == siswaID) { 
        sheet.deleteRow(i + 1); 
        clearSiswaCache();
        return { status: "sukses" };
      }
    }
    
    return { status: "gagal", message: "SiswaID '" + siswaID + "' tidak ditemukan." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function deleteAllSiswa() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);

    const lastRow = sheet.getLastRow();
    
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    clearSiswaCache();
    return { status: "sukses", message: "Semua data siswa telah dihapus." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getDataSekolahSheet(ss) {
  let sheet = ss.getSheetByName('Data_Sekolah');
  if (!sheet) {
    sheet = ss.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); 
  }
  return sheet;
}

function getJenjangPilihanFromSheet(spreadsheetID) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss); 
    const jenjangPilihan = sheet.getRange('A2').getValue(); 
    return String(jenjangPilihan);
  } catch (e) {
    Logger.log(`Gagal mengambil jenjangPilihan dari sheet ${spreadsheetID}: ${e.message}`);
    return ""; 
  }
}

function getSchoolData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const namaSekolah = userProperties.getProperty('namaSekolah'); 
    const jenjangBase = userProperties.getProperty('jenjang'); 
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    const data = sheet.getRange('A2:P2').getValues()[0];
    
    const dataSekolah = {
      jenjangBase: jenjangBase,
      namaSekolah: namaSekolah.toUpperCase(), 
      jenjangPilihan: data[0],
      npsn: data[1],
      nsm: data[2],
      alamat: data[3],
      provinsi: data[4],
      kabKot: data[5],
      pilihanKabKot: data[6],
      kecamatan: data[7],
      kelDes: data[8],
      pilihanKelDes: data[9],
      kodePos: data[10],
      telepon: data[11],
      email: data[12],
      website: data[13],
      namaKepsek: data[14],
      nipKepsek: data[15]
    };
    
    return { status: "sukses", data: dataSekolah };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveSchoolData(data) {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    
    userProperties.setProperty('jenjangPilihan', data.jenjangPilihan);

    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    const dataArray = [
      data.jenjangPilihan, data.npsn, data.nsm, data.alamat, data.provinsi,
      data.kabKot, data.pilihanKabKot, data.kecamatan, data.kelDes, data.pilihanKelDes,
      data.kodePos, data.telepon, data.email, data.website, data.namaKepsek, data.nipKepsek
    ];
    
    sheet.getRange('A2:P2').setValues([dataArray]);
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getPengaturanSheet(ss) {
  let sheet = ss.getSheetByName('Pengaturan');
  if (!sheet) {
    sheet = ss.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); 
    sheet.appendRow(['Bobot_Ujian', 40]); 
    sheet.appendRow(['Jumlah_Semester', 5]);
    sheet.appendRow(['KKM', 76]); 
    SpreadsheetApp.flush();
  }
  
  try {
    const data = sheet.getRange('A1:A' + sheet.getLastRow()).getValues();
    let foundSemester = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        foundSemester = true;
      }
      if (data[i][0] === 'KKM') {
        foundKKM = true;
      }
    }
    if (!foundSemester) {
      sheet.appendRow(['Jumlah_Semester', 5]);
    }
    if (!foundKKM) { 
      sheet.appendRow(['KKM', 76]); 
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat setting: " + e.message);
  }
  
  return sheet;
}

function getBobotData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let bobotRapor = 60; 
    let bobotUjian = 40; 
    let kkm = 76; 

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Bobot_Rapor') {
        bobotRapor = data[i][1];
      } else if (data[i][0] === 'Bobot_Ujian') {
        bobotUjian = data[i][1];
      } else if (data[i][0] === 'KKM') { 
        kkm = data[i][1];
      }
    }
    
    return { status: "sukses", bobotUjian: bobotUjian, bobotRapor: bobotRapor, kkm: kkm };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveBobotData(bobotRapor, bobotUjian, kkm) { 
  try {
    validateAndRefreshSession(); 
    
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }
    
    const kkmValue = parseInt(kkm, 10);
    if (isNaN(kkmValue) || kkmValue < 0 || kkmValue > 100) {
      return { status: "gagal", message: "KKM harus angka antara 0 dan 100." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);

    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let foundRapor = false;
    let foundUjian = false;
    let foundKKM = false; 

    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1; 
      if (data[i][0] === 'Bobot_Rapor') {
        sheet.getRange('B' + rowIdx).setValue(bobotRapor);
        foundRapor = true;
      } else if (data[i][0] === 'Bobot_Ujian') {
        sheet.getRange('B' + rowIdx).setValue(bobotUjian);
        foundUjian = true;
      } else if (data[i][0] === 'KKM') { 
        sheet.getRange('B' + rowIdx).setValue(kkmValue);
        foundKKM = true;
      }
    }
    
    if (!foundRapor) {
      sheet.appendRow(['Bobot_Rapor', bobotRapor]);
    }
    if (!foundUjian) {
      sheet.appendRow(['Bobot_Ujian', bobotUjian]);
    }
    if (!foundKKM) { 
      sheet.appendRow(['KKM', kkmValue]);
    }

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getKelasSheet(ss) {
  let sheet = ss.getSheetByName('Kelas');
  if (!sheet) {
    sheet = ss.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

function getKelas() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    data.shift(); 
    
    const kelasList = data.map(row => row[0]).filter(nama => nama); 
    
    return { status: "sukses", kelas: kelasList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveKelas(kelasList) {
  try {
    validateAndRefreshSession(); 

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);

    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    if (kelasList && kelasList.length > 0) {
      const dataToSave = kelasList.map(nama => [nama]);
      
      sheet.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    }
    
    clearSiswaCache();

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getSiswaTemplateUrl() {
  let tempSpreadsheetId = null; 

  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetKelas = getKelasSheet(ss); 
    const lastRow = sheetKelas.getLastRow();
    let kelasList = [];
    
    if (lastRow > 1) {
      kelasList = sheetKelas.getRange(2, 1, lastRow - 1, 1)
                            .getValues()
                            .map(row => row[0]) 
                            .filter(k => k); 
    }
    
    if (kelasList.length === 0) {
      kelasList = ["(Belum ada kelas)", "Silakan isi di 'Kelola Kelas'"];
    }

    const tempSS = SpreadsheetApp.create("Template Import Siswa Dinamis");
    tempSpreadsheetId = tempSS.getId();

    const dataSheet = tempSS.insertSheet("Data_Kelas");
    const dataKelas2D = kelasList.map(k => [k]); 
    dataSheet.getRange(1, 1, dataKelas2D.length, 1).setValues(dataKelas2D);
    dataSheet.hideSheet(); 

    const importSheet = tempSS.getSheetByName('Sheet1');
    importSheet.setName("Import_Siswa");
    
    const headers = [
      "Nama Siswa (Wajib)", 
      "NISN (Wajib)", 
      "NIS Lokal", 
      "Jenis Kelamin (L/P) (Wajib)", 
      "Tempat Lahir", 
      "Tgl Lahir (YYYY-MM-DD)", 
      "Kelas (Wajib)" 
    ];
    importSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    importSheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");

    importSheet.getRange("B:C").setNumberFormat("@");
    importSheet.getRange("F:F").setNumberFormat("yyyy-mm-dd");

    const validationRule = SpreadsheetApp.newDataValidation()
      .requireValueInRange(dataSheet.getRange(1, 1, kelasList.length, 1))
      .setAllowInvalid(false) 
      .setHelpText("Peringatan: Anda harus memilih kelas dari daftar yang valid.") 
      .build();
    
    importSheet.getRange("G2:G1000").setDataValidation(validationRule);
    
    importSheet.autoResizeColumns(1, headers.length); 

    SpreadsheetApp.flush(); 
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    const blob = response.getBlob().setName(TEMPLATE_SISWA_FILENAME); 
    const base64Data = Utilities.base64Encode(blob.getBytes());

    return {
      status: "sukses",
      base64: base64Data,
      mimeType: TEMPLATE_SISWA_MIMETYPE, 
      fileName: TEMPLATE_SISWA_FILENAME 
    };

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) {
      DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
    }
  }
}

function prosesImportExcelSiswa(fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;

  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const sheetKelas = getKelasSheet(ss);

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();

    const conversionResource = {
      title: `[TEMP] Konversi - ${fileName}`,
      mimeType: MimeType.GOOGLE_SHEETS
    };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, {
      convert: true
    });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0]; 
    const excelData = dataSheet.getDataRange().getValues();

    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    const header = excelData.shift(); 

    const dataNisn = sheetSiswa.getRange('C2:C' + sheetSiswa.getLastRow()).getValues()
                       .map(row => String(row[0]).trim()) 
                       .filter(nisn => nisn);
    const existingNisnSet = new Set(dataNisn);

    const dataKelas = sheetKelas.getRange('A2:A' + sheetKelas.getLastRow()).getValues()
                        .map(row => String(row[0]).trim()) 
                        .filter(kelas => kelas);
    const existingKelasSet = new Set(dataKelas);

    const gagalList = [];
    const rowsToAppend = [];
    
    const existingData = sheetSiswa.getDataRange().getValues();
    let maxIdNum = 0;
    let maxUrutan = 0;
    for (let i = 1; i < existingData.length; i++) {
      const idNum = parseInt((existingData[i][0] || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      
      const urutanNum = Number(existingData[i][8] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    
    let nextNum = Math.max(maxIdNum, maxUrutan) + 1;

    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2; 

      const nama = (row[0] ? String(row[0]) : '').trim();
      const nisn = (row[1] ? String(row[1]) : '').trim();
      const nisLokal = (row[2] ? String(row[2]) : '').trim();
      const jk = (row[3] ? String(row[3]) : '').trim().toUpperCase();
      const tempatLahir = (row[4] ? String(row[4]) : '').trim();
      let tglLahir = (row[5] ? row[5] : '');
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      } else {
        tglLahir = String(tglLahir).trim();
      }
      const kelas = (row[6] ? String(row[6]) : '').trim();

      if (!nama || !nisn || !jk || !kelas) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Data wajib (Nama, NISN, JK, Kelas) tidak lengkap." });
        continue;
      }
      
      if (existingNisnSet.has(nisn)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "NISN sudah terdaftar." });
        continue;
      }

      if (jk !== 'L' && jk !== 'P') {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Jenis Kelamin harus 'L' atau 'P'." });
        continue;
      }

      if (!existingKelasSet.has(kelas)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: `Kelas '${kelas}' tidak ditemukan di Data Kelas.` });
        continue;
      }

      const newSiswaID = "SIS-" + nextNum;
      const newUrutan = nextNum;
      
      const formattedNisn = nisn ? "'" + nisn : null;
      const formattedNisLokal = nisLokal ? "'" + nisLokal : null;
      
      const newRow = [
        newSiswaID, nama, formattedNisn, formattedNisLokal, jk, 
        tempatLahir, (tglLahir || null), kelas,
        newUrutan 
      ];
      
      rowsToAppend.push(newRow);
      existingNisnSet.add(nisn);
      nextNum++; 
    }

    if (rowsToAppend.length > 0) {
      sheetSiswa.getRange(sheetSiswa.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
                .setValues(rowsToAppend);
    }

    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    clearSiswaCache();

    return { 
      status: "sukses", 
      totalDiProses: excelData.length, 
      berhasilDiUpload: rowsToAppend.length, 
      gagalDiUpload: gagalList.length, 
      dataGagal: gagalList 
    };

  } catch (e) {
    Logger.log(e);
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

function moveSiswaUrutan(siswaID, direction) {
  try {
    validateAndRefreshSession();
    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    const headers = data.shift();
    
    let targetRowIndex = -1; 
    let targetData = null;
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === siswaID) {
        targetRowIndex = i;
        targetData = {
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0)),
          sheetRow: i + 2 
        };
        break;
      }
    }
    
    if (!targetData) {
      throw new Error("SiswaID tidak ditemukan.");
    }
    
    const classmates = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i][7] === targetData.kelas) { 
        const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
        classmates.push({
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || idNum),
          sheetRow: i + 2 
        });
      }
    }
    
    classmates.sort((a, b) => a.urutan - b.urutan);
    
    let targetIndexInClass = classmates.findIndex(s => s.id === siswaID);
    let swapTarget = null;
    
    if (direction === 'up' && targetIndexInClass > 0) {
      swapTarget = classmates[targetIndexInClass - 1];
    } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
      swapTarget = classmates[targetIndexInClass + 1];
    }
    
    if (swapTarget) {
      const targetUrutanVal = targetData.urutan;
      const swapUrutanVal = swapTarget.urutan;
      
      sheet.getRange(targetData.sheetRow, 9).setValue(swapUrutanVal);
      sheet.getRange(swapTarget.sheetRow, 9).setValue(targetUrutanVal);
      
      clearSiswaCache();
      return { status: "sukses" };
    }
    
    return { status: "gagal", message: "Tidak bisa bergerak lebih jauh." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveSiswaUrutanBatch(urutanData) {
  try {
    validateAndRefreshSession();
    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    
    let changesMade = false;
    
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0]; 
      const newUrutan = urutanMap.get(id);
      
      if (newUrutan !== undefined && data[i][8] != newUrutan) { 
        data[i][8] = newUrutan; 
        changesMade = true;
      }
    }
    
    if (changesMade) {
      dataRange.setValues(data);
      clearSiswaCache();
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getNilaiUjianSheet(ss) {
  let sheet = ss.getSheetByName('Nilai_Ujian');
  if (!sheet) {
    sheet = ss.insertSheet('Nilai_Ujian');
    sheet.appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

function getNilaiUjianGridData(tipeUjian) {
  try {
    const userCache = CacheService.getUserCache();
    const cacheKey = NILAI_GRID_CACHE_KEY_PREFIX + tipeUjian;
    const cachedData = userCache.get(cacheKey);

    if (cachedData != null) {
      Logger.log("Mengambil Nilai Grid dari USER CACHE untuk: " + tipeUjian);
      return JSON.parse(cachedData);
    }
    Logger.log("Mengambil Nilai Grid dari SPREADSHEET untuk: " + tipeUjian);

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const siswaData = getSiswa(); 
    if (siswaData.status !== 'sukses') {
      throw new Error("Gagal mengambil data siswa: " + siswaData.message);
    }
    const siswaList = siswaData.siswa.map(s => ({
      id: s.id,
      nama: s.nama,
      nisn: s.nisn,
      kelas: s.kelas
    }));
    
    const mapelListFull = getMapelDataInternal(ss); 
    
    let filteredMapel = [];
    if (tipeUjian === 'UM') {
      filteredMapel = mapelListFull.filter(m => m.isUS === true);
    } else { 
      filteredMapel = mapelListFull.filter(m => m.isUP === true);
    }
    const mapelList = filteredMapel.map(m => ({ id: m.id, nama: m.nama }));
    
    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift(); 
    
    const nilaiMap = new Map();
    dataNilai.forEach(row => {
      const siswaId = row[0];
      const mapelId = row[1];
      const nilaiUM = row[2];
      const nilaiUP = row[3];
      const key = `${siswaId}_${mapelId}`;
      nilaiMap.set(key, { um: nilaiUM, up: nilaiUP });
    });
    
    const nilaiData = {};
    siswaList.forEach(siswa => {
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiMap.get(key);
        
        if (storedNilai) {
          if (tipeUjian === 'UM') {
            nilaiData[key] = storedNilai.um;
          } else {
            nilaiData[key] = storedNilai.up;
          }
        }
      });
    });

    const response = { 
      status: "sukses", 
      data: {
        siswaList: siswaList,
        mapelList: mapelList,
        nilaiData: nilaiData 
      }
    };
    
    userCache.put(cacheKey, JSON.stringify(response), 600);
    
    return response;
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiUjianBatch(dataToSave) {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getNilaiUjianSheet(ss);
    
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues(); 
    
    const dataMap = new Map();
    for (let i = 1; i < data.length; i++) { 
      const key = `${data[i][0]}_${data[i][1]}`;
      dataMap.set(key, { 
        rowIndex: i, 
        dataRow: data[i] 
      });
    }
    
    let changesMade = false;
    const rowsToAppend = []; 
    
    // PERUBAHAN: Dapatkan tipe ujian dari data pertama (semua sama dalam satu batch)
    let tipeUjianDisimpan = null; 
    
    dataToSave.forEach(item => {
      // Simpan tipe ujian jika belum ada
      if (!tipeUjianDisimpan) {
        tipeUjianDisimpan = item.tipeUjian;
      }

      const key = `${item.siswaId}_${item.mapelId}`;
      
      let nilaiClient = item.nilai;
      let nilaiBaru;

      if (nilaiClient === "" || nilaiClient === null || nilaiClient === undefined) {
          nilaiBaru = null;
      } else {
          let num = parseInt(nilaiClient, 10); 
          let numFloat = parseFloat(nilaiClient); 
          
          if (isNaN(num) || num < 0 || num > 100 || num !== numFloat) {
              nilaiBaru = null;
          } else {
              nilaiBaru = "'" + num; 
          }
      }

      const existingEntry = dataMap.get(key);
      
      if (existingEntry) {
        const rowIndex = existingEntry.rowIndex;
        if (item.tipeUjian === 'UM') {
          
          if (data[rowIndex][2] !== nilaiBaru) { 
            data[rowIndex][2] = nilaiBaru;
            changesMade = true;
          }
        } else { 
        
          if (data[rowIndex][3] !== nilaiBaru) {
            data[rowIndex][3] = nilaiBaru;
            changesMade = true;
          }
        }
      } else {
        let newRow = [item.siswaId, item.mapelId, null, null];
        if (item.tipeUjian === 'UM') {
          newRow[2] = nilaiBaru;
        } else {
          newRow[3] = nilaiBaru;
        }
        rowsToAppend.push(newRow);
        
        dataMap.set(key, {}); 
      }
    });
    
    if (changesMade) {
      dataRange.setValues(data);
    }
    
    if (rowsToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 4)
           .setValues(rowsToAppend);
    }
    
    // --- PERUBAHAN DIMULAI DI SINI ---
    // clearNilaiUjianCache(); // <-- Ganti baris ini

    // Menjadi logika yang lebih cerdas:
    if (tipeUjianDisimpan) {
      const userCache = CacheService.getUserCache();
      const cacheKey = NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan;
      userCache.remove(cacheKey);
      Logger.log("Membersihkan cache grid spesifik untuk: " + cacheKey);
    } else {
      // Fallback jika tidak ada data (seharusnya tidak terjadi)
      clearNilaiUjianCache();
      Logger.log("PERINGATAN: Menghapus semua cache ujian (fallback).");
    }
    
    // Rekap tetap harus dihapus karena datanya berubah
    clearRekapNilaiCache();
    // --- PERUBAHAN SELESAI ---
    
    return { status: "sukses", message: "Data nilai berhasil disimpan!" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getNilaiTemplateData(kelasDipilih) {
  let tempSpreadsheetId = null; 

  try {
    const userProperties = validateAndRefreshSession();
    const namaSekolah = userProperties.getProperty('namaSekolah');

    const siswaResponse = getSiswa();
    if (siswaResponse.status !== 'sukses') {
      throw new Error(siswaResponse.message);
    }
    
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua')
      ? siswaList
      : siswaList.filter(s => s.kelas === kelasDipilih);

    if (filteredSiswa.length === 0) {
      return { status: "gagal", message: `Tidak ada siswa yang ditemukan untuk kelas '${kelasDipilih}'.` };
    }
    
    const mapelResponse = getMapel();
    if (mapelResponse.status !== 'sukses') {
      throw new Error(mapelResponse.message);
    }
    
    const mapelUS = mapelResponse.mapel.filter(m => m.isUS === true);
    const mapelUP = mapelResponse.mapel.filter(m => m.isUP === true);

    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Nilai - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();

    const rule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(0, 100)
      .setAllowInvalid(true) 
      .setHelpText("Nilai harus angka antara 0 dan 100.")
      .build();

    const sheetUS = ss.getSheetByName('Sheet1'); 
    const jenjangPilihan = userProperties.getProperty('jenjangPilihan');
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    sheetUS.setName(namaSheetUS);

    sheetUS.getRange("B:B").setNumberFormat("@");

    if (mapelUS.length > 0) {
      const headersUS = ["Nama Siswa", "NISN", "Kelas", ...mapelUS.map(m => m.id)];
      sheetUS.getRange(1, 1, 1, headersUS.length).setValues([headersUS]);
      
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUS.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      
      const nilaiRangeUS = sheetUS.getRange(2, 4, dataSiswaRows.length, mapelUS.length);
      nilaiRangeUS.setDataValidation(rule);
      
      sheetUS.autoResizeColumns(1, 3); 
    } else {
      sheetUS.getRange('A1').setValue(`Tidak ada mapel yang ditandai untuk ${namaSheetUS}.`);
    }

    const sheetUP = ss.insertSheet('Ujian Praktek');

    sheetUP.getRange("B:B").setNumberFormat("@");
    
    if (mapelUP.length > 0) {
      const headersUP = ["Nama Siswa", "NISN", "Kelas", ...mapelUP.map(m => m.id)];
      sheetUP.getRange(1, 1, 1, headersUP.length).setValues([headersUP]);
      
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      
      const nilaiRangeUP = sheetUP.getRange(2, 4, dataSiswaRows.length, mapelUP.length);
      nilaiRangeUP.setDataValidation(rule);
      
      sheetUP.autoResizeColumns(1, 3);
    } else {
      sheetUP.getRange('A1').setValue('Tidak ada mapel yang ditandai untuk Ujian Praktek.');
    }

    SpreadsheetApp.flush(); 
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    const blob = response.getBlob().setName("template_nilai_ujian.xlsx");
    const base64Data = Utilities.base64Encode(blob.getBytes());

    return {
      status: "sukses",
      base64: base64Data,
      mimeType: MimeType.MICROSOFT_EXCEL,
      fileName: "template_nilai_ujian.xlsx"
    };

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) {
      DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
    }
  }
}

function prosesUploadExcelNilai(fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;

  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);

    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift(); 
    const nisnToSiswaIdMap = new Map(dataSiswa.map(row => [String(row[2]), row[0]])); 
    
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0])); 

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();

    const conversionResource = { title: `[TEMP] Upload Nilai - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);

    const gagalList = [];
    const dataToSave = []; 
    let totalDitemukan = 0;
    
    const jenjangPilihan = userProperties.getProperty('jenjangPilihan');
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    
    const sheetsToProcess = [
      { name: namaSheetUS, type: 'UM' },
      { name: 'Ujian Praktek', type: 'Praktek' }
    ];

    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet dengan nama ini tidak ada di file.' });
        return; 
      }
      
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return; 
      
      const header = data.shift(); 
      const mapelHeaders = header.slice(3); 

      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2; 
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim(); 
        
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: `NISN '${nisn}' tidak terdaftar di database.` });
          return; 
        }
        
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim(); 
          const nilai = row[mapelIndex + 3]; 
          
          if (nilai === null || nilai === "") {
            return; 
          }
          
          totalDitemukan++; 
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' di header tidak dikenal.` });
            return; 
          }
          
          const numNilaiFloat = parseFloat(nilai);
          const numNilaiInt = parseInt(nilai, 10);

          if (isNaN(numNilaiFloat)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' bukan angka.` });
            return; 
          }
          
          if (numNilaiFloat !== numNilaiInt) { 
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak boleh desimal (berkoma).` });
            return; 
          }
          
          if (numNilaiInt < 0 || numNilaiInt > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${numNilaiInt}' diluar rentang (0-100).` });
            return; 
          }

          dataToSave.push({
            siswaId: siswaId,
            mapelId: mapelId,
            tipeUjian: sheetInfo.type,
            nilai: numNilaiInt 
          });
        });
      });
    });
    
    if (dataToSave.length > 0) {
      const saveResult = saveNilaiUjianBatch(dataToSave); 
      if (saveResult.status !== 'sukses') {
        throw new Error("Gagal menyimpan data batch: " + saveResult.message);
      }
    }
    
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);

    clearNilaiUjianCache();

    return { 
      status: "sukses", 
      totalDitemukan: totalDitemukan, 
      berhasilDiUpload: dataToSave.length, 
      gagalDiUpload: gagalList.length, 
      dataGagal: gagalList 
    };

  } catch (e) {
    Logger.log(e);
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

function hitungNilaiRekap(nilaiUM, nilaiUP) {
  const um = (nilaiUM === null || nilaiUM === undefined || nilaiUM === "") ? null : parseFloat(nilaiUM);
  const up = (nilaiUP === null || nilaiUP === undefined || nilaiUP === "") ? null : parseFloat(nilaiUP);
  
  const umIsValid = (um !== null && !isNaN(um));
  const upIsValid = (up !== null && !isNaN(up));
  
  if (umIsValid && upIsValid) {
    return (um + up) / 2;
  } else if (umIsValid) {
    return um;
  } else if (upIsValid) {
    return up;
  } else {
    return null;
  }
}

function getRekapitulasiNilaiData() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedData = userCache.get(REKAP_NILAI_CACHE_KEY);

    if (cachedData != null) {
      Logger.log("Mengambil Rekap Nilai dari USER CACHE");
      return JSON.parse(cachedData);
    }
    Logger.log("Mengambil Rekap Nilai dari SPREADSHEET");

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const siswaData = getSiswa(); 
    if (siswaData.status !== 'sukses') {
      throw new Error("Gagal mengambil data siswa: " + siswaData.message);
    }
    const siswaList = siswaData.siswa.map(s => ({
      id: s.id,
      nama: s.nama,
      nisn: s.nisn,
      kelas: s.kelas
    }));
    
    const mapelListFull = getMapelDataInternal(ss); 
    
    const { mapelList, nilaiRekapMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => {
      nilaiRekapDataObj[key] = value;
    });

    const response = { 
      status: "sukses", 
      data: {
        siswaList: siswaList,
        mapelList: mapelList, 
        nilaiRekapData: nilaiRekapDataObj 
      }
    };
    
    userCache.put(REKAP_NILAI_CACHE_KEY, JSON.stringify(response), 600);

    return response;
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getRekapitulasiNilaiRaporData() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedData = userCache.get(REKAP_NILAI_RAPOR_CACHE_KEY);

    if (cachedData != null) {
      Logger.log("Mengambil Rekap Nilai Rapor dari USER CACHE");
      return JSON.parse(cachedData);
    }
    Logger.log("Mengambil Rekap Nilai Rapor dari SPREADSHEET");

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const semesterListData = getSemesterList();
    if (semesterListData.status !== 'sukses') {
      throw new Error("Gagal mengambil daftar semester: " + semesterListData.message);
    }
    const semesterIds = semesterListData.semesterList.map(s => s.id);
    const semesterCount = semesterIds.length;

    const siswaData = getSiswa(); 
    if (siswaData.status !== 'sukses') {
      throw new Error("Gagal mengambil data siswa: " + siswaData.message);
    }
    const siswaList = siswaData.siswa.map(s => ({
      id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas
    }));
    
    const mapelListFull = getMapelDataInternal(ss); 
    
    const { mapelList, nilaiRekapMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);
    
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => {
      nilaiRekapDataObj[key] = value;
    });

    const response = { 
      status: "sukses", 
      data: {
        siswaList: siswaList,
        mapelList: mapelList,
        nilaiRekapData: nilaiRekapDataObj,
        jumlahSemester: semesterCount
      }
    };
    
    userCache.put(REKAP_NILAI_RAPOR_CACHE_KEY, JSON.stringify(response), 600);

    return response;
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getSemesterSetting() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const jenjang = userProperties.getProperty('jenjang'); 
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss); 
    
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let jumlahSemester = 5; 

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = data[i][1];
        break;
      }
    }
    
    return { status: "sukses", jenjang: jenjang, setting: jumlahSemester };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveSemesterSetting(jumlahSemester) {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const jenjang = userProperties.getProperty('jenjang');
    
    const settingAngka = parseInt(jumlahSemester, 10);
    if (settingAngka !== 3 && settingAngka !== 5) {
      return { status: "gagal", message: "Nilai tidak valid. Hanya 3 atau 5 yang diizinkan." };
    }
    
    if (jenjang !== 'SD/MI' && settingAngka === 3) {
      return { status: "gagal", message: "Pilihan 3 semester hanya untuk jenjang SD/MI." };
    }

    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);

    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let found = false;

    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1;
      if (data[i][0] === 'Jumlah_Semester') {
        sheet.getRange('B' + rowIdx).setValue(settingAngka);
        found = true;
        break;
      }
    }
    
    if (!found) {
      sheet.appendRow(['Jumlah_Semester', settingAngka]);
    }

    clearNilaiRaporCache();

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporSheet(ss) {
  let sheet = ss.getSheetByName('Nilai_Rapor_Akhir');
  if (!sheet) {
    sheet = ss.insertSheet('Nilai_Rapor_Akhir');
    // --- PERUBAHAN SKEMA ---
    sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    SpreadsheetApp.flush();
  } else {
    // --- Logika Migrasi (jika header lama ditemukan) ---
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const nilaiIndex = headers.indexOf('Nilai');
    const nilaiPIndex = headers.indexOf('Nilai_P');
    
    if (nilaiIndex !== -1 && nilaiPIndex === -1) {
      // Jika kolom 'Nilai' ada, dan 'Nilai_P' tidak ada
      // Asumsikan 'Nilai' adalah 'Nilai_P' dan tambahkan 'Nilai_K'
      sheet.getRange(1, nilaiIndex + 1).setValue('Nilai_P');
      sheet.getRange(1, headers.length + 1).setValue('Nilai_K');
      Logger.log("Migrasi skema Nilai_Rapor_Akhir: Menambahkan Nilai_P dan Nilai_K.");
    } else if (nilaiPIndex === -1) {
      // Fallback jika sheet kosong tapi header salah
       sheet.clear();
       sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    }
  }
  return sheet;
}

function getSemesterList() {
  try {
    const userProperties = validateAndRefreshSession();
    const jenjang = userProperties.getProperty('jenjang');
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSetting = getPengaturanSheet(ss);
    
    const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let jumlahSemester = 5; 
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = parseInt(data[i][1], 10) || 5;
        break;
      }
    }

    let semesterList = [];
    
    if (jenjang === 'SD/MI') {
      if (jumlahSemester === 3) {
        semesterList = [
          { id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" },
          { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" },
          { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }
        ];
      } else {
        semesterList = [
          { id: "K4_S1", nama: "Kelas 4 Ganjil", color: "#fd7e14" },
          { id: "K4_S2", nama: "Kelas 4 Genap", color: "#fd7e14" },
          { id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" },
          { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" },
          { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }
        ];
      }
    } else if (jenjang === 'SMP/MTS') {
        semesterList = [
          { id: "K7_S1", nama: "Kelas 7 Ganjil", color: "#fd7e14" },
          { id: "K7_S2", nama: "Kelas 7 Genap", color: "#fd7e14" },
          { id: "K8_S1", nama: "Kelas 8 Ganjil", color: "#0d6efd" },
          { id: "K8_S2", nama: "Kelas 8 Genap", color: "#0d6efd" },
          { id: "K9_S1", nama: "Kelas 9 Ganjil", color: "#198754" }
        ];
    } else if (jenjang === 'SMA/MA') {
        semesterList = [
          { id: "K10_S1", nama: "Kelas 10 Ganjil", color: "#fd7e14" },
          { id: "K10_S2", nama: "Kelas 10 Genap", color: "#fd7e14" },
          { id: "K11_S1", nama: "Kelas 11 Ganjil", color: "#0d6efd" },
          { id: "K11_S2", nama: "Kelas 11 Genap", color: "#0d6efd" },
          { id: "K12_S1", nama: "Kelas 12 Ganjil", color: "#198754" }
        ];
    }

    return { status: "sukses", semesterList: semesterList };

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporGridData(semesterId) {
  try {
    Logger.log("Mengambil Nilai Rapor Grid dari SPREADSHEET untuk: " + semesterId);

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const siswaData = getSiswa(); 
    if (siswaData.status !== 'sukses') {
      throw new Error("Gagal mengambil data siswa: " + siswaData.message);
    }
    const siswaList = siswaData.siswa.map(s => ({
      id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas
    }));
    
    const mapelListFull = getMapelDataInternal(ss); 
    
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);

    const mapelList = filteredMapelList.map(m => ({ id: m.id, nama: m.nama })); 
    
    const sheetNilai = getNilaiRaporSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift(); 
    
    const nilaiMapP = new Map();
    const nilaiMapK = new Map();
    const nilaiMapRekap = new Map();

    dataNilai.forEach(row => {
      const siswaId = row[0];
      const mapelId = row[1];
      const semId = row[2];
      const nilaiP = row[3]; 
      const nilaiK = row[4]; 
      
      if (semId === semesterId) {
        const key = `${siswaId}_${mapelId}`;
        
        if (nilaiP !== undefined && nilaiP !== null && nilaiP !== "") {
          nilaiMapP.set(key, nilaiP);
        }
        
        if (nilaiK !== undefined && nilaiK !== null && nilaiK !== "") {
          nilaiMapK.set(key, nilaiK);
        }

        const p = (nilaiP === null || nilaiP === "") ? null : parseFloat(nilaiP);
        const k = (nilaiK === null || nilaiK === "") ? null : parseFloat(nilaiK);
        const pIsValid = (p !== null && !isNaN(p));
        const kIsValid = (k !== null && !isNaN(k));
        let rekapVal = null;

        if (pIsValid && kIsValid) {
          rekapVal = (p + k) / 2;
        } else if (pIsValid) {
          rekapVal = p;
        } else if (kIsValid) {
          rekapVal = k;
        }
        
        if (rekapVal !== null) {
          nilaiMapRekap.set(key, Math.round(rekapVal));
        }
      }
    });
    
    const nilaiDataP = {};
    const nilaiDataK = {};
    const nilaiDataRekap = {};

    siswaList.forEach(siswa => {
      mapelList.forEach(mapel => { 
        const key = `${siswa.id}_${mapel.id}`;
        
        const pVal = nilaiMapP.get(key);
        if (pVal !== undefined) nilaiDataP[key] = pVal;

        const kVal = nilaiMapK.get(key);
        if (kVal !== undefined) nilaiDataK[key] = kVal;

        const rVal = nilaiMapRekap.get(key);
        if (rVal !== undefined) nilaiDataRekap[key] = rVal;
      });
    });

    const semesterListData = getSemesterList();
    let namaSemester = semesterId;
    if (semesterListData.status === 'sukses') {
      const sem = semesterListData.semesterList.find(s => s.id === semesterId);
      if (sem) namaSemester = sem.nama;
    }

    const response = { 
      status: "sukses", 
      namaSemester: namaSemester,
      dataP: {
        siswaList: siswaList, mapelList: mapelList, nilaiData: nilaiDataP 
      },
      dataK: {
        siswaList: siswaList, mapelList: mapelList, nilaiData: nilaiDataK
      },
      dataRekap: {
        siswaList: siswaList, mapelList: mapelList, nilaiRekapData: nilaiDataRekap
      }
    };
    
    return response;
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiRaporBatch(dataToSave, tipeNilai) {
  try {
    if (!tipeNilai || (tipeNilai !== 'P' && tipeNilai !== 'K')) {
      return { status: "gagal", message: "Tipe nilai (P/K) tidak valid." };
    }

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getNilaiRaporSheet(ss);
    
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues(); 
    
    // Kolom 3 = Nilai_P, Kolom 4 = Nilai_K (index 3 dan 4)
    const kolomIndex = (tipeNilai === 'P') ? 3 : 4; 
    
    const dataMap = new Map();
    for (let i = 1; i < data.length; i++) { 
      const key = `${data[i][0]}_${data[i][1]}_${data[i][2]}`; 
      dataMap.set(key, { rowIndex: i });
    }
    
    let changesMade = false;
    const rowsToAppend = []; 
    
    dataToSave.forEach(item => {
      if (!item.semesterId) return; 

      const key = `${item.siswaId}_${item.mapelId}_${item.semesterId}`;
      let nilaiBaru = (item.nilai === "" || item.nilai === null || item.nilai === undefined) ? null : "'" + item.nilai;
      
      // Validasi tambahan
      if (nilaiBaru !== null) {
        let num = parseInt(item.nilai, 10);
        if (isNaN(num) || num < 0 || num > 100) {
          nilaiBaru = null; // Abaikan nilai tidak valid
        }
      }

      const existingEntry = dataMap.get(key);
      
      if (existingEntry) {
        const rowIndex = existingEntry.rowIndex;
        // Cek data[rowIndex][kolomIndex]
        if (data[rowIndex][kolomIndex] != nilaiBaru) { // Perbandingan nilai
          data[rowIndex][kolomIndex] = nilaiBaru;
          changesMade = true;
        }
      } else {
        let newRow = [item.siswaId, item.mapelId, item.semesterId, null, null];
        newRow[kolomIndex] = nilaiBaru;
        rowsToAppend.push(newRow);
        dataMap.set(key, {}); // Tandai sudah ada untuk batch ini
      }
    });
    
    if (changesMade) {
      dataRange.setValues(data);
    }
    
    if (rowsToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 5) // 5 kolom
           .setValues(rowsToAppend);
    }
    
    // Hapus cache
    const userCache = CacheService.getUserCache();
    const semesterIdsToClear = new Set(dataToSave.map(item => item.semesterId));
    semesterIdsToClear.forEach(semId => {
      if (semId) {
        userCache.remove(NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semId);
        Logger.log("Membersihkan cache grid rapor untuk: " + semId);
      }
    });
    
    clearRekapNilaiRaporCache();
    
    return { status: "sukses", message: "Data nilai rapor berhasil disimpan!" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * FUNGSI MIGRASI SATU KALI.
 * Jalankan ini secara manual dari editor Apps Script.
 * Ini akan mengubah semua password plain text di Sheet_Sekolah menjadi hash.
 */
function MIGRASI_PasswordLama() {
  Logger.log("Memulai migrasi password...");
  
  let masterSS;
  let sheetSekolah;
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      Logger.log("Sheet_Sekolah tidak ditemukan. Migrasi dibatalkan.");
      return;
    }
    
    const range = sheetSekolah.getDataRange();
    const values = range.getValues();
    let migratedCount = 0;
    
    // Mulai dari i = 1 untuk melewati header
    for (let i = 1; i < values.length; i++) {
      const plainPass = values[i][4]; // Kolom E
      const salt = values[i][6];      // Kolom G
      
      // Jika 'salt' KOSONG dan 'plainPass' ADA ISINYA, maka itu akun lama
      if (!salt && plainPass) {
        const newSalt = generateSalt();
        const newHash = hashPassword(plainPass, newSalt);
        
        // Update HashedPassword (Kolom E)
        sheetSekolah.getRange(i + 1, 5).setValue(newHash);
        // Update Salt (Kolom G)
        sheetSekolah.getRange(i + 1, 7).setValue(newSalt);
        
        migratedCount++;
        Logger.log(`Password untuk baris ${i+1} (Email: ${values[i][3]}) telah di-hash.`);
      }
    }
    
    if (migratedCount > 0) {
      // Bersihkan cache agar data baru dibaca
      clearMasterSheetCache();
      Logger.log(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan. Cache dibersihkan.`);
      SpreadsheetApp.flush();
      Browser.msgBox(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan.`);
    } else {
      Logger.log("Migrasi Selesai. Tidak ada password plain text yang ditemukan untuk dimigrasi.");
      Browser.msgBox("Migrasi Selesai. Tidak ada password lama yang ditemukan.");
    }
    
  } catch (e) {
    Logger.log("Gagal total saat migrasi: " + e.message);
    Browser.msgBox("Migrasi Gagal: " + e.message);
  }
}

function getNilaiRaporTemplateData(semesterId, kelasDipilih) {
  let tempSpreadsheetId = null; 

  try {
    const userProperties = validateAndRefreshSession();
    const namaSekolah = userProperties.getProperty('namaSekolah');

    const siswaResponse = getSiswa();
    if (siswaResponse.status !== 'sukses') {
      throw new Error(siswaResponse.message);
    }
    
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua')
      ? siswaList
      : siswaList.filter(s => s.kelas === kelasDipilih);

    if (filteredSiswa.length === 0) {
      return { status: "gagal", message: `Tidak ada siswa yang ditemukan untuk kelas '${kelasDipilih}'.` };
    }
    
    const mapelResponse = getMapel();
    if (mapelResponse.status !== 'sukses') {
      throw new Error(mapelResponse.message);
    }
    
    const mapelList = mapelResponse.mapel;
    if (mapelList.length === 0) {
      return { status: "gagal", message: "Tidak ada mata pelajaran di database." };
    }

    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Rapor - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();

    const rule = SpreadsheetApp.newDataValidation()
      .requireNumberBetween(0, 100)
      .setAllowInvalid(true) 
      .setHelpText("Nilai harus angka antara 0 dan 100.")
      .build();
    
    const mapelHeaders = mapelList.map(m => m.id);
    const headers = ["Nama Siswa", "NISN", "Kelas", ...mapelHeaders];
    const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);

    const sheetP = ss.getSheetByName('Sheet1'); 
    sheetP.setName("Pengetahuan");
    sheetP.getRange("B:B").setNumberFormat("@");
    sheetP.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) {
      const nilaiRangeP = sheetP.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length);
      nilaiRangeP.setDataValidation(rule);
    }
    sheetP.autoResizeColumns(1, 3);

    const sheetK = ss.insertSheet('Keterampilan');
    sheetK.getRange("B:B").setNumberFormat("@");
    sheetK.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetK.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) {
      const nilaiRangeK = sheetK.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length);
      nilaiRangeK.setDataValidation(rule);
    }
    sheetK.autoResizeColumns(1, 3);
    
    const metadataSheet = ss.insertSheet('Metadata');
    metadataSheet.appendRow(['SemesterID', semesterId]);
    metadataSheet.appendRow(['Kelas', kelasDipilih]);
    metadataSheet.hideSheet();

    SpreadsheetApp.flush(); 
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    const fileNameOutput = `template_rapor_${semesterId}_${kelasDipilih}.xlsx`;
    const blob = response.getBlob().setName(fileNameOutput);
    const base64Data = Utilities.base64Encode(blob.getBytes());

    return {
      status: "sukses",
      base64: base64Data,
      mimeType: MimeType.MICROSOFT_EXCEL,
      fileName: fileNameOutput
    };

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) {
      DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
    }
  }
}

function prosesUploadExcelNilaiRapor(fileData, semesterIdFromModal) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;

  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();

    const conversionResource = { title: `[TEMP] Upload Rapor - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    
    const metadataSheet = tempSheet.getSheetByName('Metadata');
    if (!metadataSheet) {
      throw new Error("File template tidak valid. Sheet 'Metadata' tidak ditemukan.");
    }
    
    const templateSemesterId = metadataSheet.getRange('B1').getValue();
    const templateKelas = metadataSheet.getRange('B2').getValue();
    
    if (templateSemesterId !== semesterIdFromModal) {
      throw new Error(`File ini adalah untuk semester ${templateSemesterId}, tetapi Anda mencoba mengupload ke ${semesterIdFromModal}. Upload dibatalkan.`);
    }

    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift(); 
    
    const nisnToSiswaIdMap = new Map();
    dataSiswa.forEach(row => {
      const siswaKelas = row[7];
      if (templateKelas === 'semua' || siswaKelas === templateKelas) {
         nisnToSiswaIdMap.set(String(row[2]), row[0]);
      }
    });
    
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0])); 

    const gagalList = [];
    const dataToSaveP = []; 
    const dataToSaveK = [];
    let totalDitemukan = 0;
    
    const sheetsToProcess = [
      { name: "Pengetahuan", type: 'P', dataArray: dataToSaveP },
      { name: 'Keterampilan', type: 'K', dataArray: dataToSaveK }
    ];

    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet dengan nama ini tidak ada di file.' });
        return; 
      }
      
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return; 
      
      const header = data.shift(); 
      const mapelHeaders = header.slice(3); 

      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2; 
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim(); 
        const kelasSiswa = String(row[2]).trim();
        
        const siswaId = nisnToSiswaIdMap.get(nisn);
        
        if (templateKelas !== 'semua' && kelasSiswa !== templateKelas) {
           gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa}`, alasan: `Siswa tidak ada di kelas ${templateKelas}.` });
           return;
        }
        
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: `NISN '${nisn}' tidak terdaftar di database (atau tidak ada di kelas ${templateKelas}).` });
          return; 
        }
        
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim(); 
          const nilai = row[mapelIndex + 3]; 
          
          if (nilai === null || nilai === "") {
            return; 
          }
          
          totalDitemukan++; 
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' di header tidak dikenal.` });
            return; 
          }
          
          const numNilaiFloat = parseFloat(nilai);
          const numNilaiInt = parseInt(nilai, 10);

          if (isNaN(numNilaiFloat)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' bukan angka.` });
            return; 
          }
          
          if (numNilaiFloat !== numNilaiInt) { 
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak boleh desimal (berkoma).` });
            return; 
          }
          
          if (numNilaiInt < 0 || numNilaiInt > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${numNilaiInt}' diluar rentang (0-100).` });
            return; 
          }

          sheetInfo.dataArray.push({
            siswaId: siswaId,
            mapelId: mapelId,
            semesterId: templateSemesterId,
            nilai: numNilaiInt 
          });
        });
      });
    });
    
    let totalBerhasil = 0;
    
    if (dataToSaveP.length > 0) {
      const saveResultP = saveNilaiRaporBatch(dataToSaveP, 'P'); 
      if (saveResultP.status !== 'sukses') {
        throw new Error("Gagal menyimpan data Pengetahuan: " + saveResultP.message);
      }
      totalBerhasil += dataToSaveP.length;
    }
    
    if (dataToSaveK.length > 0) {
      const saveResultK = saveNilaiRaporBatch(dataToSaveK, 'K');
      if (saveResultK.status !== 'sukses') {
        throw new Error("Gagal menyimpan data Keterampilan: " + saveResultK.message);
      }
      totalBerhasil += dataToSaveK.length;
    }
    
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);

    clearNilaiRaporCache();

    return { 
      status: "sukses", 
      totalDitemukan: totalDitemukan, 
      berhasilDiUpload: totalBerhasil, 
      gagalDiUpload: gagalList.length, 
      dataGagal: gagalList 
    };

  } catch (e) {
    Logger.log(e);
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

function getMapelDataInternal(ss) {
  const sheetMapel = ss.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  const data = sheetMapel.getDataRange().getValues();
  const headers = data.shift(); 
  
  const mapel = data.map(row => ({ 
                          id: row[0], 
                          nama: row[1],
                          isUS: row[2] || false, 
                          isUP: row[3] || false  
                        }))
                        .filter(row => row.id); 
  return mapel;
}

function getRekapUjianInternal(ss, siswaList, mapelListFull) {
  
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelFlags = new Map(filteredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift(); 
    
    const nilaiMap = new Map();
    dataNilai.forEach(row => {
      const siswaId = row[0];
      const mapelId = row[1];
      const nilaiUM = row[2];
      const nilaiUP = row[3];
      const key = `${siswaId}_${mapelId}`;
      nilaiMap.set(key, { um: nilaiUM, up: nilaiUP });
    });
    
    const nilaiRekapData = new Map();
    siswaList.forEach(siswa => {
      filteredMapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiMap.get(key);
        const flags = mapelFlags.get(mapel.id);
        
        let nilaiRekap = null;
        
        if (flags && (flags.isUS || flags.isUP)) {
          let nilaiUM_to_use = null;
          let nilaiUP_to_use = null;

          if (storedNilai) {
            nilaiUM_to_use = (flags.isUS) ? storedNilai.um : null;
            nilaiUP_to_use = (flags.isUP) ? storedNilai.up : null;
          }
          
          nilaiRekap = hitungNilaiRekap(nilaiUM_to_use, nilaiUP_to_use);
        }
        
        if (nilaiRekap !== null) {
            nilaiRekapData.set(key, Math.round(nilaiRekap));
        }
      });
    });

    return { 
      mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
      nilaiRekapMap: nilaiRekapData
    };
}

function getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds) {

  const semesterIdSet = new Set(semesterIds);
  const semesterCount = semesterIds.length;
  
  const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
  
  const sheetNilai = getNilaiRaporSheet(ss);
  const dataNilai = sheetNilai.getDataRange().getValues();
  dataNilai.shift(); 
  
  const nilaiMap = new Map();
  dataNilai.forEach(row => {
    const siswaId = row[0];
    const mapelId = row[1];
    const semId = row[2];
    const nilaiP = parseFloat(row[3]); 
    const nilaiK = parseFloat(row[4]); 
    
    if (semesterIdSet.has(semId)) {
      
      let nilaiAkhirSem = null;
      const pIsValid = !isNaN(nilaiP);
      const kIsValid = !isNaN(nilaiK);
      
      if (pIsValid && kIsValid) {
        nilaiAkhirSem = (nilaiP + nilaiK) / 2;
      } else if (pIsValid) {
        nilaiAkhirSem = nilaiP;
      } else if (kIsValid) {
        nilaiAkhirSem = nilaiK;
      }

      if (nilaiAkhirSem !== null) {
        const key = `${siswaId}_${mapelId}`;
        if (!nilaiMap.has(key)) {
          nilaiMap.set(key, []);
        }
        nilaiMap.get(key).push(nilaiAkhirSem);
      }
    }
  });
  
  const nilaiRekapData = new Map();
  siswaList.forEach(siswa => {
    filteredMapelList.forEach(mapel => { 
      const key = `${siswa.id}_${mapel.id}`;
      const nilaiArray = nilaiMap.get(key);
      
      if (nilaiArray && nilaiArray.length > 0) {
        const sum = nilaiArray.reduce((acc, val) => acc + val, 0);
        const average = sum / semesterCount; 
        
        nilaiRekapData.set(key, Math.round(average));
      } else {
        nilaiRekapData.set(key, null);
      }
    });
  });

  return {
    mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
    nilaiRekapMap: nilaiRekapData
  };
}

function getNilaiIjazahData() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedData = userCache.get(NILAI_IJAZAH_CACHE_KEY);

    if (cachedData != null) {
      Logger.log("Mengambil Nilai Ijazah dari USER CACHE");
      return JSON.parse(cachedData);
    }
    Logger.log("Mengambil Nilai Ijazah dari SPREADSHEET (Perhitungan)");

    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);

    const bobotResponse = getBobotData();
    if (bobotResponse.status !== 'sukses') {
      throw new Error("Gagal mengambil data bobot: " + bobotResponse.message);
    }
    const bobotRapor = (parseFloat(bobotResponse.bobotRapor) || 0) / 100;
    const bobotUjian = (parseFloat(bobotResponse.bobotUjian) || 0) / 100;
    const kkmValue = parseFloat(bobotResponse.kkm) || 76; 

    const siswaData = getSiswa();
    if (siswaData.status !== 'sukses') {
      throw new Error("Gagal mengambil data siswa: " + siswaData.message);
    }
    const siswaList = siswaData.siswa.map(s => ({
      id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas
    }));

    const mapelListFull = getMapelDataInternal(ss);

    const semesterListData = getSemesterList();
    if (semesterListData.status !== 'sukses') {
      throw new Error("Gagal mengambil daftar semester: " + semesterListData.message);
    }
    const semesterIds = semesterListData.semesterList.map(s => s.id);

    const { nilaiRekapMap: nilaiUjianMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    const { nilaiRekapMap: nilaiRaporMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);

    const mapelListIjazah = mapelListFull.filter(m => m.isUS === true || m.isUP === true);

    const dataUjianWeighted = {};
    const dataRaporWeighted = {};
    const dataIjazahFinal = {};

    siswaList.forEach(siswa => {
      mapelListIjazah.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        
        const nilaiUjianRaw = nilaiUjianMap.get(key) || 0;
        const nilaiRaporRaw = nilaiRaporMap.get(key) || 0;
        
        const weightedUjian = nilaiUjianRaw * bobotUjian;
        const weightedRapor = nilaiRaporRaw * bobotRapor;
        const finalIjazah = weightedUjian + weightedRapor;
        
        dataUjianWeighted[key] = weightedUjian;
        dataRaporWeighted[key] = weightedRapor;
        dataIjazahFinal[key] = finalIjazah;
      });
    });
    
    const response = {
      status: "sukses",
      data: {
        siswaList: siswaList,
        mapelList: mapelListIjazah,
        dataUjian: dataUjianWeighted,
        dataRapor: dataRaporWeighted,
        dataIjazah: dataIjazahFinal,
        kkm: kkmValue 
      }
    };

    userCache.put(NILAI_IJAZAH_CACHE_KEY, JSON.stringify(response), 600);
    return response;

  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}
