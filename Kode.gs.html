// ! ID MASTER SHEET ANDA
// ! Ini adalah sheet yang berisi daftar sekolah (Email, Password, ID Sheet mereka)
const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const MAPEL_CACHE_KEY = 'mapel_data'; 
// [BARU] ID Folder Google Drive target Anda
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

/**
 * Fungsi utama untuk menampilkan halaman web.
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

/**
 * Fungsi utility untuk menyisipkan file CSS atau JS ke dalam HTML.
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ===========================================
// FUNGSI OTENTIKASI & SESI
// ===========================================

/**
 * Memproses login pengguna.
 * [UPDATE] Mengirim nama sekolah sbg uppercase.
 */
function prosesLogin(email, password) {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      return { status: "gagal", message: "Database Master tidak dikonfigurasi. Hubungi Admin." };
    }
    const dataSekolah = sheetSekolah.getDataRange().getValues();

    for (let i = 1; i < dataSekolah.length; i++) {
      const row = dataSekolah[i];
      const dbEmail = row[3];
      const dbPassword = row[4];
      
      if (dbEmail === email && dbPassword === password) {
        
        // Buat token unik
        const token = Utilities.getUuid();
        const now = new Date().getTime(); // Stempel waktu
        const namaSekolahUpper = row[1].toUpperCase(); // [UPDATE]
        
        const userProperties = PropertiesService.getUserProperties();
        userProperties.setProperty('sessionToken', token);
        userProperties.setProperty('lastActivity', now.toString()); // Simpan sebagai string
        
        // Simpan data lain seperti biasa
        userProperties.setProperty('sekolahID', row[0]);
        userProperties.setProperty('namaSekolah', namaSekolahUpper); // [UPDATE] Simpan sbg uppercase
        userProperties.setProperty('jenjang', row[2]);
        userProperties.setProperty('spreadsheetID', row[5]);
        
        return { 
          status: "sukses", 
          namaSekolah: namaSekolahUpper, // [UPDATE] Kirim sbg uppercase
          jenjang: row[2],
          token: token // Kirim token ke klien
        };
      }
    }
    
    return { status: "gagal", message: "Email atau password salah." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * Memproses registrasi sekolah baru.
 * [UPDATE] Menyimpan nama sekolah sbg uppercase.
 */
function prosesRegistrasi(namaSekolah, jenjang, email, password) {
  let newSSID = null; // Variabel untuk menyimpan ID sheet baru jika terjadi error
  try {
    if (!namaSekolah || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    let sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    if (!sheetSekolah) {
       sheetSekolah = masterSS.insertSheet('Sheet_Sekolah');
       sheetSekolah.appendRow(['SekolahID', 'NamaSekolah', 'Jenjang', 'EmailAdmin', 'Password', 'SpreadsheetID']);
    }
    
    const dataSekolah = sheetSekolah.getDataRange().getValues();

    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][3] === email) {
        return { status: "gagal", message: "Email ini sudah terdaftar." };
      }
    }

    // --- [BLOK KODE BARU: LOGIKA FOLDER] ---
    let targetFolder;
    try {
      // Langsung ambil folder target menggunakan ID
      targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      return { status: "gagal", message: "Error: Folder target tidak ditemukan atau tidak dapat diakses. ID: " + TARGET_FOLDER_ID };
    }
    // --- [AKHIR BLOK KODE BARU] ---

    // [UPDATE] Pastikan namaSekolah adalah uppercase
    const namaSekolahUpper = namaSekolah.toUpperCase();

    // Buat Spreadsheet Baru untuk Sekolah
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); // [UPDATE]
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (manual): " + newSSID);

    // --- [BLOK KODE BARU: PINDAHKAN FILE] ---
    // Pindahkan file spreadsheet yang baru dibuat ke folder target
    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); // Tambahkan ke folder target
    DriveApp.getRootFolder().removeFile(newFile); // Hapus dari root (ini adalah operasi 'move')
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName());
    // --- [AKHIR BLOK KODE BARU] ---

    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    // [UPDATE] Menambahkan header baru untuk data siswa
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    // [BARU] Set format kolom C (NISN) dan D (NIS_Lokal) ke Teks
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    newSpreadsheet.insertSheet('Kelas')
      .appendRow(['NamaKelas']);
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    sheetMapel.appendRow(['MapelID', 'NamaMapel']); // Header

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      sheetMapel.getRange(2, 1, defaultMapel.length, 2).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Rapor')
      .appendRow([
        'SiswaID', 'MapelID', 
        'Sem1_P', 'Sem1_K', 'Sem2_P', 'Sem2_K', 
        'Sem3_P', 'Sem3_K', 'Sem4_P', 'Sem4_K', 'Sem5_P', 'Sem5_K'
      ]);

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);

    // Tambahkan sheet Data_Sekolah
    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      // Header (A1:P1)
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheetDataSekolah.appendRow([
      // Data Default (A2:P2)
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    // Set baris data (baris 2) agar formatnya Teks Biasa (@)
    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    newSpreadsheet.deleteSheet(defaultSheet);
    
    const newSekolahID = "SKL-" + (sheetSekolah.getLastRow());
    
    sheetSekolah.appendRow([
      newSekolahID, 
      namaSekolahUpper, // [UPDATE]
      jenjang, 
      email, 
      password, 
      newSSID
    ]);

    return { status: "sukses", message: "Registrasi berhasil! Anda akan diarahkan ke halaman login." };
    
  } catch (e) {
    Logger.log(e);
    // Jika terjadi error SETELAH spreadsheet dibuat, hapus spreadsheet tersebut
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

/**
 * Menghapus sesi pengguna.
 */
function prosesLogout() {
  try {
    PropertiesService.getUserProperties().deleteAllProperties();
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [PENJAGA] Memvalidasi sesi & mereset timer 3 jam.
 */
function validateAndRefreshSession() {
  const userProperties = PropertiesService.getUserProperties();
  const lastActivityStr = userProperties.getProperty('lastActivity');
  const storedToken = userProperties.getProperty('sessionToken');
  
  if (!storedToken || !lastActivityStr) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  
  const lastActivity = parseInt(lastActivityStr, 10);
  const now = new Date().getTime();
  const threeHours = 3 * 60 * 60 * 1000;
  
  if (now - lastActivity > threeHours) {
    userProperties.deleteAllProperties();
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  
  userProperties.setProperty('lastActivity', now.toString());
  return userProperties;
}

/**
 * [CHECK AWAL] Memeriksa token saat halaman dimuat.
 * [UPDATE] Mengirim nama sekolah sbg uppercase.
 */
function checkToken(tokenFromClient) {
  try {
    const userProperties = validateAndRefreshSession(); 
    const storedToken = userProperties.getProperty('sessionToken');

    if (tokenFromClient === storedToken) {
      return { 
        status: "sukses", 
        namaSekolah: userProperties.getProperty('namaSekolah').toUpperCase(), // [UPDATE]
        jenjang: userProperties.getProperty('jenjang')
      };
    } else {
      userProperties.deleteAllProperties();
      return { status: "gagal", message: "Token tidak cocok. Silakan login ulang." };
    }
    
  } catch (e) {
    // Tangkap error dari validateAndRefreshSession (mis. kedaluwarsa)
    return { status: "gagal", message: e.message };
  }
}


// [PERUBAHAN] Bagian "FUNGSI PENGOLAHAN NILAI (CONTOH)" telah dihapus


// ===========================================
// FUNGSI HELPER MAPEL DEFAULT (DINAMIS)
// ===========================================

/**
 * Mengambil daftar mapel default dari Master Sheet berdasarkan jenjang.
 */
function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; // Kembalikan array kosong jika sheet tidak ada
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); // Hapus baris header

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; // Kolom Jenjang
      const mapelID = row[1];     // Kolom MapelID
      const namaMapel = row[2];   // Kolom NamaMapel

      // Filter: jika jenjangnya cocok ATAU jenjangnya "UMUM"
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { // Pastikan data tidak kosong
          defaultMapel.push([mapelID, namaMapel]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; // Kembalikan array kosong jika terjadi error
  }
}

// ===========================================
// FUNGSI CRUD MATA PELAJARAN
// ===========================================

/**
 * [HELPER] Menghapus cache mapel agar data dimuat ulang.
 */
function clearMapelCache() {
  try {
    CacheService.getUserCache().remove(MAPEL_CACHE_KEY);
  } catch (e) {
    Logger.log("Gagal membersihkan cache mapel: " + e.message);
  }
}

function getMapelSheet() {
  // Panggil 'penjaga' di awal
  const userProperties = validateAndRefreshSession();
  const spreadsheetID = userProperties.getProperty('spreadsheetID');
  
  const ss = SpreadsheetApp.openById(spreadsheetID);
  const sheetMapel = ss.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  return sheetMapel;
}

function getMapel() {
  try {
    const userCache = CacheService.getUserCache();
    const cachedMapel = userCache.get(MAPEL_CACHE_KEY);

    if (cachedMapel != null) {
      // Data ditemukan di cache, kirim langsung (super cepat)
      Logger.log("Mengambil mapel dari CACHE");
      return { status: "sukses", mapel: JSON.parse(cachedMapel) };
    }
    
    // Data tidak ada di cache, ambil dari sheet (lambat)
    Logger.log("Mengambil mapel dari SPREADSHEET");
    const sheetMapel = getMapelSheet();
    const data = sheetMapel.getDataRange().getValues();
    data.shift(); // Hapus header
    
    const mapel = data.map(row => ({ id: row[0], nama: row[1] }))
                      .filter(row => row.id); // Filter baris kosong
    
    // Simpan ke cache untuk 10 menit (600 detik)
    userCache.put(MAPEL_CACHE_KEY, JSON.stringify(mapel), 600); 
    
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toUpperCase() === mapelID.toUpperCase()) {
        return { status: "gagal", message: "MapelID '" + mapelID + "' sudah ada." };
      }
    }
    
    sheetMapel.appendRow([mapelID, namaMapel]);
    clearMapelCache();
    return { status: "sukses" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateMapel(mapelID, namaMapel) {
  try {
    if (!mapelID || !namaMapel) {
      return { status: "gagal", message: "ID Mapel dan Nama Mapel wajib diisi." };
    }
    
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === mapelID) {
        sheetMapel.getRange(i + 1, 2).setValue(namaMapel);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteMapel(mapelID) {
  try {
    const sheetMapel = getMapelSheet(); // Otomatis memvalidasi sesi
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === mapelID) {
        sheetMapel.deleteRow(i + 1);
        clearMapelCache();
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// ===========================================
// FUNGSI KELOLA MAPEL (BULK)
// ===========================================

/**
 * [SINKRONISASI] Menambahkan mapel default yang hilang ke sheet Mapel sekolah.
 */
function syncDefaultMapel() {
  try {
    const userProperties = validateAndRefreshSession();
    const jenjang = userProperties.getProperty('jenjang');
    
    // 1. Ambil daftar mapel default dari Master Sheet
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const defaultMapelList = getDynamicDefaultMapel(jenjang, masterSS); // Array [ [ID, Nama], [ID, Nama] ]
    
    // 2. Ambil daftar mapel yang ada di sheet sekolah
    const sheetMapel = getMapelSheet(); // Ini sudah memvalidasi sesi
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift(); // Hapus header
    
    // Buat Set (untuk pencarian cepat) dari MapelID yang sudah ada
    const existingMapelIDs = new Set();
    dataMapel.forEach(row => {
      if (row[0]) {
        existingMapelIDs.add(row[0].toUpperCase()); // Simpan dalam huruf besar
      }
    });

    // 3. Filter mapel default yang BELUM ADA
    const mapelToAdd = [];
    defaultMapelList.forEach(mapel => {
      const mapelID = mapel[0];
      if (!existingMapelIDs.has(mapelID.toUpperCase())) {
        mapelToAdd.push(mapel); // Tambahkan [ID, Nama]
      }
    });
    
    // 4. Tambahkan mapel yang hilang ke sheet
    if (mapelToAdd.length > 0) {
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 2)
                .setValues(mapelToAdd);
      clearMapelCache();
      return { status: "sukses", message: `Berhasil menambahkan ${mapelToAdd.length} mapel default yang hilang.` };
    } else {
      return { status: "sukses", message: "Data mapel Anda sudah sinkron. Tidak ada yang ditambahkan." };
    }
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [HAPUS SEMUA] Menghapus semua mapel dari sheet sekolah.
 */
function deleteAllMapel() {
  try {
    const sheetMapel = getMapelSheet(); // Ini sudah memvalidasi sesi
    const lastRow = sheetMapel.getLastRow();
    
    // Hapus semua baris KECUALI baris header (baris 1)
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache();
    return { status: "sukses", message: "Semua mapel telah dihapus." };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// ===========================================
// [BARU] FUNGSI CRUD KELOLA SISWA
// ===========================================

/**
 * [HELPER] Membuka sheet Siswa, atau membuatnya jika belum ada.
 */
function getSiswaSheet(ss) {
  let sheet = ss.getSheetByName('Siswa');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  // [BARU] Set format kolom C (NISN) dan D (NIS_Lokal) ke Teks
  // Ini akan berlaku untuk sheet baru DAN sheet lama yang mungkin formatnya salah
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  return sheet;
}

/**
 * [SERVER] Mengambil daftar siswa dari sheet 'Siswa'.
 */
function getSiswa() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    const headers = data.shift(); // Ambil header
    
    const siswaList = data.map(row => {
      // Ubah baris array menjadi objek agar mudah dibaca di client
      return {
        id: row[0],
        nama: row[1],
        nisn: row[2],
        nisLokal: row[3] || '',
        jk: row[4] || '',
        tempatLahir: row[5] || '',
        tglLahir: (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : '',
        kelas: row[7] || ''
      };
    });
    
    return { status: "sukses", siswa: siswaList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menambah siswa baru ke sheet 'Siswa'.
 */
function createSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    // Validasi server-side
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    // Cek duplikat NISN (Kolom C)
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] == dataSiswa.nisn) { // Kolom NISN (index 2)
        return { status: "gagal", message: "NISN '" + dataSiswa.nisn + "' sudah terdaftar atas nama " + data[i][1] + "." };
      }
    }
    
    // Buat ID unik
    const newSiswaID = "SIS-" + (sheet.getLastRow()); // Sederhana, berdasarkan jumlah baris
    
    const newRow = [
      newSiswaID,
      dataSiswa.nama,
      dataSiswa.nisn,
      dataSiswa.nisLokal,
      dataSiswa.jk,
      dataSiswa.tempatLahir,
      dataSiswa.tglLahir || null, // Kirim null jika kosong agar format tanggal benar
      dataSiswa.kelas
    ];
    
    sheet.appendRow(newRow);

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Mengedit data siswa di sheet 'Siswa'.
 */
function updateSiswa(dataSiswa) {
  try {
    validateAndRefreshSession();
    
    // Validasi server-side
    if (!dataSiswa.id || !dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data tidak lengkap. ID, Nama, NISN, Jenis Kelamin, dan Kelas wajib diisi." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == dataSiswa.id) { // Kolom SiswaID (index 0)
        rowToUpdate = i + 1; // getRange() adalah 1-indexed
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      return { status: "gagal", message: "SiswaID '" + dataSiswa.id + "' tidak ditemukan." };
    }
    
    // Buat data baris untuk update
    const updatedRow = [
      dataSiswa.id, // Kolom A (SiswaID)
      dataSiswa.nama, // Kolom B (NamaSiswa)
      dataSiswa.nisn, // Kolom C (NISN)
      dataSiswa.nisLokal, // Kolom D
      dataSiswa.jk, // Kolom E
      dataSiswa.tempatLahir, // Kolom F
      dataSiswa.tglLahir || null, // Kolom G
      dataSiswa.kelas // Kolom H
    ];
    
    // Update 1 baris penuh (Kolom A sampai H)
    sheet.getRange(rowToUpdate, 1, 1, updatedRow.length).setValues([updatedRow]);

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menghapus satu siswa dari sheet 'Siswa'.
 */
function deleteSiswa(siswaID) {
  try {
    validateAndRefreshSession();
    
    if (!siswaID) {
      return { status: "gagal", message: "SiswaID tidak boleh kosong." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    
    // Cari dari bawah ke atas agar aman saat menghapus
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == siswaID) { // Kolom SiswaID (index 0)
        sheet.deleteRow(i + 1); // i adalah 0-indexed, deleteRow adalah 1-indexed
        return { status: "sukses" };
      }
    }
    
    return { status: "gagal", message: "SiswaID '" + siswaID + "' tidak ditemukan." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menghapus semua siswa dari sheet 'Siswa'.
 */
function deleteAllSiswa() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);

    const lastRow = sheet.getLastRow();
    
    // Hapus semua baris KECUALI baris header (baris 1)
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    return { status: "sukses", message: "Semua data siswa telah dihapus." };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA DATA SEKOLAH
// ===========================================

/**
 * [HELPER] Membuka sheet Data_Sekolah, atau membuatnya jika belum ada.
 * [UPDATE] Menambahkan format teks '@' untuk akun lama.
 */
function getDataSekolahSheet(ss) {
  let sheet = ss.getSheetByName('Data_Sekolah');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas akun lama)
    sheet = ss.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    // [BARU] Set baris data (baris 2) agar formatnya Teks Biasa (@)
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); // Pastikan sheet dibuat
  }
  return sheet;
}

/**
 * [SERVER] Mengambil data sekolah dari sheet 'Data_Sekolah'.
 * [UPDATE] Mengirim nama sekolah sbg uppercase.
 */
function getSchoolData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const namaSekolah = userProperties.getProperty('namaSekolah'); // Sudah uppercase dari login/token
    const jenjangBase = userProperties.getProperty('jenjang'); // "SD/MI", "SMP/MTS", dll.
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    const data = sheet.getRange('A2:P2').getValues()[0];
    
    // Map data dari array ke objek agar mudah dibaca di client
    const dataSekolah = {
      jenjangBase: jenjangBase,
      namaSekolah: namaSekolah.toUpperCase(), // [UPDATE] Pastikan uppercase
      jenjangPilihan: data[0],
      npsn: data[1],
      nsm: data[2],
      alamat: data[3],
      provinsi: data[4],
      kabKot: data[5],
      pilihanKabKot: data[6],
      kecamatan: data[7],
      kelDes: data[8],
      pilihanKelDes: data[9],
      kodePos: data[10],
      telepon: data[11],
      email: data[12],
      website: data[13],
      namaKepsek: data[14],
      nipKepsek: data[15]
    };
    
    return { status: "sukses", data: dataSekolah };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan data sekolah ke sheet 'Data_Sekolah'.
 * [UPDATE] Tidak perlu diubah, karena format cell sudah diatur.
 */
function saveSchoolData(data) {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    
    // Ubah objek kembali menjadi array DENGAN URUTAN YANG BENAR
    const dataArray = [
      data.jenjangPilihan, data.npsn, data.nsm, data.alamat, data.provinsi,
      data.kabKot, data.pilihanKabKot, data.kecamatan, data.kelDes, data.pilihanKelDes,
      data.kodePos, data.telepon, data.email, data.website, data.namaKepsek, data.nipKepsek
    ];
    
    // Tulis data ke baris 2
    // Karena cell A2:P2 sudah diformat sebagai Teks (@), 
    // Google Sheets tidak akan mengubah "098" menjadi 98.
    sheet.getRange('A2:P2').setValues([dataArray]);
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA BOBOT NILAI
// ===========================================

/**
 * [HELPER] Membuka sheet Pengaturan, atau membuatnya jika belum ada.
 */
function getPengaturanSheet(ss) {
  let sheet = ss.getSheetByName('Pengaturan');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); // Default
    sheet.appendRow(['Bobot_Ujian', 40]); // Default
    SpreadsheetApp.flush();
  }
  return sheet;
}

/**
 * [SERVER] Mengambil data bobot dari sheet 'Pengaturan'.
 */
function getBobotData() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let bobotRapor = 60; // Default
    let bobotUjian = 40; // Default

    // Loop untuk mencari berdasarkan nama (lebih kuat drpd B2/B3)
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Bobot_Rapor') {
        bobotRapor = data[i][1];
      } else if (data[i][0] === 'Bobot_Ujian') {
        bobotUjian = data[i][1];
      }
    }
    
    return { status: "sukses", bobotUjian: bobotUjian, bobotRapor: bobotRapor };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan data bobot ke sheet 'Pengaturan'.
 */
function saveBobotData(bobotRapor, bobotUjian) {
  try {
    validateAndRefreshSession(); // Validasi sesi
    
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);

    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let foundRapor = false;
    let foundUjian = false;

    // Loop untuk update berdasarkan nama
    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1; // Index baris (mulai dari 1)
      if (data[i][0] === 'Bobot_Rapor') {
        sheet.getRange('B' + rowIdx).setValue(bobotRapor);
        foundRapor = true;
      } else if (data[i][0] === 'Bobot_Ujian') {
        sheet.getRange('B' + rowIdx).setValue(bobotUjian);
        foundUjian = true;
      }
    }
    
    // Jika setting tidak ditemukan (mis. sheet lama), tambahkan
    if (!foundRapor) {
      sheet.appendRow(['Bobot_Rapor', bobotRapor]);
    }
    if (!foundUjian) {
      sheet.appendRow(['Bobot_Ujian', bobotUjian]);
    }

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}


// ===========================================
// FUNGSI KELOLA KELAS
// ===========================================

/**
 * [HELPER] Membuka sheet Kelas, atau membuatnya jika belum ada.
 */
function getKelasSheet(ss) {
  let sheet = ss.getSheetByName('Kelas');
  if (!sheet) {
    // Buat sheet jika tidak ada (untuk kompatibilitas)
    sheet = ss.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

/**
 * [SERVER] Mengambil daftar kelas dari sheet 'Kelas'.
 */
function getKelas() {
  try {
    const userProperties = validateAndRefreshSession();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    
    const data = sheet.getDataRange().getValues();
    data.shift(); // Hapus header
    
    // Ubah dari 2D array [[Kelas 1], [Kelas 2]] menjadi 1D array [Kelas 1, Kelas 2]
    const kelasList = data.map(row => row[0]).filter(nama => nama); // filter string kosong
    
    return { status: "sukses", kelas: kelasList };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SERVER] Menyimpan daftar kelas ke sheet 'Kelas'.
 * Ini akan menghapus semua data lama dan menggantinya dengan yang baru.
 */
function saveKelas(kelasList) {
  try {
    validateAndRefreshSession(); // Validasi sesi

    const userProperties = PropertiesService.getUserProperties();
    const spreadsheetID = userProperties.getProperty('spreadsheetID');
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);

    // 1. Hapus data lama (semua baris kecuali header)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    // 2. Tulis data baru jika ada
    if (kelasList && kelasList.length > 0) {
      // Ubah dari 1D array [Kelas 1, Kelas 2] menjadi 2D array [[Kelas 1], [Kelas 2]]
      const dataToSave = kelasList.map(nama => [nama]);
      
      // Tulis data ke sheet mulai dari baris 2, kolom 1
      sheet.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    }

    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: e.message };
  }
}
